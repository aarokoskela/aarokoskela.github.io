<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tulospalvelu</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent:      #0ea5e9;
            --fpl-color:   #7c3aed;
            --bg:          #f0f9ff;
            --card-bg:     #ffffff;
            --card-border: rgba(0,0,0,0.07);
            --muted:       #64748b;
            --text:        #0f172a;
            --bar-home:    #0ea5e9;
            --bar-away:    #ef4444;
            --sidebar-bg:  #0c4a6e;
            --panel-bg:    #e0f2fe;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', 'Segoe UI', sans-serif;
            background: #f0f9ff;
            background-image:
                radial-gradient(ellipse 80% 50% at 70% -10%, rgba(14,165,233,0.1) 0%, transparent 55%),
                radial-gradient(ellipse 50% 40% at 5% 100%, rgba(14,165,233,0.06) 0%, transparent 45%);
            background-attachment: fixed;
            color: var(--text);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        /* ‚îÄ‚îÄ Top bar ‚îÄ‚îÄ */
        .topbar {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(255,255,255,0.92);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(0,0,0,0.07);
            box-shadow: 0 1px 18px rgba(0,0,0,0.06);
            height: 52px;
            display: flex;
            align-items: center;
        }

        .topbar-inner {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 22px;
            width: 100%;
            display: flex;
            align-items: center;
        }

        .topbar-brand {
            font-weight: 800;
            font-size: 1em;
            color: var(--text);
            letter-spacing: -0.3px;
            display: flex;
            align-items: center;
            gap: 9px;
        }

        .topbar-icon { font-size: 1.15em; line-height: 1; }

        /* ‚îÄ‚îÄ League Nav ‚îÄ‚îÄ */
        .league-nav {
            position: sticky;
            top: 52px;
            z-index: 99;
            background: rgba(255,255,255,0.96);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0,0,0,0.07);
            overflow-x: auto;
            scrollbar-width: none;
        }
        .league-nav::-webkit-scrollbar { display: none; }

        .league-nav-inner {
            display: flex;
            align-items: center;
            padding: 10px 22px;
            gap: 6px;
            width: max-content;
            min-width: 100%;
        }

        .lnav-label {
            font-size: 0.58em;
            text-transform: uppercase;
            letter-spacing: 1.8px;
            color: var(--muted);
            font-weight: 700;
            padding-right: 6px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .lnav-sep {
            width: 1px;
            height: 32px;
            background: rgba(0,0,0,0.1);
            margin: 0 10px;
            flex-shrink: 0;
        }

        /* ‚îÄ‚îÄ League buttons (chip style) ‚îÄ‚îÄ */
        .league-btn {
            display: inline-flex;
            align-items: center;
            gap: 7px;
            padding: 7px 14px;
            background: rgba(0,0,0,0.04);
            border: 1.5px solid transparent;
            border-radius: 40px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.8em;
            font-weight: 600;
            color: var(--muted);
            white-space: nowrap;
            transition: all 0.2s;
            flex-shrink: 0;
            line-height: 1;
        }

        .league-btn:hover {
            background: rgba(14,165,233,0.09);
            color: var(--accent);
            border-color: rgba(14,165,233,0.2);
        }

        .league-btn.active {
            background: linear-gradient(135deg, #0c4a6e, #0ea5e9);
            color: #fff;
            border-color: transparent;
            box-shadow: 0 3px 12px rgba(14,165,233,0.35);
        }

        .lc-logo {
            width: 20px;
            height: 20px;
            object-fit: contain;
            flex-shrink: 0;
        }

        /* ‚îÄ‚îÄ League identity strip ‚îÄ‚îÄ */
        .league-identity {
            max-width: 900px;
            margin: 30px auto 0;
            padding: 0 22px;
            display: flex;
            align-items: center;
            gap: 18px;
        }

        .li-logo-wrap {
            width: 60px;
            height: 60px;
            background: #fff;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 22px rgba(0,0,0,0.1), 0 1px 4px rgba(0,0,0,0.06);
            border: 1px solid rgba(0,0,0,0.06);
            flex-shrink: 0;
        }

        .li-logo-wrap img {
            width: 42px;
            height: 42px;
            object-fit: contain;
        }

        .li-text h1 {
            font-size: 1.5em;
            font-weight: 800;
            color: var(--text);
            letter-spacing: -0.5px;
            line-height: 1.15;
        }

        .li-text p {
            font-size: 0.76em;
            color: var(--muted);
            margin-top: 4px;
            font-weight: 400;
        }

        /* ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ */
        .tabs {
            max-width: 900px;
            margin: 22px auto 0;
            padding: 0 22px;
            display: flex;
            border-bottom: 1.5px solid rgba(0,0,0,0.07);
        }

        .tab-btn {
            background: transparent;
            border: none;
            border-bottom: 2.5px solid transparent;
            margin-bottom: -1.5px;
            color: var(--muted);
            padding: 11px 20px;
            cursor: pointer;
            font-size: 0.84em;
            font-weight: 500;
            font-family: inherit;
            transition: color 0.2s, border-color 0.2s;
            white-space: nowrap;
            letter-spacing: 0.05px;
        }

        .tab-btn:hover { color: var(--text); }

        .tab-btn.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
            font-weight: 700;
        }

        /* ‚îÄ‚îÄ Container ‚îÄ‚îÄ */
        .container {
            max-width: 900px;
            margin: 24px auto;
            padding: 0 22px;
            width: 100%;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* ‚îÄ‚îÄ Loading ‚îÄ‚îÄ */
        .loading {
            text-align: center;
            padding: 72px 20px;
            color: var(--muted);
            font-size: 0.9em;
        }

        .spinner {
            width: 34px; height: 34px;
            border: 3px solid #bae6fd;
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.75s linear infinite;
            margin: 0 auto 16px;
        }

        .spinner-sm {
            width: 20px; height: 20px;
            border: 2px solid #bae6fd;
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.75s linear infinite;
            margin: 16px auto;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* ‚îÄ‚îÄ Section info / headers ‚îÄ‚îÄ */
        .section-info {
            font-size: 0.72em;
            color: var(--muted);
            text-align: center;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 500;
        }

        .matchday-header {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.7em;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--muted);
            margin: 26px 0 10px;
            font-weight: 600;
        }

        .matchday-header::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--card-border);
        }

        /* ‚îÄ‚îÄ Match card ‚îÄ‚îÄ */
        .match-card {
            background: rgba(255,255,255,0.92);
            border: 1px solid rgba(14,165,233,0.09);
            border-radius: 22px;
            padding: 20px 22px;
            margin-bottom: 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03), 0 6px 18px rgba(0,0,0,0.055);
            backdrop-filter: blur(12px);
            transition: box-shadow 0.25s, transform 0.22s, border-color 0.25s;
        }

        .match-card.has-btns { cursor: pointer; }

        .match-card.has-btns:hover {
            box-shadow: 0 4px 32px rgba(14,165,233,0.18), 0 1px 4px rgba(0,0,0,0.04);
            transform: translateY(-2px);
            border-color: rgba(14,165,233,0.28);
        }

        .match-card.panel-open {
            box-shadow: 0 4px 32px rgba(14,165,233,0.18), 0 1px 4px rgba(0,0,0,0.04);
            border-color: rgba(14,165,233,0.3);
        }

        /* ‚îÄ‚îÄ Match meta & teams ‚îÄ‚îÄ */
        .match-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.72em;
            color: var(--muted);
            margin-bottom: 14px;
            gap: 8px;
            font-weight: 500;
        }

        .match-status {
            font-size: 0.76em;
            font-weight: 700;
            padding: 3px 10px;
            border-radius: 20px;
            flex-shrink: 0;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .status-ft   { background: #dbeafe; color: #1d4ed8; }
        .status-live { background: #fee2e2; color: #dc2626; animation: pulse 1.2s infinite; }
        .status-pre  { background: #e0f2fe; color: var(--accent); border: 1px solid #bae6fd; }

        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.55} }

        .match-teams {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .team {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            gap: 8px;
            min-width: 0;
        }

        .team-logo {
            width: 60px; height: 60px;
            background: linear-gradient(145deg, #f8fcff, #e4f1fb);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.09), inset 0 1px 3px rgba(255,255,255,0.9);
            flex-shrink: 0;
            border: 1.5px solid rgba(14,165,233,0.1);
        }

        .team-logo img {
            width: 38px; height: 38px;
            object-fit: contain;
        }

        .team-name {
            font-size: 0.82em;
            font-weight: 600;
            text-align: center;
            line-height: 1.3;
            color: var(--text);
        }

        .score-block {
            flex-shrink: 0;
            text-align: center;
            min-width: 96px;
        }

        .score-pill {
            background: linear-gradient(145deg, #083756, #0c4a6e 40%, #0ea5e9);
            border-radius: 20px;
            padding: 12px 22px;
            display: inline-block;
            box-shadow: 0 6px 24px rgba(14,165,233,0.38), 0 2px 6px rgba(0,0,0,0.14), inset 0 1px 0 rgba(255,255,255,0.13);
            min-width: 90px;
        }

        .score {
            font-size: 1.95em;
            font-weight: 900;
            color: #fff;
            letter-spacing: 4px;
            line-height: 1;
            text-shadow: 0 1px 4px rgba(0,0,0,0.2);
        }

        .score-detail {
            font-size: 0.68em;
            color: rgba(255,255,255,0.6);
            margin-top: 4px;
            font-weight: 500;
        }

        .upcoming-block {
            background: rgba(14,165,233,0.07);
            border: 1.5px solid rgba(14,165,233,0.22);
            border-radius: 20px;
            padding: 12px 22px;
            display: inline-block;
            min-width: 90px;
            box-shadow: 0 2px 8px rgba(14,165,233,0.1), inset 0 1px 2px rgba(255,255,255,0.8);
        }

        .upcoming-time {
            font-size: 1.55em;
            font-weight: 800;
            color: var(--accent);
            letter-spacing: -0.5px;
        }

        .upcoming-vs {
            font-size: 0.72em;
            color: var(--muted);
            margin-top: 3px;
            font-weight: 500;
        }

        /* ‚îÄ‚îÄ Detail tab row ‚îÄ‚îÄ */
        .detail-tab-row {
            display: flex;
            gap: 4px;
            margin-bottom: 16px;
            padding: 4px;
            background: rgba(0,0,0,0.04);
            border-radius: 12px;
            width: fit-content;
        }

        .detail-tab-btn {
            background: transparent;
            border: none;
            padding: 6px 16px;
            border-radius: 9px;
            cursor: pointer;
            font-size: 0.74em;
            font-weight: 600;
            color: var(--muted);
            transition: all 0.18s;
            font-family: inherit;
            white-space: nowrap;
        }

        .detail-tab-btn:hover { background: rgba(255,255,255,0.7); color: var(--text); }

        .detail-tab-btn.active {
            background: var(--accent);
            color: #fff;
            box-shadow: 0 2px 8px rgba(14,165,233,0.35);
        }

        .detail-tab-btn.fpl-tab.active {
            background: var(--fpl-color);
            box-shadow: 0 2px 8px rgba(124,58,237,0.35);
        }

        .panel-content { display: none; }
        .panel-content.active { display: block; }

        /* ‚îÄ‚îÄ Stats panel ‚îÄ‚îÄ */
        .detail-panel {
            display: none;
            margin-top: 20px;
            padding: 18px;
            border-top: 1px solid rgba(14,165,233,0.1);
            background: rgba(240,249,255,0.7);
            backdrop-filter: blur(8px);
            border-radius: 0 0 18px 18px;
            animation: fadeDown 0.2s ease;
        }

        .detail-panel.panel-open { display: block; }

        @keyframes fadeDown {
            from { opacity: 0; transform: translateY(-4px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .details-section { margin-bottom: 22px; }
        .details-section:last-child { margin-bottom: 0; }

        .details-title {
            font-size: 0.68em;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--accent);
            margin-bottom: 12px;
            padding-bottom: 6px;
            border-bottom: 2px solid #bae6fd;
            font-weight: 700;
        }

        .details-title.fpl-title { color: var(--fpl-color); border-bottom-color: #ede9fe; }

        /* ‚îÄ‚îÄ Timeline ‚îÄ‚îÄ */
        .timeline { display: flex; flex-direction: column; gap: 2px; }

        .tl-event {
            display: grid;
            grid-template-columns: 1fr 54px 1fr;
            gap: 6px;
            align-items: center;
            font-size: 0.8em;
            padding: 5px 4px;
            border-radius: 8px;
        }

        .tl-event:hover { background: rgba(14,165,233,0.07); border-radius: 8px; }

        .tl-home, .tl-away { display: flex; flex-direction: column; gap: 1px; }
        .tl-home { text-align: right; align-items: flex-end; }
        .tl-away { text-align: left; align-items: flex-start; }

        .tl-center { display: flex; flex-direction: column; align-items: center; gap: 2px; }

        .tl-icon { font-size: 1.05em; line-height: 1; }

        .tl-min {
            font-size: 0.75em;
            color: var(--muted);
            white-space: nowrap;
            font-weight: 500;
        }

        .tl-player {
            font-weight: 600;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .tl-sub-detail {
            font-size: 0.85em;
            color: var(--muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .tl-assist { font-size: 0.83em; color: var(--muted); }

        .tl-period {
            color: var(--muted);
            font-size: 0.72em;
            text-align: center;
            padding: 8px 0 4px;
            border-top: 1px solid #f0f0f0;
            margin-top: 6px;
            grid-column: 1 / -1;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .tl-period:first-child { border-top: none; margin-top: 0; }

        .no-events {
            font-size: 0.82em;
            color: var(--muted);
            text-align: center;
            padding: 12px;
        }

        /* ‚îÄ‚îÄ Match stats bars ‚îÄ‚îÄ */
        .stats-teams {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
            margin-bottom: 14px;
            font-size: 0.78em;
            font-weight: 700;
        }

        .stats-teams .home-label { text-align: left;  color: var(--bar-home); }
        .stats-teams .away-label { text-align: right; color: var(--bar-away); }

        .stat-row {
            display: grid;
            grid-template-columns: 2.8rem 1fr 2.8rem;
            gap: 8px;
            align-items: center;
            margin: 6px 0;
            font-size: 0.8em;
        }

        .stat-val { font-weight: 700; font-size: 0.95em; }
        .stat-val.home-v { text-align: right; color: var(--bar-home); }
        .stat-val.away-v { text-align: left;  color: var(--bar-away); }

        .stat-center { display: flex; flex-direction: column; align-items: center; gap: 3px; }

        .stat-bar-track {
            width: 100%;
            height: 6px;
            display: flex;
            border-radius: 4px;
            overflow: hidden;
            background: rgba(0,0,0,0.07);
        }

        .bar-h { height: 100%; background: var(--bar-home); transition: width 0.5s ease; }
        .bar-a { height: 100%; background: var(--bar-away); transition: width 0.5s ease; }

        .stat-label { font-size: 0.76em; color: var(--muted); white-space: nowrap; font-weight: 500; }

        /* ‚îÄ‚îÄ FPL table ‚îÄ‚îÄ */
        .fpl-section { margin-bottom: 20px; }
        .fpl-section:last-child { margin-bottom: 0; }

        .fpl-team-name {
            font-size: 0.75em;
            font-weight: 700;
            color: var(--fpl-color);
            background: #f5f3ff;
            border: 1.5px solid #ddd6fe;
            padding: 4px 12px;
            border-radius: 20px;
            margin-bottom: 10px;
            display: inline-block;
            letter-spacing: 0.3px;
        }

        .fpl-table { display: flex; flex-direction: column; gap: 1px; }

        .fpl-row {
            display: grid;
            grid-template-columns: 34px 1fr 36px 26px 26px 26px 26px 26px 34px;
            gap: 4px;
            font-size: 0.76em;
            padding: 5px 4px;
            border-radius: 6px;
            align-items: center;
        }

        .fpl-row:not(.fpl-hdr):hover { background: rgba(124,58,237,0.05); }

        .fpl-hdr {
            font-size: 0.68em;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            padding-bottom: 6px;
            border-bottom: 1.5px solid #e5e7eb;
            margin-bottom: 2px;
            font-weight: 600;
        }

        .fpl-pos {
            font-size: 0.8em;
            font-weight: 700;
            text-align: center;
            padding: 2px 3px;
            border-radius: 4px;
        }

        .fpl-pos-gk  { background: #fef9c3; color: #713f12; }
        .fpl-pos-def { background: #dbeafe; color: #1e40af; }
        .fpl-pos-mid { background: #ede9fe; color: #5b21b6; }
        .fpl-pos-fwd { background: #fee2e2; color: #991b1b; }

        .fpl-name {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .fpl-name.row-starred { font-weight: 700; color: #0369a1; }

        .fpl-num { text-align: center; color: var(--muted); }
        .fpl-num.nonzero { color: var(--text); font-weight: 600; }

        .fpl-pts { text-align: center; font-weight: 800; border-radius: 4px; padding: 2px 1px; }

        .pts-high { color: #0369a1; }
        .pts-med  { color: #7c3aed; }
        .pts-low  { color: var(--muted); }

        /* ‚îÄ‚îÄ Errors ‚îÄ‚îÄ */
        .error-msg {
            text-align: center;
            padding: 56px 20px;
            color: #dc2626;
            font-size: 0.9em;
            line-height: 1.8;
        }

        .details-error {
            text-align: center;
            padding: 16px;
            color: #dc2626;
            font-size: 0.82em;
        }

        /* ‚îÄ‚îÄ Standings ‚îÄ‚îÄ */
        .standings-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }

        .standings-table th {
            text-align: center;
            padding: 11px 6px 9px;
            font-size: 0.68em;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            color: var(--muted);
            border-bottom: 1.5px solid rgba(14,165,233,0.12);
            font-weight: 700;
            background: rgba(240,249,255,0.6);
        }

        .standings-table th:nth-child(2) { text-align: left; }

        .standings-table td {
            padding: 10px 6px;
            text-align: center;
            border-bottom: 1px solid rgba(0,0,0,0.04);
        }

        .standings-table tbody tr:nth-child(even) td { background: rgba(240,249,255,0.4); }
        .standings-table td:nth-child(2) { text-align: left; }
        .standings-table tr:last-child td { border-bottom: none; }
        .standings-table tr:hover td { background: rgba(14,165,233,0.06) !important; }

        .st-rank { font-weight: 700; color: var(--muted); width: 28px; font-size: 0.9em; }

        .st-team {
            display: flex;
            align-items: center;
            gap: 9px;
            font-weight: 600;
        }

        .st-team img {
            width: 22px; height: 22px;
            object-fit: contain;
            flex-shrink: 0;
        }

        .st-pts { font-weight: 800; color: var(--accent); }
        .st-gd  { font-weight: 600; }

        .zone-bar {
            display: inline-block;
            width: 4px;
            height: 20px;
            border-radius: 3px;
            vertical-align: middle;
            margin-right: 4px;
            flex-shrink: 0;
        }

        .standings-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 14px;
            margin-top: 18px;
            font-size: 0.74em;
            color: var(--muted);
        }

        .legend-item { display: flex; align-items: center; gap: 6px; }

        .legend-dot { width: 10px; height: 10px; border-radius: 3px; flex-shrink: 0; }

        /* ‚îÄ‚îÄ Player stats tab ‚îÄ‚îÄ */
        .ps-section { margin-bottom: 22px; }
        .ps-section-title {
            font-size: 0.78em; font-weight: 700; text-transform: uppercase;
            letter-spacing: 1px; color: var(--muted); margin: 0 0 8px 4px;
        }
        .ps-player { display: block; font-weight: 600; }
        .ps-team   { display: block; font-size: 0.76em; color: var(--muted); }
        .ps-val    { font-weight: 800; color: var(--accent); min-width: 30px; }
        .ps-apps   { color: var(--muted); }

        /* ‚îÄ‚îÄ Team stats panel ‚îÄ‚îÄ */
        .st-row { cursor: pointer; }
        .st-row:hover td { background: #e0f2fe !important; }
        .st-row.st-active td { background: #bae6fd !important; }

        .team-stats-panel {
            margin-top: 12px;
            animation: fadeDown 0.2s ease;
        }

        .team-stats-header {
            display: flex;
            align-items: center;
            gap: 9px;
            font-weight: 700;
            font-size: 0.88em;
            color: var(--text);
            margin-bottom: 10px;
            padding: 0 2px;
        }

        .team-stats-header img {
            width: 22px; height: 22px;
            object-fit: contain;
            flex-shrink: 0;
        }

        .team-stat-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .team-stat-card {
            background: rgba(255,255,255,0.85);
            border-radius: 16px;
            padding: 16px 10px 13px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.07), 0 1px 3px rgba(0,0,0,0.04);
            border: 1px solid rgba(14,165,233,0.1);
            text-align: center;
            backdrop-filter: blur(8px);
        }

        .team-stat-card-label {
            font-size: 0.6em;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--muted);
            font-weight: 600;
            margin-bottom: 8px;
        }

        .team-stat-value {
            font-size: 1.7em;
            font-weight: 800;
            color: var(--accent);
            line-height: 1;
            margin-bottom: 5px;
        }

        .team-stat-name {
            font-size: 0.73em;
            font-weight: 600;
            color: var(--text);
            line-height: 1.3;
        }

        @media (max-width: 520px) {
            .team-stat-card { padding: 10px 6px; }
            .team-stat-value { font-size: 1.35em; }
            .team-stat-name { font-size: 0.65em; }
        }

        /* ‚îÄ‚îÄ Live indicator ‚îÄ‚îÄ */
        .live-banner {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(254,226,226,0.6);
            border: 1px solid rgba(252,165,165,0.5);
            border-radius: 16px;
            padding: 10px 18px;
            margin-bottom: 18px;
            font-size: 0.79em;
            color: #dc2626;
            font-weight: 600;
            backdrop-filter: blur(8px);
            box-shadow: 0 2px 8px rgba(220,38,38,0.1);
        }

        .live-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: #dc2626;
            animation: pulse 1.2s infinite;
            flex-shrink: 0;
        }

        /* ‚îÄ‚îÄ Unavailable notice ‚îÄ‚îÄ */
        .unavailable-msg {
            text-align: center;
            padding: 72px 20px;
            color: var(--muted);
            line-height: 1.8;
        }

        .unavailable-msg .um-icon { font-size: 2.8em; margin-bottom: 16px; }
        .unavailable-msg h3 { color: var(--text); margin-bottom: 8px; font-size: 1.05em; font-weight: 700; }
        .unavailable-msg p { font-size: 0.88em; max-width: 340px; margin: 0 auto; }

        /* ‚îÄ‚îÄ Mobile ‚îÄ‚îÄ */
        @media (max-width: 768px) {
            .topbar-inner { padding: 0 14px; }
            .league-nav-inner { padding: 8px 14px; }
            .league-identity { margin: 16px auto 0; padding: 0 14px; }
            .li-logo-wrap { width: 46px; height: 46px; border-radius: 14px; }
            .li-logo-wrap img { width: 32px; height: 32px; }
            .li-text h1 { font-size: 1.2em; }
            .tabs { padding: 0 8px; overflow-x: auto; scrollbar-width: none; margin-top: 14px; }
            .tabs::-webkit-scrollbar { display: none; }
            .tab-btn { padding: 10px 12px; font-size: 0.8em; }
            .container { margin: 16px auto; padding: 0 12px; }

            /* Compact match cards on mobile */
            .match-card {
                padding: 8px 12px;
                margin-bottom: 2px;
                border-radius: 14px;
            }
            .match-meta {
                font-size: 0.65em;
                margin-bottom: 5px;
            }
            .match-teams { gap: 4px; }
            .team {
                flex-direction: row;
                gap: 6px;
                align-items: center;
            }
            .match-teams .team:last-child { flex-direction: row-reverse; }
            .match-teams .team:last-child .team-name { text-align: right; }
            .team-logo { width: 32px; height: 32px; border-radius: 50%; }
            .team-logo img { width: 20px; height: 20px; }
            .team-name { font-size: 0.72em; text-align: left; }
            .score-block { min-width: 76px; }
            .score-pill { padding: 5px 10px; min-width: 68px; }
            .score { font-size: 1.3em; letter-spacing: 2px; }
            .score-detail { font-size: 0.6em; margin-top: 2px; }
            .upcoming-block { padding: 5px 10px; min-width: 68px; }
            .upcoming-time { font-size: 1.1em; }
            .upcoming-vs { font-size: 0.66em; margin-top: 1px; }
        }

        @media (max-width: 520px) {
            .li-text h1 { font-size: 1.1em; }
            .tl-event { grid-template-columns: 1fr 48px 1fr; font-size: 0.74em; }
            .fpl-row { grid-template-columns: 30px 1fr 32px 22px 22px 22px 22px 22px 30px; font-size: 0.7em; }
            /* Pitch: tighter on very small screens */
            .pitch-player { min-width: 28px; max-width: 38px; }
            .pitch-dot { width: 22px; height: 22px; font-size: 0.55em; }
            .pitch-pname { font-size: 0.47em; max-width: 34px; }
        }

        /* ‚îÄ‚îÄ Lineup Pitch ‚îÄ‚îÄ */
        .lineup-pitch { font-size: 0.88em; overflow-x: auto; }

        .pitch-team-strip {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 6px 4px;
        }

        .pitch-team-badge {
            font-size: 0.72em;
            font-weight: 700;
            padding: 3px 10px;
            border-radius: 12px;
            letter-spacing: 0.3px;
        }

        .home-badge { background: #0369a1; color: #fff; }
        .away-badge { background: #1e40af; color: #fff; }

        .pitch-fmtn {
            font-size: 0.7em;
            color: rgba(255,255,255,0.6);
            font-weight: 600;
            letter-spacing: 1px;
        }

        .pitch-field {
            background: linear-gradient(180deg, #276a35 0%, #2d7a3d 40%, #2d7a3d 60%, #276a35 100%);
            border-radius: 10px;
            overflow: visible;
            position: relative;
            padding: 10px 4px;
            min-width: min-content;
        }

        .pitch-field::before {
            content: '';
            position: absolute;
            inset: 0;
            background: repeating-linear-gradient(
                180deg,
                transparent, transparent 38px,
                rgba(0,0,0,0.05) 38px, rgba(0,0,0,0.05) 76px
            );
            pointer-events: none;
        }

        .pitch-half {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 6px 0;
        }

        .pitch-midline-wrap {
            position: relative;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 2px 0;
        }

        .pitch-midline-wrap::before {
            content: '';
            position: absolute;
            left: 0; right: 0;
            height: 1px;
            background: rgba(255,255,255,0.35);
        }

        .pitch-center-circle {
            width: 52px; height: 52px;
            border: 1.5px solid rgba(255,255,255,0.35);
            border-radius: 50%;
            position: absolute;
            background: transparent;
        }

        .pitch-row {
            display: flex;
            justify-content: space-evenly;
            align-items: flex-start;
            gap: 2px;
            padding: 2px 6px;
        }

        .pitch-player {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            min-width: 44px;
            max-width: 58px;
        }

        .pitch-dot {
            width: 30px; height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.66em;
            font-weight: 800;
            color: #fff;
            box-shadow: 0 2px 7px rgba(0,0,0,0.45);
            border: 2px solid rgba(255,255,255,0.3);
            flex-shrink: 0;
            line-height: 1;
        }

        .pitch-dot.home { background: #0369a1; }
        .pitch-dot.away { background: #2563eb; }

        .pitch-pname {
            font-size: 0.57em;
            color: #fff;
            text-align: center;
            text-shadow: 0 1px 4px rgba(0,0,0,1);
            max-width: 54px;
            line-height: 1.2;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-weight: 600;
        }

        @media (max-width: 520px) {
            .pitch-player { min-width: 34px; max-width: 46px; }
            .pitch-dot { width: 25px; height: 25px; font-size: 0.6em; }
            .pitch-pname { font-size: 0.52em; max-width: 40px; }
        }
    </style>
</head>
<body>

<!-- ‚îÄ‚îÄ Top bar ‚îÄ‚îÄ -->
<header class="topbar">
    <div class="topbar-inner">
        <span class="topbar-brand"><span class="topbar-icon">üèÜ</span>Tulospalvelu</span>
    </div>
</header>

<!-- ‚îÄ‚îÄ League nav ‚îÄ‚îÄ -->
<nav class="league-nav">
    <div class="league-nav-inner">
        <span class="lnav-label">Jalkapallo</span>
        <button class="league-btn active" data-league="pl" onclick="switchLeague('pl')">
            <img src="https://a.espncdn.com/i/leaguelogos/soccer/500/23.png" class="lc-logo" alt="">
            Premier League
        </button>
        <button class="league-btn" data-league="laliga" onclick="switchLeague('laliga')">
            <img src="https://a.espncdn.com/i/leaguelogos/soccer/500/15.png" class="lc-logo" alt="">
            La Liga
        </button>
        <button class="league-btn" data-league="bl" onclick="switchLeague('bl')">
            <img src="https://a.espncdn.com/i/leaguelogos/soccer/500/10.png" class="lc-logo" alt="">
            Bundesliga
        </button>
        <button class="league-btn" data-league="seriea" onclick="switchLeague('seriea')">
            <img src="https://a.espncdn.com/i/leaguelogos/soccer/500/12.png" class="lc-logo" alt="">
            Serie A
        </button>
        <button class="league-btn" data-league="ligue1" onclick="switchLeague('ligue1')">
            <img src="https://a.espncdn.com/i/leaguelogos/soccer/500/9.png" class="lc-logo" alt="">
            Ligue 1
        </button>
        <button class="league-btn" data-league="ucl" onclick="switchLeague('ucl')">
            <img src="https://a.espncdn.com/i/leaguelogos/soccer/500/2.png" class="lc-logo" alt="">
            Champions League
        </button>
        <div class="lnav-sep"></div>
        <span class="lnav-label">J√§√§kiekko</span>
        <button class="league-btn" data-league="nhl" onclick="switchLeague('nhl')">
            <img src="https://a.espncdn.com/i/leaguelogos/hockey/500/1.png" class="lc-logo" alt="">
            NHL
        </button>
        <button class="league-btn" data-league="liiga" onclick="switchLeague('liiga')">
            <span style="font-size:1.1em;line-height:1">üèí</span>
            Liiga
        </button>
    </div>
</nav>

<!-- ‚îÄ‚îÄ Page content ‚îÄ‚îÄ -->
<div class="page-content">

    <!-- League identity -->
    <div class="league-identity">
        <div class="li-logo-wrap">
            <img id="league-logo"
                 src="https://a.espncdn.com/i/leaguelogos/soccer/500/23.png"
                 alt="League" onerror="this.style.display='none'">
        </div>
        <div class="li-text">
            <h1 id="league-name">Premier League</h1>
            <p id="league-subtitle">Englannin Valioliiga &mdash; Ottelutulokset &amp; ohjelma</p>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <button class="tab-btn active" data-tab="results"   onclick="showTab('results',   this)">Viimeisimm√§t tulokset</button>
        <button class="tab-btn"        data-tab="upcoming"  onclick="showTab('upcoming',  this)">Tulevat ottelut</button>
        <button class="tab-btn"        data-tab="standings"   onclick="showTab('standings',   this)">Sarjataulukko</button>
        <button class="tab-btn"        data-tab="playerstats" onclick="showTab('playerstats', this)">Pelaajatilastot</button>
    </div>

    <!-- Tab content -->
    <div class="container">
        <div id="results"   class="tab-content active">
            <div class="loading"><div class="spinner"></div>Ladataan tuloksia...</div>
        </div>
        <div id="upcoming"  class="tab-content">
            <div class="loading"><div class="spinner"></div>Ladataan otteluohjelmaa...</div>
        </div>
        <div id="standings" class="tab-content">
            <div class="loading"><div class="spinner"></div>Ladataan sarjataulukkoa...</div>
        </div>
        <div id="playerstats" class="tab-content">
            <div class="loading"><div class="spinner"></div>Ladataan tilastoja...</div>
        </div>
    </div>

</div><!-- /page-content -->

<script>
'use strict';

// ‚îÄ‚îÄ League configurations ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const LEAGUES = {
    pl: {
        key:'pl', sport:'soccer', id:'eng.1',
        name:'Premier League', subtitle:'Englannin Valioliiga \u2014 Ottelutulokset & ohjelma',
        logo:'https://a.espncdn.com/i/leaguelogos/soccer/500/23.png', hasFPL: true
    },
    laliga: {
        key:'laliga', sport:'soccer', id:'esp.1',
        name:'La Liga', subtitle:'Espanjan La Liga \u2014 Ottelutulokset & ohjelma',
        logo:'https://a.espncdn.com/i/leaguelogos/soccer/500/15.png'
    },
    bl: {
        key:'bl', sport:'soccer', id:'ger.1',
        name:'Bundesliga', subtitle:'Saksan Bundesliiga \u2014 Ottelutulokset & ohjelma',
        logo:'https://a.espncdn.com/i/leaguelogos/soccer/500/10.png'
    },
    seriea: {
        key:'seriea', sport:'soccer', id:'ita.1',
        name:'Serie A', subtitle:'Italian Serie A \u2014 Ottelutulokset & ohjelma',
        logo:'https://a.espncdn.com/i/leaguelogos/soccer/500/12.png'
    },
    ligue1: {
        key:'ligue1', sport:'soccer', id:'fra.1',
        name:'Ligue 1', subtitle:'Ranskan Ligue 1 \u2014 Ottelutulokset & ohjelma',
        logo:'https://a.espncdn.com/i/leaguelogos/soccer/500/9.png'
    },
    ucl: {
        key:'ucl', sport:'soccer', id:'uefa.champions',
        name:'Champions League', subtitle:'UEFA Mestareiden liiga \u2014 Ottelutulokset & ohjelma',
        logo:'https://a.espncdn.com/i/leaguelogos/soccer/500/2.png'
    },
    nhl: {
        key:'nhl', sport:'hockey', id:'nhl',
        name:'NHL', subtitle:'National Hockey League \u2014 Ottelutulokset & ohjelma',
        logo:'https://a.espncdn.com/i/leaguelogos/hockey/500/1.png'
    },
    liiga: {
        key:'liiga', sport:'hockey', id:'liiga',
        name:'Liiga', subtitle:'Suomen SM-Liiga \u2014 Ottelutulokset & ohjelma',
        logo:'', isLiiga: true
    },
};

let currentLeagueKey = 'pl';
let currentTab = 'results';

function getLeague() { return LEAGUES[currentLeagueKey]; }

// ‚îÄ‚îÄ FPL API (CORS proxy) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const FPL_PROXY = 'https://corsproxy.io/?url=';
const FPL_BASE  = 'https://fantasy.premierleague.com/api';

async function fplFetch(path) {
    const url = FPL_BASE + path;
    const res = await fetch(FPL_PROXY + encodeURIComponent(url));
    if (!res.ok) throw new Error(`FPL HTTP ${res.status}`);
    return res.json();
}

let   fplBootstrapCache = null;
let   fplFixturesCache  = null;
const fplEventCache     = {};
const detailCache       = {};

async function getFplBootstrap() {
    if (!fplBootstrapCache) fplBootstrapCache = await fplFetch('/bootstrap-static/');
    return fplBootstrapCache;
}
async function getFplFixtures() {
    if (!fplFixturesCache) fplFixturesCache = await fplFetch('/fixtures/');
    return fplFixturesCache;
}
async function getFplEventLive(gw) {
    if (!fplEventCache[gw]) fplEventCache[gw] = await fplFetch(`/event/${gw}/live/`);
    return fplEventCache[gw];
}

// ESPN team displayName ‚Üí FPL short_name
const ESPN_TO_FPL = {
    'Arsenal':'ARS','Aston Villa':'AVL','AFC Bournemouth':'BOU','Bournemouth':'BOU',
    'Brentford':'BRE','Brighton & Hove Albion':'BHA','Brighton':'BHA',
    'Burnley':'BUR','Chelsea':'CHE','Crystal Palace':'CRY','Everton':'EVE',
    'Fulham':'FUL','Ipswich Town':'IPS','Ipswich':'IPS',
    'Leeds United':'LEE','Leeds':'LEE','Leicester City':'LEI','Leicester':'LEI',
    'Liverpool':'LIV','Manchester City':'MCI','Manchester United':'MUN',
    'Newcastle United':'NEW','Newcastle':'NEW','Nottingham Forest':'NFO',"Nott'm Forest":'NFO',
    'Southampton':'SOU','Sunderland':'SUN','Tottenham Hotspur':'TOT','Spurs':'TOT',
    'West Ham United':'WHU','West Ham':'WHU','Wolverhampton Wanderers':'WOL','Wolves':'WOL',
};
const POS_NAME = { 1:'GK', 2:'DEF', 3:'MID', 4:'FWD' };

// ‚îÄ‚îÄ API URL builders ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function scoreboardUrl(league, from, to) {
    const base = `https://site.api.espn.com/apis/site/v2/sports/${league.sport}/${league.id}/scoreboard`;
    return `${base}?dates=${toESPNDate(from)}-${toESPNDate(to)}&limit=100`;
}
function summaryUrl(league, eventId) {
    return `https://site.api.espn.com/apis/site/v2/sports/${league.sport}/${league.id}/summary?event=${eventId}`;
}
function standingsUrl(league) {
    return `https://site.api.espn.com/apis/v2/sports/${league.sport}/${league.id}/standings`;
}
function teamUrl(league, teamId) {
    return `https://site.api.espn.com/apis/site/v2/sports/${league.sport}/${league.id}/teams/${teamId}`;
}

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fmtDate(iso) {
    return new Date(iso).toLocaleDateString('fi-FI', {
        weekday:'long', day:'numeric', month:'long', year:'numeric'
    });
}
function fmtTime(iso) {
    return new Date(iso).toLocaleTimeString('fi-FI', { hour:'2-digit', minute:'2-digit' });
}
function toESPNDate(d) {
    return `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;
}

// ‚îÄ‚îÄ UI: League / Tab switching ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showTab(tab, btn) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(tab).classList.add('active');
    currentTab = tab;

    // Lazy load if still showing spinner
    const el = document.getElementById(tab);
    if (el.querySelector('.loading')) {
        const league = getLeague();
        if (!league.unavailable) loadTabContent(tab, league);
    }
}

function loadTabContent(tab, league) {
    switch (tab) {
        case 'results':     loadResults(league);     break;
        case 'upcoming':    loadUpcoming(league);    break;
        case 'standings':   loadStandings(league);   break;
        case 'playerstats': loadPlayerStats(league); break;
    }
}

function updateLeagueHeader(league) {
    document.getElementById('league-name').textContent     = league.name;
    document.getElementById('league-subtitle').textContent = league.subtitle;
    const logo = document.getElementById('league-logo');
    const wrap = logo.parentElement;
    if (league.logo) {
        logo.src = league.logo;
        logo.style.display = '';
        wrap.style.display = '';
    } else {
        wrap.style.display = 'none';
    }
}

function unavailableHTML() {
    return `<div class="unavailable-msg">
        <div class="um-icon">‚ö†Ô∏è</div>
        <h3>Tietoja ei saatavilla</h3>
        <p>SM-Liigan ottelutiedot eiv√§t ole saatavilla ESPN:n avoimesta rajapinnasta. Ominaisuus on kehitteill√§.</p>
    </div>`;
}

function switchLeague(leagueKey) {
    if (leagueKey === currentLeagueKey) return;

    stopLiveRefresh();

    document.querySelectorAll('.league-btn').forEach(b => b.classList.remove('active'));
    document.querySelector(`[data-league="${leagueKey}"]`).classList.add('active');

    currentLeagueKey = leagueKey;
    currentTab = 'results';

    const league = LEAGUES[leagueKey];
    updateLeagueHeader(league);

    // Reset tabs to Results
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelector('[data-tab="results"]').classList.add('active');
    document.getElementById('results').classList.add('active');

    const LOADING = '<div class="loading"><div class="spinner"></div>Ladataan...</div>';
    document.getElementById('results').innerHTML     = LOADING;
    document.getElementById('upcoming').innerHTML    = LOADING;
    document.getElementById('standings').innerHTML   = LOADING;
    document.getElementById('playerstats').innerHTML = LOADING;

    // Show/hide player stats tab based on sport
    const psTabBtn = document.querySelector('[data-tab="playerstats"]');
    psTabBtn.style.display = league.sport === 'soccer' ? '' : 'none';

    if (league.unavailable) {
        const msg = unavailableHTML();
        document.getElementById('results').innerHTML   = msg;
        document.getElementById('upcoming').innerHTML  = msg;
        document.getElementById('standings').innerHTML = msg;
    } else {
        loadResults(league);
        // upcoming and standings are loaded lazily when their tab is clicked
    }
}

// ‚îÄ‚îÄ Scoreboard fetch ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchMatches(league, from, to) {
    const url = scoreboardUrl(league, from, to);
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return (await res.json()).events || [];
}

// ‚îÄ‚îÄ Timeline ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SOCCER_ICONS = {
    'goal':'‚öΩ','own-goal':'‚öΩ','yellow-card':'üü®','red-card':'üü•',
    'yellow-red-card':'üü®üü•','substitution':'üîÑ','penalty-goal':'‚öΩ','missed-penalty':'‚ùå',
};
const HOCKEY_ICONS = {
    'goal':'üèí','penalty':'‚õî','penalty-shot':'üèí','shootout-goal':'üèí','goalie-change':'ü•Ö',
};

// Normalise an ESPN event type to a lowercase slug.
// Soccer keyEvents: type = { type:'goal', text:'Goal' }
// NHL plays:        type = { id:'505', text:'Goal', abbreviation:'goal' }  (no .type field!)
function espnEventType(e) {
    const t = e.type;
    if (!t) return '';
    if (typeof t === 'string') return t;
    if (t.type) return t.type;
    // NHL plays use abbreviation; soccer falls back to text
    const raw = t.abbreviation || t.text || '';
    return raw.toLowerCase().trim().replace(/\s+/g, '-');
}

function buildTimeline(keyEvents, homeTeamId, sport) {
    const isHockey = sport === 'hockey';
    const SHOW = isHockey
        ? new Set(['goal','penalty','penalty-shot','shootout-goal'])
        : new Set(['goal','own-goal','yellow-card','red-card','yellow-red-card','substitution','penalty-goal','missed-penalty']);
    const ICONS = isHockey ? HOCKEY_ICONS : SOCCER_ICONS;

    const events = keyEvents.filter(e => {
        const type = espnEventType(e);
        if (SHOW.has(type)) return true;
        // All scoring plays regardless of sport/type string
        if (e.scoringPlay) return true;
        // NHL plays: penalties identified by penaltyMinutes field
        if (isHockey && e.type?.penaltyMinutes) return true;
        return false;
    });
    if (!events.length) return '<div class="no-events">Ei kirjattuja tapahtumia</div>';

    let html = '<div class="timeline">';
    let curPeriod = null;

    for (const e of events) {
        const period = e.period?.number ?? 0;
        const type   = espnEventType(e);
        const min    = e.clock?.displayValue || '';
        const isNHLPenalty = isHockey && !e.scoringPlay && e.type?.penaltyMinutes;
        const icon   = isNHLPenalty ? '‚õî'
                     : ICONS[type]
                     || (e.scoringPlay ? (isHockey ? 'üèí' : '‚öΩ') : '‚Ä¢');
        const isHome = e.team?.id === homeTeamId;
        const parts  = e.participants || [];

        if (period !== curPeriod) {
            curPeriod = period;
            let lbl;
            if (isHockey) {
                lbl = period === 4 ? 'Jatkoaika'
                    : period >= 5  ? 'Voittolaukauskilpailu'
                    : period > 0   ? `${period}. er√§` : '';
            } else {
                lbl = period === 1 ? '1. puoliaika'
                    : period === 2 ? '2. puoliaika'
                    : period >= 3  ? 'Jatkoaika' : '';
            }
            if (lbl) html += `<div class="tl-period">${lbl}</div>`;
        }

        let content = '';
        if (type === 'substitution') {
            const pOn  = parts[0]?.athlete?.displayName ?? '?';
            const pOff = parts[1]?.athlete?.displayName ?? '';
            content = `<div class="tl-player">‚ñ≤ ${pOn}</div>
                       ${pOff ? `<div class="tl-sub-detail">‚ñº ${pOff}</div>` : ''}`;
        } else if (isNHLPenalty) {
            const player   = parts[0]?.athlete?.displayName ?? '';
            const penName  = e.type?.text || '';
            const penMins  = e.type?.penaltyMinutes || '';
            content = `<div class="tl-player">${player}</div>
                       <div class="tl-assist">${penName}${penMins ? ' ('+penMins+' min)' : ''}</div>`;
        } else {
            // Find scorer and assisters (NHL plays mark them by type field)
            const scorer   = (parts.find(p => p.type === 'scorer') ?? parts[0])?.athlete?.displayName ?? '';
            const a1       = (parts.find(p => p.type === 'assister') ?? parts[1])?.athlete?.displayName ?? '';
            const a2       = parts.filter(p => p.type === 'assister')[1]?.athlete?.displayName ?? '';
            const showA = (a1 || a2) && (['goal','penalty-goal','shootout-goal'].includes(type) || e.scoringPlay);
            const assistStr = [a1, a2].filter(Boolean).join(', ');
            content = `<div class="tl-player">${scorer}</div>
                       ${showA && assistStr ? `<div class="tl-assist">‚Ü≥ ${assistStr}</div>` : ''}`;
        }

        html += `<div class="tl-event">
            <div class="tl-home">${isHome  ? content : ''}</div>
            <div class="tl-center"><span class="tl-icon">${icon}</span><span class="tl-min">${min}</span></div>
            <div class="tl-away">${!isHome ? content : ''}</div>
        </div>`;
    }

    return html + '</div>';
}

// ‚îÄ‚îÄ Stats bars ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const STAT_DEFS_SOCCER = [
    { key:'Possession',    label:'Pallonhallinta %', isPct:true  },
    { key:'SHOTS',         label:'Laukaukset',        isPct:false },
    { key:'ON GOAL',       label:'Maalilaukaukset',   isPct:false },
    { key:'Corner Kicks',  label:'Kulmapotkut',       isPct:false },
    { key:'Fouls',         label:'Rikkomukset',       isPct:false },
    { key:'Offsides',      label:'Paitsiot',          isPct:false },
    { key:'Saves',         label:'Torjunnat',         isPct:false },
    { key:'Yellow Cards',  label:'Keltaiset kortit',  isPct:false },
    { key:'Red Cards',     label:'Punaiset kortit',   isPct:false },
];
const STAT_DEFS_HOCKEY = [
    { key:'shots',                   label:'Laukaukset',          isPct:false },
    { key:'powerPlayGoals',          label:'Ylivoimamaalit',      isPct:false },
    { key:'powerPlayOpportunities',  label:'Ylivoimatilanteet',   isPct:false },
    { key:'faceOffWinPercent',       label:'Aloitusvoitot %',     isPct:true  },
    { key:'hits',                    label:'Taklaukset',          isPct:false },
    { key:'blocked',                 label:'Blokatut laukaukset', isPct:false },
    { key:'pims',                    label:'Rangaistusmin.',      isPct:false },
];

function buildStats(bsTeams, homeTeam, awayTeam, sport) {
    const homeBS = bsTeams.find(t => t.homeAway === 'home');
    const awayBS = bsTeams.find(t => t.homeAway === 'away');
    if (!homeBS || !awayBS) return '';

    const defs = sport === 'hockey' ? STAT_DEFS_HOCKEY : STAT_DEFS_SOCCER;

    const getVal = (stats, key) => {
        const s = stats.find(s => s.label === key || s.name === key);
        return s ? parseFloat(s.displayValue) : null;
    };

    let html = `<div class="stats-teams">
        <span class="home-label">${homeTeam.shortDisplayName || homeTeam.displayName}</span>
        <span class="away-label">${awayTeam.shortDisplayName || awayTeam.displayName}</span>
    </div>`;

    let hasAny = false;
    for (const def of defs) {
        const hRaw = getVal(homeBS.statistics, def.key);
        const aRaw = getVal(awayBS.statistics, def.key);
        if (hRaw === null && aRaw === null) continue;
        hasAny = true;
        const hVal = hRaw ?? 0, aVal = aRaw ?? 0;
        const total = hVal + aVal;
        const hPct  = def.isPct ? Math.round(hVal) : (total === 0 ? 50 : Math.round(hVal / total * 100));
        const aPct  = 100 - hPct;
        const hDisp = def.isPct ? hVal.toFixed(1) + '%' : hVal;
        const aDisp = def.isPct ? aVal.toFixed(1) + '%' : aVal;

        html += `<div class="stat-row">
            <span class="stat-val home-v">${hDisp}</span>
            <div class="stat-center">
                <div class="stat-bar-track">
                    <div class="bar-h" style="width:${hPct}%"></div>
                    <div class="bar-a" style="width:${aPct}%"></div>
                </div>
                <span class="stat-label">${def.label}</span>
            </div>
            <span class="stat-val away-v">${aDisp}</span>
        </div>`;
    }

    return hasAny ? html : '';
}

async function loadMatchStats(panel, eventId, homeTeam, awayTeam, league) {
    if (league.isLiiga) { return loadLiigaMatchStats(panel, eventId); }
    const content = panel.querySelector('.stats-content');
    content.innerHTML = '<div class="spinner-sm"></div>';
    try {
        if (!detailCache[eventId]) {
            const res = await fetch(summaryUrl(league, eventId));
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            detailCache[eventId] = await res.json();
        }
        const data      = detailCache[eventId];
        const sport     = league.sport;
        const tlIcon    = sport === 'hockey' ? 'üèí' : '‚öΩ';
        // NHL has no keyEvents ‚Äî use plays instead; soccer uses keyEvents
        const evArr = (data.keyEvents?.length) ? data.keyEvents : (data.plays || []);
        const tlHTML    = buildTimeline(evArr, homeTeam.id, sport);
        const statsHTML = buildStats(data.boxscore?.teams || [], homeTeam, awayTeam, sport);

        content.innerHTML = `
            <div class="details-section">
                <div class="details-title">${tlIcon} Tapahtumat</div>
                ${tlHTML}
            </div>
            ${statsHTML ? `<div class="details-section">
                <div class="details-title">üìä Tilastot</div>
                ${statsHTML}
            </div>` : ''}`;
        panel.dataset.loaded = '1';
    } catch (err) {
        content.innerHTML = `<div class="details-error">Virhe: ${err.message}</div>`;
    }
}

// ‚îÄ‚îÄ FPL Stats ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildFplSection(players, fixtureId, teamName) {
    if (!players.length) return `<div class="no-events">Ei pelaajatietoja</div>`;

    let html = `<div class="fpl-team-name">${teamName}</div>`;
    html += `<div class="fpl-table">
        <div class="fpl-row fpl-hdr">
            <span>Pos</span><span>Pelaaja</span>
            <span style="text-align:center">Min</span>
            <span style="text-align:center">G</span>
            <span style="text-align:center">A</span>
            <span style="text-align:center">CS</span>
            <span style="text-align:center" title="Defensive Contribution (tackles + clearances + blocks + interceptions)">DC</span>
            <span style="text-align:center">Bon</span>
            <span style="text-align:center">Pts</span>
        </div>`;

    for (const p of players) {
        const fe = (p.live?.explain || []).find(e => e.fixture === fixtureId);
        if (!fe) continue;

        const stats = {};
        for (const s of fe.stats) stats[s.identifier] = s;

        const mins = stats.minutes?.value ?? 0;
        if (mins === 0) continue;

        const goals   = stats.goals_scored?.value ?? 0;
        const assists = stats.assists?.value ?? 0;
        const cs      = stats.clean_sheets?.value ?? 0;
        const bonus   = stats.bonus?.value ?? 0;
        const yc      = stats.yellow_cards?.value ?? 0;
        const rc      = stats.red_cards?.value ?? 0;
        const og      = stats.own_goals?.value ?? 0;
        const saves   = stats.saves?.value ?? 0;
        const penSav  = stats.penalties_saved?.value ?? 0;
        const dc      = p.live.stats.defensive_contribution ?? 0;
        const totalPts = fe.stats.reduce((sum, s) => sum + s.points, 0);

        const pos    = POS_NAME[p.element_type];
        const posCls = pos.toLowerCase();

        let nameExtra = '';
        if (yc) nameExtra += ' üü®';
        if (rc) nameExtra += ' üü•';
        if (og) nameExtra += ' ‚öΩ(og)';
        if (saves >= 3) nameExtra += ` üß§${saves}`;
        if (penSav) nameExtra += ' ‚úã';

        const isSub    = stats.starts?.value === 0;
        const minLabel = isSub ? `‚Üë${mins}'` : `${mins}'`;
        const ptsCls   = totalPts >= 10 ? 'pts-high' : totalPts >= 6 ? 'pts-med' : 'pts-low';
        const nameCls  = totalPts >= 10 ? 'fpl-name row-starred' : 'fpl-name';
        const csLabel  = (pos === 'GK' || pos === 'DEF' || pos === 'MID') ? (cs ? '‚úì' : '‚Äì') : '‚Äì';

        html += `<div class="fpl-row">
            <span class="fpl-pos fpl-pos-${posCls}">${pos}</span>
            <span class="${nameCls}">${p.web_name}${nameExtra}</span>
            <span class="fpl-num" style="color:var(--muted);font-size:0.9em">${minLabel}</span>
            <span class="fpl-num ${goals   ? 'nonzero' : ''}">${goals   || '‚Äì'}</span>
            <span class="fpl-num ${assists ? 'nonzero' : ''}">${assists || '‚Äì'}</span>
            <span class="fpl-num" style="color:${cs ? '#0369a1' : 'var(--muted)'}">${csLabel}</span>
            <span class="fpl-num ${dc      ? 'nonzero' : ''}">${dc      || '‚Äì'}</span>
            <span class="fpl-num ${bonus   ? 'nonzero' : ''}">${bonus   || '‚Äì'}</span>
            <span class="fpl-pts ${ptsCls}">${totalPts}</span>
        </div>`;
    }

    return html + '</div>';
}

async function loadFplStats(div, ev, homeTeam, awayTeam) {
    div.innerHTML = '<div class="spinner-sm"></div>';
    try {
        const bootstrap = await getFplBootstrap();

        const shortToId = {};
        for (const t of bootstrap.teams) shortToId[t.short_name] = t.id;

        const homeShort = ESPN_TO_FPL[homeTeam.displayName];
        const awayShort = ESPN_TO_FPL[awayTeam.displayName];

        if (!homeShort || !awayShort) {
            throw new Error(`Joukkueen nimi ei vastaa FPL-dataa (${homeTeam.displayName} / ${awayTeam.displayName})`);
        }

        const homeId = shortToId[homeShort];
        const awayId = shortToId[awayShort];

        const fixtures  = await getFplFixtures();
        const matchDate = ev.date.slice(0, 10);

        const fixture = fixtures.find(f => {
            if (!f.kickoff_time) return false;
            const fd = f.kickoff_time.slice(0, 10);
            return fd === matchDate && f.team_h === homeId && f.team_a === awayId;
        });

        if (!fixture || !fixture.event) throw new Error('FPL-ottelua ei l√∂ydy tai peli on lyk√§tty');

        const liveData = await getFplEventLive(fixture.event);
        const liveMap  = {};
        for (const el of liveData.elements) liveMap[el.id] = el;

        const getPlayers = (teamId) =>
            bootstrap.elements
                .filter(p => p.team === teamId)
                .map(p => ({ ...p, live: liveMap[p.id] || null }))
                .filter(p => {
                    if (!p.live) return false;
                    const fe = (p.live.explain || []).find(e => e.fixture === fixture.id);
                    return fe && fe.stats.some(s => s.identifier === 'minutes' && s.value > 0);
                })
                .sort((a, b) => {
                    if (a.element_type !== b.element_type) return a.element_type - b.element_type;
                    const ptA = (a.live.explain||[]).find(e=>e.fixture===fixture.id)?.stats.reduce((s,x)=>s+x.points,0)??0;
                    const ptB = (b.live.explain||[]).find(e=>e.fixture===fixture.id)?.stats.reduce((s,x)=>s+x.points,0)??0;
                    return ptB - ptA;
                });

        const homePlayers = getPlayers(homeId);
        const awayPlayers = getPlayers(awayId);

        div.innerHTML = `
            <div class="details-section">
                <div class="details-title fpl-title">‚öΩ FPL-pisteet ‚Äî Kierros ${fixture.event}</div>
                <div class="fpl-section">${buildFplSection(homePlayers, fixture.id, homeTeam.displayName)}</div>
                <div class="fpl-section">${buildFplSection(awayPlayers, fixture.id, awayTeam.displayName)}</div>
                <div style="font-size:0.68em;color:var(--muted);margin-top:10px;text-align:center">
                    ‚Üë = tullut vaihdossa &nbsp;|&nbsp; üü®üü• = kortit &nbsp;|&nbsp; üß§ = torjunnat &nbsp;|&nbsp; ‚úã = penaltyltorjunta
                </div>
            </div>`;
        div.dataset.loaded = '1';
    } catch (err) {
        div.innerHTML = `<div class="details-error">FPL-tilastoja ei saatavilla: ${err.message}</div>`;
    }
}

// ‚îÄ‚îÄ Lineup ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const SOCCER_POS_GROUP = {
    'GK':0,'G':0,
    'CB':1,'LB':1,'RB':1,'LWB':1,'RWB':1,'SW':1,'D':1,'DF':1,'WB':1,
    'CM':2,'CAM':2,'CDM':2,'DM':2,'LM':2,'RM':2,'AM':2,'M':2,'MF':2,'ATT MID':2,'DEF MID':2,
    'ST':3,'CF':3,'LW':3,'RW':3,'SS':3,'FW':3,'F':3,'W':3,'AT':3,'ATT':3,
};

function getSoccerGroup(abbr) {
    if (!abbr) return 2;
    const a = abbr.toUpperCase().trim();
    if (SOCCER_POS_GROUP[a] !== undefined) return SOCCER_POS_GROUP[a];
    if (a === 'GK' || a.includes('GOAL')) return 0;
    if (a.startsWith('D') || a.endsWith('BACK') || a.endsWith('B')) return 1;
    if (a === 'ST' || a === 'CF' || a.startsWith('F') || a.includes('WARD')) return 3;
    return 2;
}

function shortName(athlete) {
    const sn = athlete?.shortName;
    if (sn) return sn;
    const full = athlete?.displayName || '?';
    const parts = full.split(' ');
    if (parts.length === 1) return parts[0];
    return parts[0][0] + '. ' + parts[parts.length - 1];
}

function parseFormationRows(roster) {
    if (!roster) return [];
    const starters = (roster.roster || []).filter(p => p.starter);
    if (!starters.length) return [];
    starters.sort((a, b) =>
        (a.formationSequence ?? a.formationPlace ?? 99) -
        (b.formationSequence ?? b.formationPlace ?? 99)
    );
    // ESPN sometimes orders GK last (attack‚Üídefense); detect and reverse
    const firstGrp = getSoccerGroup(starters[0].athlete?.position?.abbreviation);
    const lastGrp  = getSoccerGroup(starters[starters.length - 1].athlete?.position?.abbreviation);
    if (lastGrp === 0 && firstGrp !== 0) starters.reverse();

    const fmtn  = roster.formation || '';
    const parts = fmtn.split('-').map(Number).filter(n => n > 0);
    const total = parts.reduce((s, n) => s + n, 0);
    if (parts.length >= 2 && total === starters.length - 1) {
        const rows = [[starters[0]]]; // GK row
        let idx = 1;
        for (const count of parts) {
            rows.push(starters.slice(idx, idx + count));
            idx += count;
        }
        return rows;
    }
    // Fallback: group by position abbreviation
    const groups = [[], [], [], []];
    for (const p of starters) {
        groups[getSoccerGroup(p.athlete?.position?.abbreviation)].push(p);
    }
    return groups.filter(g => g.length > 0);
}

function buildSoccerPitch(homeRoster, awayRoster, homeTeam, awayTeam) {
    const homeRows = parseFormationRows(homeRoster);
    const awayRows = parseFormationRows(awayRoster);
    const homeFmtn = homeRoster?.formation || '';
    const awayFmtn = awayRoster?.formation || '';

    const row = (players, side) => {
        if (!players.length) return '';
        return `<div class="pitch-row">${players.map(p => {
            const num  = p.jersey || '';
            const name = shortName(p.athlete);
            return `<div class="pitch-player">
                <div class="pitch-dot ${side}">${num}</div>
                <div class="pitch-pname">${name}</div>
            </div>`;
        }).join('')}</div>`;
    };

    // Home: GK‚ÜíDEF‚ÜíMID‚ÜíFWD (top half, GK at top)
    // Away: FWD‚ÜíMID‚ÜíDEF‚ÜíGK (bottom half, GK at bottom ‚Äî mirrored)
    return `<div class="lineup-pitch">
        <div class="pitch-team-strip" style="background:rgba(3,105,161,0.15);border-radius:8px 8px 0 0">
            <span class="pitch-team-badge home-badge">${homeTeam.shortDisplayName || homeTeam.displayName}</span>
            <span class="pitch-fmtn">${homeFmtn}</span>
        </div>
        <div class="pitch-field">
            <div class="pitch-half">
                ${homeRows.map(r => row(r, 'home')).join('')}
            </div>
            <div class="pitch-midline-wrap">
                <div class="pitch-center-circle"></div>
            </div>
            <div class="pitch-half">
                ${[...awayRows].reverse().map(r => row(r, 'away')).join('')}
            </div>
        </div>
        <div class="pitch-team-strip" style="background:rgba(37,99,235,0.12);border-radius:0 0 8px 8px">
            <span class="pitch-team-badge away-badge">${awayTeam.shortDisplayName || awayTeam.displayName}</span>
            <span class="pitch-fmtn">${awayFmtn}</span>
        </div>
    </div>`;
}

function buildSimpleLineup(homeRoster, awayRoster, homeTeam, awayTeam) {
    const getStarters = (r) => (r?.roster || []).filter(p => p.starter);
    const list = (players, teamName, side) => {
        if (!players.length) return `<div class="no-events">Ei kokoonpanotietoja</div>`;
        return `<div>
            <div style="font-size:0.72em;font-weight:700;text-transform:uppercase;letter-spacing:1px;
                        color:${side==='home'?'#0369a1':'#2563eb'};margin-bottom:8px">${teamName}</div>
            ${players.map(p => `<div style="display:flex;align-items:center;gap:8px;padding:4px 0;
                                            border-bottom:1px solid #f0f0f0;font-size:0.8em">
                <span style="width:22px;text-align:center;font-weight:700;color:var(--muted)">${p.jersey||'‚Äì'}</span>
                <span style="font-size:0.72em;font-weight:600;background:${side==='home'?'#bae6fd':'#dbeafe'};
                             color:${side==='home'?'#0369a1':'#1e40af'};
                             padding:1px 5px;border-radius:4px;flex-shrink:0">
                    ${p.athlete?.position?.abbreviation||'‚Äì'}
                </span>
                <span>${p.athlete?.displayName||'?'}</span>
            </div>`).join('')}
        </div>`;
    };
    return `<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
        ${list(getStarters(homeRoster), homeTeam.shortDisplayName||homeTeam.displayName, 'home')}
        ${list(getStarters(awayRoster), awayTeam.shortDisplayName||awayTeam.displayName, 'away')}
    </div>`;
}

async function loadLineups(div, eventId, league, homeTeam, awayTeam) {
    if (league.isLiiga) {
        div.innerHTML = '<div class="no-events">Kokoonpanotietoja ei saatavilla</div>';
        div.dataset.loaded = '1';
        return;
    }
    div.innerHTML = '<div class="spinner-sm"></div>';
    try {
        if (!detailCache[eventId]) {
            const res = await fetch(summaryUrl(league, eventId));
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            detailCache[eventId] = await res.json();
        }
        const data    = detailCache[eventId];
        const rosters = data.rosters || [];

        if (!rosters.length) {
            div.innerHTML = '<div class="no-events">Kokoonpanotietoja ei saatavilla</div>';
            div.dataset.loaded = '1';
            return;
        }

        const homeRoster = rosters.find(r => r.homeAway === 'home');
        const awayRoster = rosters.find(r => r.homeAway === 'away');

        div.innerHTML = league.sport === 'soccer'
            ? buildSoccerPitch(homeRoster, awayRoster, homeTeam, awayTeam)
            : buildSimpleLineup(homeRoster, awayRoster, homeTeam, awayTeam);

        div.dataset.loaded = '1';
    } catch (err) {
        div.innerHTML = `<div class="details-error">Virhe: ${err.message}</div>`;
    }
}

// ‚îÄ‚îÄ Card creation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function createCard(ev, league) {
    const comp   = ev.competitions[0];
    const home   = comp.competitors.find(c => c.homeAway === 'home');
    const away   = comp.competitors.find(c => c.homeAway === 'away');
    const status = comp.status.type;
    const isPre     = status.state === 'pre';
    const isPost    = status.state === 'post';
    const isLive    = status.state === 'in';
    const matchMs   = new Date(ev.date).getTime();
    const canStats  = isPost || isLive;
    const canLineup = canStats || (isPre && matchMs - Date.now() <= 10 * 60 * 1000);
    const canBtn    = canStats || canLineup;
    const hasFPL    = !!(league.hasFPL && canStats);

    let statusClass = 'status-pre', statusText = fmtTime(ev.date);
    if (isPost) { statusClass = 'status-ft';   statusText = status.shortDetail || 'FT'; }
    if (isLive) { statusClass = 'status-live'; statusText = status.detail      || 'LIVE'; }

    let centerHTML;
    if (isPost || isLive) {
        centerHTML = `<div class="score-block">
            <div class="score-pill">
                <div class="score">${home.score}&ndash;${away.score}</div>
                <div class="score-detail">${isLive ? status.displayClock || 'LIVE' : 'Lopputulos'}</div>
            </div>
        </div>`;
    } else {
        centerHTML = `<div class="score-block">
            <div class="upcoming-block">
                <div class="upcoming-time">${fmtTime(ev.date)}</div>
                <div class="upcoming-vs">vs</div>
            </div>
        </div>`;
    }

    const venue = comp.venue?.fullName ?? '';
    const card  = document.createElement('div');
    card.className = 'match-card' + (canBtn ? ' has-btns' : '');

    card.innerHTML = `
        <div class="match-meta">
            <span>${fmtDate(ev.date)}</span>
            <span class="match-status ${statusClass}">${statusText}</span>
            <span>${venue}</span>
        </div>
        <div class="match-teams">
            <div class="team">
                <div class="team-logo">
                    <img src="${home.team.logo}" alt="${home.team.displayName}"
                         onerror="this.style.visibility='hidden'">
                </div>
                <div class="team-name">${home.team.displayName}</div>
            </div>
            ${centerHTML}
            <div class="team">
                <div class="team-logo">
                    <img src="${away.team.logo}" alt="${away.team.displayName}"
                         onerror="this.style.visibility='hidden'">
                </div>
                <div class="team-name">${away.team.displayName}</div>
            </div>
        </div>
        ${canBtn ? `
        <div class="detail-panel stats-panel">
            <div class="detail-tab-row">
                ${canStats ? `<button class="detail-tab-btn stats-tab active">üìä Ottelutapahtumat</button>` : ''}
                <button class="detail-tab-btn lineups-tab${canStats ? '' : ' active'}">üë• Kokoonpanot</button>
                ${hasFPL ? '<button class="detail-tab-btn fpl-tab">‚öΩ FPL Pisteet</button>' : ''}
            </div>
            ${canStats ? `<div class="panel-content stats-content active"></div>` : ''}
            <div class="panel-content lineups-content${canStats ? '' : ' active'}"></div>
            ${hasFPL ? '<div class="panel-content fpl-content"></div>' : ''}
        </div>` : ''}`;

    if (canBtn) {
        const statsPanel      = card.querySelector('.stats-panel');
        const statsContent    = card.querySelector('.stats-content');
        const lineupsContent  = card.querySelector('.lineups-content');
        const fplContent      = card.querySelector('.fpl-content');
        const statsTab        = card.querySelector('.stats-tab');
        const lineupsTab      = card.querySelector('.lineups-tab');
        const fplTab          = card.querySelector('.fpl-tab');

        // Helper: activate one tab+content, deactivate rest
        const switchTab = (activeBtn, activeDiv) => {
            card.querySelectorAll('.detail-tab-btn').forEach(b => b.classList.remove('active'));
            card.querySelectorAll('.panel-content').forEach(c => c.classList.remove('active'));
            activeBtn.classList.add('active');
            activeDiv.classList.add('active');
        };

        // Click anywhere on card ‚Üí open stats panel, or close if already open
        card.addEventListener('click', () => {
            if (statsPanel.classList.contains('panel-open')) {
                statsPanel.classList.remove('panel-open');
                card.classList.remove('panel-open');
            } else {
                statsPanel.classList.add('panel-open');
                card.classList.add('panel-open');
                if (canStats && !statsPanel.dataset.loaded) {
                    loadMatchStats(statsPanel, ev.id, home.team, away.team, league);
                } else if (!canStats && canLineup && !lineupsContent.dataset.loaded) {
                    loadLineups(lineupsContent, ev.id, league, home.team, away.team);
                }
            }
        });

        if (statsTab) {
            statsTab.addEventListener('click', e => {
                e.stopPropagation();
                switchTab(statsTab, statsContent);
            });
        }

        lineupsTab.addEventListener('click', e => {
            e.stopPropagation();
            switchTab(lineupsTab, lineupsContent);
            if (!lineupsContent.dataset.loaded) {
                loadLineups(lineupsContent, ev.id, league, home.team, away.team);
            }
        });

        if (hasFPL) {
            fplTab.addEventListener('click', e => {
                e.stopPropagation();
                switchTab(fplTab, fplContent);
                if (!fplContent.dataset.loaded) {
                    loadFplStats(fplContent, ev, home.team, away.team);
                }
            });
        }
    }

    return card;
}

// ‚îÄ‚îÄ Render helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderEvents(events, containerId, upcoming, league) {
    const el = document.getElementById(containerId);
    el.innerHTML = '';

    if (!events.length) {
        el.innerHTML = '<div class="error-msg">Otteluita ei l√∂ytynyt.</div>';
        return;
    }

    const info = document.createElement('p');
    info.className = 'section-info';
    info.textContent = upcoming ? `${events.length} tulevaa ottelua` : `${events.length} ottelua`;
    el.appendChild(info);

    const groups = new Map();
    for (const ev of events) {
        const day = ev.date.slice(0, 10);
        if (!groups.has(day)) groups.set(day, []);
        groups.get(day).push(ev);
    }

    const days = [...groups.keys()].sort((a, b) =>
        upcoming ? a.localeCompare(b) : b.localeCompare(a));

    for (const day of days) {
        const dayEvents = groups.get(day).sort((a, b) =>
            upcoming ? new Date(a.date) - new Date(b.date)
                     : new Date(b.date) - new Date(a.date));

        const hdr = document.createElement('div');
        hdr.className = 'matchday-header';
        hdr.textContent = new Date(day + 'T12:00:00').toLocaleDateString('fi-FI', {
            weekday:'long', day:'numeric', month:'long', year:'numeric'
        });
        el.appendChild(hdr);
        for (const ev of dayEvents) el.appendChild(createCard(ev, league));
    }
}

function renderResultsWithLive(events, hasLive, league) {
    const el = document.getElementById('results');
    el.innerHTML = '';

    if (hasLive) {
        el.innerHTML = `<div class="live-banner">
            <div class="live-dot"></div>
            <span>Ottelu k√§ynniss√§ ‚Äî <span id="live-countdown">p√§ivitet√§√§n 60 sek. kuluttua</span></span>
        </div>`;
    }

    if (!events.length) {
        el.insertAdjacentHTML('beforeend', '<div class="error-msg">Otteluita ei l√∂ytynyt.</div>');
        return;
    }

    const info = document.createElement('p');
    info.className = 'section-info';
    info.textContent = `${events.length} ottelua`;
    el.appendChild(info);

    const groups = new Map();
    for (const ev of events) {
        const day = ev.date.slice(0, 10);
        if (!groups.has(day)) groups.set(day, []);
        groups.get(day).push(ev);
    }

    const days = [...groups.keys()].sort((a, b) => b.localeCompare(a));
    for (const day of days) {
        const dayEvents = groups.get(day).sort((a, b) => new Date(b.date) - new Date(a.date));
        const hdr = document.createElement('div');
        hdr.className = 'matchday-header';
        hdr.textContent = new Date(day + 'T12:00:00').toLocaleDateString('fi-FI', {
            weekday:'long', day:'numeric', month:'long', year:'numeric'
        });
        el.appendChild(hdr);
        for (const ev of dayEvents) el.appendChild(createCard(ev, league));
    }
}

// ‚îÄ‚îÄ Standings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// Flatten potentially nested ESPN standings children to get all team entries
function flattenEntries(node) {
    if (node.standings?.entries?.length) return node.standings.entries;
    if (!node.children) return [];
    let all = [];
    for (const child of node.children) all = all.concat(flattenEntries(child));
    return all;
}

// Stat category labels per sport
const TEAM_STAT_LABELS = {
    soccer: { goals: 'Maalit', assists: 'Sy√∂t√∂t', minutesPlayed: 'Minuutit', yellowCards: 'Kelt. kortit', saves: 'Torjunnat' },
    hockey: { points: 'Pisteet', goals: 'Maalit', assists: 'Sy√∂t√∂t', plusMinus: '+/‚Äì', saves: 'Torjunnat' },
};

async function loadTeamStats(div, teamId, league) {
    div.innerHTML = '<div class="spinner-sm"></div>';
    try {
        const res = await fetch(teamUrl(league, teamId));
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const leaders = data.team?.leaders || [];
        const labels  = TEAM_STAT_LABELS[league.sport] || TEAM_STAT_LABELS.soccer;

        const cards = [];
        for (const cat of leaders) {
            const label = labels[cat.name];
            if (!label) continue;
            const top = cat.leaders?.[0];
            if (!top) continue;
            const name = top.athlete?.shortName || top.athlete?.displayName || '‚Äì';
            cards.push(`<div class="team-stat-card">
                <div class="team-stat-card-label">${label}</div>
                <div class="team-stat-value">${top.displayValue}</div>
                <div class="team-stat-name">${name}</div>
            </div>`);
            if (cards.length >= 3) break;
        }

        if (!cards.length) {
            div.innerHTML = '<div class="no-events">Ei tilastoja saatavilla.</div>';
            return;
        }
        div.innerHTML = `<div class="team-stat-cards">${cards.join('')}</div>`;
    } catch (err) {
        div.innerHTML = `<div class="no-events">Virhe: ${err.message}</div>`;
    }
}

function attachTeamStatsHandlers(el, league) {
    // Always update the current league reference
    el._statsLeague = league;

    // Create a fresh panel and append to standings container
    const panel = document.createElement('div');
    panel.className = 'team-stats-panel';
    panel.style.display = 'none';
    el.appendChild(panel);
    el._statsPanel = panel;

    // Only add the delegated listener once ‚Äî it reads el._statsLeague / el._statsPanel dynamically
    if (el._statsListenerAdded) return;
    el._statsListenerAdded = true;

    el.addEventListener('click', function(e) {
        const row = e.target.closest('.st-row');
        if (!row) return;

        const p        = el._statsPanel;
        const lg       = el._statsLeague;
        const teamId   = row.getAttribute('data-team-id');
        const teamName = row.getAttribute('data-team-name');
        const teamLogo = row.getAttribute('data-team-logo');
        if (!teamId || !p) return;

        // Toggle same team closed
        if (p.dataset.openId === teamId && p.style.display !== 'none') {
            p.style.display = 'none';
            p.dataset.openId = '';
            el.querySelectorAll('.st-row').forEach(r => r.classList.remove('st-active'));
            return;
        }

        el.querySelectorAll('.st-row').forEach(r => r.classList.remove('st-active'));
        row.classList.add('st-active');
        p.dataset.openId = teamId;
        p.style.display = 'block';

        // Reposition panel after the nearest match-card
        const card = row.closest('.match-card');
        if (card) card.after(p);

        p.innerHTML = `
            <div class="team-stats-header">
                <img src="${teamLogo}" alt="" onerror="this.style.visibility='hidden'">
                <span>${teamName}</span>
            </div>
            <div class="ts-body"></div>`;
        loadTeamStats(p.querySelector('.ts-body'), teamId, lg);
    });
}

async function loadStandings(league) {
    const el = document.getElementById('standings');
    if (league.isLiiga) { return loadLiigaStandings(league); }
    if (league.unavailable) { el.innerHTML = unavailableHTML(); return; }

    try {
        const res = await fetch(standingsUrl(league));
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        const isHockey = league.sport === 'hockey';

        // Collect all entries
        let entries = flattenEntries(data);

        // For NHL, group by conference/division if children exist
        if (isHockey && data.children?.length) {
            renderHockeyStandings(el, data, league);
        } else {
            renderSoccerStandings(el, entries, league);
        }
    } catch (err) {
        el.innerHTML = `<div class="error-msg">Virhe sarjataulukon lataamisessa: ${err.message}</div>`;
    }
}

function standingsTableHTML(entries, cols, sport) {
    const zones = new Map();
    let rows = '';

    // Sort by rank stat
    entries.sort((a, b) => {
        const rA = Number(a.stats?.find(s => s.name === 'rank')?.displayValue ?? 99);
        const rB = Number(b.stats?.find(s => s.name === 'rank')?.displayValue ?? 99);
        return rA - rB;
    });

    for (const entry of entries) {
        const t     = entry.team;
        const stats = Object.fromEntries((entry.stats || []).map(s => [s.name, s.displayValue]));
        const note  = entry.note;
        const logo  = t.logos?.[0]?.href ?? '';

        let zoneBar = '';
        if (note?.color) {
            zoneBar = `<span class="zone-bar" style="background:${note.color}"></span>`;
            if (!zones.has(note.description)) zones.set(note.description, note.color);
        }

        const rank = Number(stats.rank ?? 0);

        let tdCells = '';
        for (const col of cols) {
            const raw = stats[col.name] ?? '';
            if (col.name === 'pointDifferential') {
                const n = Number(raw);
                const gdStr = raw.startsWith('+') || raw.startsWith('-') ? raw : (n >= 0 ? '+' + raw : raw);
                const gdColor = n > 0 ? '#0369a1' : n < 0 ? '#dc2626' : '';
                tdCells += `<td class="st-gd" style="color:${gdColor}">${gdStr}</td>`;
            } else if (col.cls) {
                tdCells += `<td class="${col.cls}">${raw}</td>`;
            } else {
                tdCells += `<td>${raw}</td>`;
            }
        }

        rows += `<tr class="st-row" data-team-id="${t.id}" data-team-name="${t.displayName}" data-team-logo="${logo}">
            <td class="st-rank">${rank}</td>
            <td><div class="st-team">
                ${zoneBar}
                <img src="${logo}" alt="${t.shortDisplayName}" onerror="this.style.visibility='hidden'">
                <span>${t.displayName}</span>
            </div></td>
            ${tdCells}
        </tr>`;
    }

    const thCells = cols.map(c => `<th>${c.label}</th>`).join('');

    const legendItems = [...zones.entries()].map(([desc, color]) => {
        const fi = desc === 'Champions League'         ? 'Mestareiden liiga'
                 : desc === 'Europa League'            ? 'Europa-liiga'
                 : desc === 'UEFA Conference League'   ? 'Conference-liiga'
                 : desc === 'Relegation'               ? 'Putoamisvy√∂hyke'
                 : desc === 'Playoff'                  ? 'Playoffs'
                 : desc;
        return `<div class="legend-item">
            <div class="legend-dot" style="background:${color}"></div>
            <span>${fi}</span>
        </div>`;
    }).join('');

    return { rows, thCells, legendHTML: legendItems };
}

function renderSoccerStandings(el, entries, league) {
    const cols = [
        { name:'gamesPlayed',      label:'P'   },
        { name:'wins',             label:'V'   },
        { name:'ties',             label:'T'   },
        { name:'losses',           label:'H'   },
        { name:'pointsFor',        label:'TM'  },
        { name:'pointsAgainst',    label:'PM'  },
        { name:'pointDifferential',label:'ME'  },
        { name:'points',           label:'Pts', cls:'st-pts' },
    ];

    const { rows, thCells, legendHTML } = standingsTableHTML(entries, cols, 'soccer');

    el.innerHTML = `
        <p class="section-info">Kausi 2025‚Äì26</p>
        <div class="match-card" style="padding:0;overflow:hidden;border-radius:16px">
            <div style="overflow-x:auto;-webkit-overflow-scrolling:touch">
                <table class="standings-table">
                    <thead><tr><th>#</th><th style="text-align:left">Joukkue</th>${thCells}</tr></thead>
                    <tbody>${rows}</tbody>
                </table>
            </div>
        </div>
        <div class="standings-legend">${legendHTML}</div>`;
    attachTeamStatsHandlers(el, league);
}

function renderHockeyStandings(el, data, league) {
    const cols = [
        { name:'gamesPlayed', label:'P'   },
        { name:'wins',        label:'V'   },
        { name:'losses',      label:'H'   },
        { name:'otLosses',    label:'OT'  },
        { name:'points',      label:'Pts', cls:'st-pts' },
        { name:'pointsFor',   label:'TM'  },
        { name:'pointsAgainst',label:'PM' },
    ];

    const thCells = cols.map(c => `<th>${c.label}</th>`).join('');
    let html = '<p class="section-info">Kausi 2025‚Äì26</p>';

    // Iterate conferences / divisions
    const conferences = data.children || [];

    for (const conf of conferences) {
        const confName = conf.name || conf.abbreviation || '';
        html += `<div class="matchday-header" style="margin-top:20px">${confName}</div>`;

        const divisions = conf.children || [conf];

        for (const div of divisions) {
            const divName = div.name || div.abbreviation || '';
            const entries = div.standings?.entries || [];

            if (!entries.length) continue;
            if (div !== conf) {
                html += `<div style="font-size:0.72em;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin:14px 0 6px;padding-left:4px">${divName}</div>`;
            }

            const { rows } = standingsTableHTML(entries, cols, 'hockey');

            html += `<div class="match-card" style="padding:0;overflow:hidden;margin-bottom:12px">
                <div style="overflow-x:auto;-webkit-overflow-scrolling:touch">
                    <table class="standings-table">
                        <thead><tr><th>#</th><th style="text-align:left">Joukkue</th>${thCells}</tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
            </div>`;
        }
    }

    el.innerHTML = html;
    attachTeamStatsHandlers(el, league);
}

// ‚îÄ‚îÄ Live auto-refresh ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let liveInterval   = null;
let liveCountdown  = 60;
let countdownTimer = null;

function stopLiveRefresh() {
    clearInterval(liveInterval);
    clearInterval(countdownTimer);
    liveInterval = countdownTimer = null;
}

function startLiveRefresh(league) {
    if (liveInterval) return;
    liveCountdown = 60;

    countdownTimer = setInterval(() => {
        liveCountdown--;
        const badge = document.getElementById('live-countdown');
        if (badge) badge.textContent = `P√§ivitet√§√§n ${liveCountdown} sek. kuluttua`;
        if (liveCountdown <= 0) liveCountdown = 60;
    }, 1000);

    liveInterval = setInterval(() => {
        liveCountdown = 60;
        refreshResults(league);
    }, 60000);
}

async function refreshResults(league) {
    if (!league || (league.unavailable && !league.isLiiga)) { stopLiveRefresh(); return; }
    if (league.key !== currentLeagueKey) { stopLiveRefresh(); return; }

    if (league.isLiiga) {
        await fetchLiigaGames(liigaCurrentSeason(), true);
        await loadLiigaResults(league);
        return;
    }

    try {
        const to = new Date(), from = new Date();
        from.setDate(from.getDate() - 35);
        const events   = await fetchMatches(league, from, to);
        const live     = events.filter(e => e.competitions[0].status.type.state === 'in');
        const finished = events.filter(e => e.competitions[0].status.type.state === 'post');

        if (live.length === 0) stopLiveRefresh();

        renderResultsWithLive([...live, ...finished], live.length > 0, league);
    } catch {}
}

// ‚îÄ‚îÄ Player stats ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function playerStatsUrl(league) {
    return `https://site.api.espn.com/apis/site/v2/sports/soccer/${league.id}/statistics`;
}

function getStat(athlete, name) {
    const s = (athlete.statistics || []).find(s => s.name === name);
    return s ? Number(s.value) : 0;
}

function buildPlayerTable(leaders, mainStat, mainLabel, limit) {
    const rows = leaders.slice(0, limit).map((l, i) => {
        const a    = l.athlete;
        const team = a.team?.displayName || '';
        const apps = getStat(a, 'appearances');
        const val  = getStat(a, mainStat);
        return `<tr>
            <td class="st-rank">${i + 1}</td>
            <td style="text-align:left">
                <span class="ps-player">${a.displayName}</span>
                <span class="ps-team">${team}</span>
            </td>
            <td class="ps-apps">${apps}</td>
            <td class="ps-val">${val}</td>
        </tr>`;
    }).join('');

    return `<div class="match-card" style="padding:0;overflow:hidden;border-radius:16px">
        <div style="overflow-x:auto;-webkit-overflow-scrolling:touch">
            <table class="standings-table">
                <thead><tr>
                    <th>#</th>
                    <th style="text-align:left">Pelaaja</th>
                    <th title="Ottelut pelattu">P</th>
                    <th>${mainLabel}</th>
                </tr></thead>
                <tbody>${rows}</tbody>
            </table>
        </div>
    </div>`;
}

function renderPlayerStats(el, data) {
    const goalsCat   = data.stats?.find(s => s.name === 'goalsLeaders');
    const assistsCat = data.stats?.find(s => s.name === 'assistsLeaders');

    if (!goalsCat && !assistsCat) {
        el.innerHTML = '<div class="error-msg">Tilastoja ei saatavilla</div>';
        return;
    }

    // Build G+A leaders by merging both lists
    const seen = new Map();
    for (const l of [...(goalsCat?.leaders || []), ...(assistsCat?.leaders || [])]) {
        if (!seen.has(l.athlete.id)) seen.set(l.athlete.id, l);
    }
    const gaLeaders = [...seen.values()].sort((a, b) => {
        const gaA = getStat(a.athlete, 'totalGoals') + getStat(a.athlete, 'goalAssists');
        const gaB = getStat(b.athlete, 'totalGoals') + getStat(b.athlete, 'goalAssists');
        return gaB - gaA || getStat(b.athlete, 'totalGoals') - getStat(a.athlete, 'totalGoals');
    }).map(l => ({
        athlete: {
            ...l.athlete,
            statistics: [
                ...(l.athlete.statistics || []),
                { name: 'ga', value: getStat(l.athlete, 'totalGoals') + getStat(l.athlete, 'goalAssists') },
            ]
        }
    }));

    el.innerHTML = `
        <p class="section-info">Kauden parhaat pelaajat</p>
        <div class="ps-section">
            <div class="ps-section-title">‚öΩ Maalintekij√§t</div>
            ${buildPlayerTable(goalsCat?.leaders || [], 'totalGoals', 'M', 10)}
        </div>
        <div class="ps-section">
            <div class="ps-section-title">üéØ Sy√∂tt√§j√§t</div>
            ${buildPlayerTable(assistsCat?.leaders || [], 'goalAssists', 'S', 10)}
        </div>
        <div class="ps-section">
            <div class="ps-section-title">üìä Pistep√∂rssi (M+S)</div>
            ${buildPlayerTable(gaLeaders, 'ga', 'M+S', 10)}
        </div>`;
}

async function loadPlayerStats(league) {
    const el = document.getElementById('playerstats');
    if (league.sport !== 'soccer') {
        el.innerHTML = '<div class="no-events">Pelaajatilastot saatavilla vain jalkapallosarjoille.</div>';
        return;
    }
    try {
        const res = await fetch(playerStatsUrl(league));
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        renderPlayerStats(el, await res.json());
    } catch (err) {
        el.innerHTML = `<div class="error-msg">Virhe tilastojen lataamisessa: ${err.message}</div>`;
    }
}

// ‚îÄ‚îÄ Liiga API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function liigaCurrentSeason() {
    const now = new Date();
    // Season labeled by year it ends; new season starts in August
    return now.getMonth() >= 7 ? now.getFullYear() + 1 : now.getFullYear();
}

const liigaGamesCache = {}; // season ‚Üí { data: [], ts: timestamp }
const liigaGameById   = {}; // gameId ‚Üí raw game object

async function fetchLiigaGames(season, force) {
    const cached = liigaGamesCache[season];
    if (cached && !force && (Date.now() - cached.ts < 55000)) return cached.data;
    const res = await fetch(`https://www.liiga.fi/api/v2/games?season=${season}&gameType=runkosarja`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    liigaGamesCache[season] = { data, ts: Date.now() };
    for (const g of data) liigaGameById[String(g.id)] = g;
    return data;
}

const LIIGA_GOAL_TYPE = { YV:'YV', AV:'AV', VL:'VL', RL:'RL' };

function liigaToESPN(game) {
    const home = game.homeTeam;
    const away = game.awayTeam;
    if (!home.teamName || !away.teamName) return null;

    let state, shortDetail, displayClock;
    if (game.ended) {
        state = 'post';
        const ft = game.finishedType;
        shortDetail = ft === 'ENDED_DURING_OVERTIME' ? 'JA'
                    : ft === 'ENDED_DURING_SHOOTOUT'  ? 'VL'
                    : 'Lopputulos';
        displayClock = '';
    } else if (game.started) {
        state = 'in';
        shortDetail = `${game.currentPeriod}. er√§`;
        displayClock = `${game.currentPeriod}. er√§`;
    } else {
        state = 'pre';
        shortDetail = '';
        displayClock = '';
    }

    return {
        id: String(game.id),
        date: game.start,
        competitions: [{
            competitors: [
                { homeAway:'home', team:{ id: home.teamId, displayName: home.teamName,
                    shortDisplayName: home.teamName, logo: home.logos?.darkBg || '' },
                  score: String(home.goals ?? 0) },
                { homeAway:'away', team:{ id: away.teamId, displayName: away.teamName,
                    shortDisplayName: away.teamName, logo: away.logos?.darkBg || '' },
                  score: String(away.goals ?? 0) }
            ],
            status: { type: { state, shortDetail, detail: shortDetail, displayClock } },
            venue: game.iceRink ? { fullName: game.iceRink.name } : null
        }]
    };
}

async function loadLiigaMatchStats(panel, gameId) {
    const content = panel.querySelector('.stats-content');
    content.innerHTML = '<div class="spinner-sm"></div>';
    try {
        const game = liigaGameById[String(gameId)];
        if (!game) throw new Error('Pelin tietoja ei l√∂ydy');

        const allGoals = [];
        for (const ge of (game.homeTeam.goalEvents || [])) allGoals.push({ ...ge, isHome: true });
        for (const ge of (game.awayTeam.goalEvents || [])) allGoals.push({ ...ge, isHome: false });
        allGoals.sort((a, b) => (a.period - b.period) || (a.gameTime - b.gameTime));

        let tlHTML = '<div class="timeline">';
        let curPeriod = null;
        for (const ge of allGoals) {
            if (ge.period !== curPeriod) {
                curPeriod = ge.period;
                const lbl = ge.period <= 3 ? `${ge.period}. er√§` : 'Jatkoaika / VL';
                tlHTML += `<div class="tl-period">${lbl}</div>`;
            }
            const mins    = Math.floor(ge.gameTime / 60);
            const secs    = String(ge.gameTime % 60).padStart(2, '0');
            const timeStr = `${mins}:${secs}`;
            const types   = (ge.goalTypes || []).join(', ');
            const scorer  = ge.scorerPlayer
                ? `${ge.scorerPlayer.firstName} ${ge.scorerPlayer.lastName}${types ? ' (' + types + ')' : ''}`
                : '?';
            const assists = (ge.assistantPlayers || []).map(a => `${a.firstName} ${a.lastName}`).join(', ');
            const score   = `${ge.homeTeamScore}‚Äì${ge.awayTeamScore}`;
            const cellHTML = `<div class="tl-player">${scorer}</div>
                ${assists ? `<div class="tl-assist">‚Ü≥ ${assists}</div>` : ''}`;
            tlHTML += `<div class="tl-event">
                <div class="tl-home">${ge.isHome  ? cellHTML : ''}</div>
                <div class="tl-center"><span class="tl-icon">üèí</span><span class="tl-min">${timeStr} (${score})</span></div>
                <div class="tl-away">${!ge.isHome ? cellHTML : ''}</div>
            </div>`;
        }
        if (!allGoals.length) tlHTML += '<div class="no-events">Ei maaleja kirjattu</div>';
        tlHTML += '</div>';

        content.innerHTML = `<div class="details-section">
            <div class="details-title">üèí Maalit</div>${tlHTML}</div>`;
        panel.dataset.loaded = '1';
    } catch (err) {
        content.innerHTML = `<div class="details-error">Virhe: ${err.message}</div>`;
    }
}

async function loadLiigaResults(league) {
    const el = document.getElementById('results');
    try {
        const season = liigaCurrentSeason();
        const games  = await fetchLiigaGames(season);
        const cutoff = new Date(Date.now() - 35 * 864e5);
        const recent = games.filter(g => g.homeTeam.teamName &&
            (g.ended || g.started) && new Date(g.start) >= cutoff);
        const live     = recent.filter(g => g.started && !g.ended);
        const finished = recent.filter(g => g.ended);
        renderResultsWithLive([...live, ...finished].map(liigaToESPN).filter(Boolean),
            live.length > 0, league);
        if (live.length > 0) startLiveRefresh(league);
    } catch (err) {
        el.innerHTML = `<div class="error-msg">Virhe: ${err.message}</div>`;
    }
}

async function loadLiigaUpcoming(league) {
    const el = document.getElementById('upcoming');
    try {
        const season  = liigaCurrentSeason();
        const games   = await fetchLiigaGames(season);
        const cutoff  = new Date(Date.now() + 35 * 864e5);
        const upcoming = games.filter(g => g.homeTeam.teamName &&
            !g.started && !g.ended && new Date(g.start) <= cutoff);
        renderEvents(upcoming.map(liigaToESPN).filter(Boolean), 'upcoming', true, league);
    } catch (err) {
        el.innerHTML = `<div class="error-msg">Virhe: ${err.message}</div>`;
    }
}

async function loadLiigaStandings(league) {
    const el = document.getElementById('standings');
    try {
        const season = liigaCurrentSeason();
        const url    = `${FPL_PROXY}${encodeURIComponent(`https://www.liiga.fi/api/v2/standings?season=${season}&gameType=runkosarja`)}`;
        const res    = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data   = await res.json();
        const teams  = (data.season || []).slice().sort((a, b) => a.ranking - b.ranking);

        let rows = '';
        for (const t of teams) {
            const logo    = t.teamLogos?.darkBg || '';
            const otWins  = t.overtimeWins  || 0;
            const otLosses= t.overtimeLosses|| 0;
            const regWins = (t.wins   || 0) - otWins;
            const regLoss = (t.losses || 0) - otLosses;
            const gd      = (t.goals || 0) - (t.goalsAgainst || 0);
            const gdStr   = gd >= 0 ? '+' + gd : String(gd);
            const gdColor = gd > 0 ? '#0369a1' : gd < 0 ? '#dc2626' : '';
            rows += `<tr class="st-row" data-team-id="${t.teamId}" data-team-name="${t.teamName}" data-team-logo="${logo}">
                <td class="st-rank">${t.ranking}</td>
                <td><div class="st-team">
                    <img src="${logo}" alt="${t.teamName}" onerror="this.style.visibility='hidden'">
                    <span>${t.teamName}</span>
                </div></td>
                <td>${t.games}</td><td>${regWins}</td><td>${otWins}</td>
                <td>${otLosses}</td><td>${regLoss}</td>
                <td class="st-gd" style="color:${gdColor}">${gdStr}</td>
                <td class="st-pts">${t.points}</td>
            </tr>`;
        }
        const sy = season - 1, ey = String(season).slice(2);
        el.innerHTML = `<p class="section-info">Runkosarja ${sy}‚Äì${ey}</p>
            <div class="match-card" style="padding:0;overflow:hidden;border-radius:16px">
                <div style="overflow-x:auto;-webkit-overflow-scrolling:touch">
                    <table class="standings-table">
                        <thead><tr><th>#</th><th style="text-align:left">Joukkue</th>
                        <th>P</th><th title="Voitot">V</th><th title="Jatkoaikavoitot">JV</th>
                        <th title="Jatkoaikah√§vi√∂t">JH</th><th title="H√§vi√∂t">H</th>
                        <th>ME</th><th class="st-pts">Pts</th></tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
            </div>`;
    } catch (err) {
        el.innerHTML = `<div class="error-msg">Virhe sarjataulukon lataamisessa: ${err.message}</div>`;
    }
}

// ‚îÄ‚îÄ Load functions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadResults(league) {
    if (league.isLiiga) { return loadLiigaResults(league); }
    const el = document.getElementById('results');
    try {
        const to = new Date(), from = new Date();
        from.setDate(from.getDate() - 35);
        const events   = await fetchMatches(league, from, to);
        const live     = events.filter(e => e.competitions[0].status.type.state === 'in');
        const finished = events.filter(e => e.competitions[0].status.type.state === 'post');

        renderResultsWithLive([...live, ...finished], live.length > 0, league);

        if (live.length > 0) startLiveRefresh(league);
    } catch (err) {
        el.innerHTML = `<div class="error-msg">Virhe: ${err.message}</div>`;
    }
}

async function loadUpcoming(league) {
    if (league.isLiiga) { return loadLiigaUpcoming(league); }
    const el = document.getElementById('upcoming');
    try {
        const from = new Date(), to = new Date();
        to.setDate(to.getDate() + 35);
        const events = await fetchMatches(league, from, to);
        renderEvents(events.filter(e => e.competitions[0].status.type.state === 'pre'), 'upcoming', true, league);
    } catch (err) {
        el.innerHTML = `<div class="error-msg">Virhe: ${err.message}</div>`;
    }
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const initialLeague = LEAGUES['pl'];
loadResults(initialLeague);
loadUpcoming(initialLeague);
loadStandings(initialLeague);
</script>

</body>
</html>
