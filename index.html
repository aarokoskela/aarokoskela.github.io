<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tulospalvelu</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent:      #0ea5e9;
            --fpl-color:   #7c3aed;
            --bg:          #f0f9ff;
            --card-bg:     #ffffff;
            --card-border: rgba(0,0,0,0.07);
            --muted:       #64748b;
            --text:        #0f172a;
            --bar-home:    #0ea5e9;
            --bar-away:    #ef4444;
            --sidebar-bg:  #0c4a6e;
            --panel-bg:    #e0f2fe;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', 'Segoe UI', sans-serif;
            background: #f0f9ff;
            background-image:
                radial-gradient(ellipse 80% 50% at 70% -10%, rgba(14,165,233,0.1) 0%, transparent 55%),
                radial-gradient(ellipse 50% 40% at 5% 100%, rgba(14,165,233,0.06) 0%, transparent 45%);
            background-attachment: fixed;
            color: var(--text);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        /* ‚îÄ‚îÄ Top bar ‚îÄ‚îÄ */
        .topbar {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(255,255,255,0.92);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(0,0,0,0.07);
            box-shadow: 0 1px 18px rgba(0,0,0,0.06);
            height: 52px;
            display: flex;
            align-items: center;
        }

        .topbar-inner {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 22px;
            width: 100%;
            display: flex;
            align-items: center;
        }

        .topbar-brand {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .topbar-logo {
            width: 32px; height: 32px;
            background: linear-gradient(145deg, #083756, #0ea5e9);
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1em; font-weight: 900; color: #fff;
            box-shadow: 0 3px 12px rgba(14,165,233,0.45), inset 0 1px 0 rgba(255,255,255,0.15);
            letter-spacing: -0.5px;
            flex-shrink: 0;
            user-select: none;
        }

        .topbar-brand-label { display: flex; align-items: baseline; gap: 5px; }

        .tb-name {
            font-size: 1.02em;
            font-weight: 800;
            letter-spacing: -0.4px;
            background: linear-gradient(135deg, #083756 10%, #0ea5e9);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .tb-suffix {
            font-size: 0.9em;
            font-weight: 500;
            color: var(--muted);
            letter-spacing: -0.1px;
        }

        .lnav-label {
            font-size: 0.58em;
            text-transform: uppercase;
            letter-spacing: 1.8px;
            color: var(--muted);
            font-weight: 700;
            padding-right: 6px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .lnav-sep {
            width: 1px;
            height: 32px;
            background: rgba(0,0,0,0.1);
            margin: 0 10px;
            flex-shrink: 0;
        }

        /* ‚îÄ‚îÄ League buttons (chip style) ‚îÄ‚îÄ */
        .league-btn {
            display: inline-flex;
            align-items: center;
            gap: 7px;
            padding: 7px 14px;
            background: rgba(0,0,0,0.04);
            border: 1.5px solid transparent;
            border-radius: 40px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.8em;
            font-weight: 600;
            color: var(--muted);
            white-space: nowrap;
            transition: all 0.2s;
            flex-shrink: 0;
            line-height: 1;
        }

        .league-btn:hover {
            background: rgba(14,165,233,0.09);
            color: var(--accent);
            border-color: rgba(14,165,233,0.2);
        }

        .league-btn.active {
            background: linear-gradient(135deg, #0c4a6e, #0ea5e9);
            color: #fff;
            border-color: transparent;
            box-shadow: 0 3px 12px rgba(14,165,233,0.35);
        }

        .lc-logo {
            width: 20px;
            height: 20px;
            object-fit: contain;
            flex-shrink: 0;
        }

        /* ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ */
        .tabs {
            max-width: 900px;
            margin: 22px auto 0;
            padding: 0 22px;
            display: flex;
            border-bottom: 1.5px solid rgba(0,0,0,0.07);
        }

        .tab-btn {
            background: transparent;
            border: none;
            border-bottom: 2.5px solid transparent;
            margin-bottom: -1.5px;
            color: var(--muted);
            padding: 11px 20px;
            cursor: pointer;
            font-size: 0.84em;
            font-weight: 500;
            font-family: inherit;
            transition: color 0.2s, border-color 0.2s;
            white-space: nowrap;
            letter-spacing: 0.05px;
        }

        .tab-btn:hover { color: var(--text); }

        .tab-btn.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
            font-weight: 700;
        }

        /* ‚îÄ‚îÄ Container ‚îÄ‚îÄ */
        .container {
            max-width: 900px;
            margin: 24px auto;
            padding: 0 22px;
            width: 100%;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* ‚îÄ‚îÄ Loading ‚îÄ‚îÄ */
        .loading {
            text-align: center;
            padding: 72px 20px;
            color: var(--muted);
            font-size: 0.9em;
        }

        .spinner {
            width: 34px; height: 34px;
            border: 3px solid #bae6fd;
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.75s linear infinite;
            margin: 0 auto 16px;
        }

        .spinner-sm {
            width: 20px; height: 20px;
            border: 2px solid #bae6fd;
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.75s linear infinite;
            margin: 16px auto;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* ‚îÄ‚îÄ Section info / headers ‚îÄ‚îÄ */
        .section-info {
            font-size: 0.72em;
            color: var(--muted);
            text-align: center;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 500;
        }

        .matchday-header {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.7em;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--muted);
            margin: 26px 0 10px;
            font-weight: 600;
        }

        .matchday-header::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--card-border);
        }

        /* ‚îÄ‚îÄ Match card ‚îÄ‚îÄ */
        .match-card {
            background: rgba(255,255,255,0.92);
            border: 1px solid rgba(14,165,233,0.09);
            border-radius: 22px;
            padding: 13px 20px;
            margin-bottom: 10px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03), 0 6px 18px rgba(0,0,0,0.055);
            backdrop-filter: blur(12px);
            transition: box-shadow 0.25s, transform 0.22s, border-color 0.25s;
        }

        .match-card.has-btns { cursor: pointer; }

        .match-card.has-btns:hover {
            box-shadow: 0 4px 32px rgba(14,165,233,0.18), 0 1px 4px rgba(0,0,0,0.04);
            transform: translateY(-2px);
            border-color: rgba(14,165,233,0.28);
        }

        .match-card.panel-open {
            box-shadow: 0 4px 32px rgba(14,165,233,0.18), 0 1px 4px rgba(0,0,0,0.04);
            border-color: rgba(14,165,233,0.3);
        }

        /* ‚îÄ‚îÄ Match meta & teams ‚îÄ‚îÄ */
        .match-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.72em;
            color: var(--muted);
            margin-bottom: 10px;
            gap: 8px;
            font-weight: 500;
        }
        .match-start-time {
            font-size: 1em;
            font-weight: 600;
            color: var(--muted);
            opacity: 0.85;
        }

        .match-status {
            font-size: 0.76em;
            font-weight: 700;
            padding: 3px 10px;
            border-radius: 20px;
            flex-shrink: 0;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .status-ft   { background: #dbeafe; color: #1d4ed8; }
        .status-live { background: #fee2e2; color: #dc2626; animation: pulse 1.2s infinite; }
        .status-pre  { background: #e0f2fe; color: var(--accent); border: 1px solid #bae6fd; }

        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.55} }

        .match-teams {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .team {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            gap: 8px;
            min-width: 0;
        }

        .team-logo {
            width: 48px; height: 48px;
            background: linear-gradient(145deg, #f8fcff, #e4f1fb);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.09), inset 0 1px 3px rgba(255,255,255,0.9);
            flex-shrink: 0;
            border: 1.5px solid rgba(14,165,233,0.1);
        }

        .team-logo img {
            width: 28px; height: 28px;
            object-fit: contain;
        }

        .team-name {
            font-size: 0.82em;
            font-weight: 600;
            text-align: center;
            line-height: 1.3;
            color: var(--text);
        }

        .score-block {
            flex-shrink: 0;
            text-align: center;
            min-width: 82px;
        }

        .score-pill {
            background: linear-gradient(145deg, #083756, #0c4a6e 40%, #0ea5e9);
            border-radius: 18px;
            padding: 9px 18px;
            display: inline-block;
            box-shadow: 0 4px 18px rgba(14,165,233,0.35), 0 2px 6px rgba(0,0,0,0.12), inset 0 1px 0 rgba(255,255,255,0.13);
            min-width: 76px;
        }

        .score {
            font-size: 1.65em;
            font-weight: 900;
            color: #fff;
            letter-spacing: 4px;
            line-height: 1;
            text-shadow: 0 1px 4px rgba(0,0,0,0.2);
        }

        .score-detail {
            font-size: 0.68em;
            color: rgba(255,255,255,0.6);
            margin-top: 3px;
            font-weight: 500;
        }

        .upcoming-block {
            background: rgba(14,165,233,0.07);
            border: 1.5px solid rgba(14,165,233,0.22);
            border-radius: 18px;
            padding: 9px 18px;
            display: inline-block;
            min-width: 76px;
            box-shadow: 0 2px 8px rgba(14,165,233,0.1), inset 0 1px 2px rgba(255,255,255,0.8);
        }

        .upcoming-time {
            font-size: 1.3em;
            font-weight: 800;
            color: var(--accent);
            letter-spacing: -0.5px;
        }

        .upcoming-vs {
            font-size: 0.72em;
            color: var(--muted);
            margin-top: 3px;
            font-weight: 500;
        }

        /* ‚îÄ‚îÄ Detail tab row ‚îÄ‚îÄ */
        .detail-tab-row {
            display: flex;
            gap: 4px;
            margin-bottom: 16px;
            padding: 4px;
            background: rgba(0,0,0,0.04);
            border-radius: 12px;
            width: fit-content;
        }

        .detail-tab-btn {
            background: transparent;
            border: none;
            padding: 6px 16px;
            border-radius: 9px;
            cursor: pointer;
            font-size: 0.74em;
            font-weight: 600;
            color: var(--muted);
            transition: all 0.18s;
            font-family: inherit;
            white-space: nowrap;
        }

        .detail-tab-btn:hover { background: rgba(255,255,255,0.7); color: var(--text); }

        .detail-tab-btn.active {
            background: var(--accent);
            color: #fff;
            box-shadow: 0 2px 8px rgba(14,165,233,0.35);
        }

        .detail-tab-btn.fpl-tab.active {
            background: var(--fpl-color);
            box-shadow: 0 2px 8px rgba(124,58,237,0.35);
        }

        .panel-content { display: none; }
        .panel-content.active { display: block; }

        /* ‚îÄ‚îÄ Stats panel ‚îÄ‚îÄ */
        .detail-panel {
            display: none;
            margin-top: 14px;
            padding: 16px 18px;
            border-top: 1px solid rgba(14,165,233,0.08);
            background: linear-gradient(160deg, rgba(240,249,255,0.85), rgba(248,252,255,0.9));
            backdrop-filter: blur(10px);
            border-radius: 0 0 18px 18px;
            animation: fadeDown 0.2s ease;
        }

        .detail-panel.panel-open { display: block; }

        @keyframes fadeDown {
            from { opacity: 0; transform: translateY(-4px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .details-section { margin-bottom: 22px; }
        .details-section:last-child { margin-bottom: 0; }

        .details-title {
            font-size: 0.68em;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--accent);
            margin-bottom: 12px;
            padding-bottom: 6px;
            border-bottom: 2px solid #bae6fd;
            font-weight: 700;
        }

        .details-title.fpl-title { color: var(--fpl-color); border-bottom-color: #ede9fe; }

        /* ‚îÄ‚îÄ Timeline ‚îÄ‚îÄ */
        .timeline {
            display: flex;
            flex-direction: column;
            gap: 0;
            padding: 4px 0;
        }

        .tl-event {
            display: grid;
            grid-template-columns: 1fr 1fr;
            font-size: 0.8em;
            border-radius: 7px;
            transition: background 0.14s;
        }

        .tl-event:hover { background: rgba(14,165,233,0.05); }

        .tl-home-col {
            display: flex;
            align-items: flex-start;
            gap: 7px;
            padding: 5px 10px 5px 4px;
            border-right: 1px solid rgba(0,0,0,0.06);
        }

        .tl-away-col {
            display: flex;
            align-items: flex-start;
            justify-content: flex-end;
            gap: 7px;
            padding: 5px 4px 5px 10px;
        }

        .tl-marker {
            flex-shrink: 0;
            line-height: 1.35;
            padding-top: 1px;
            white-space: nowrap;
            font-size: 1.05em;
        }

        .tl-score-chip {
            display: inline-flex;
            align-items: center;
            background: rgba(14,165,233,0.1);
            border: 1px solid rgba(14,165,233,0.22);
            border-radius: 6px;
            padding: 1px 7px;
            font-size: 0.86em;
            font-weight: 700;
            letter-spacing: -0.2px;
            color: #0369a1;
            white-space: nowrap;
        }

        .tl-event-body {
            display: flex;
            flex-direction: column;
            gap: 1px;
            min-width: 0;
            flex: 1;
        }

        .tl-away-col .tl-event-body {
            text-align: right;
            align-items: flex-end;
        }

        .tl-player {
            font-weight: 600;
            color: var(--text);
            line-height: 1.3;
            overflow-wrap: break-word;
            word-break: break-word;
        }

        .tl-player.tl-sub-off {
            font-weight: 500;
            color: var(--muted);
        }

        .tl-assist {
            font-size: 0.82em;
            color: var(--muted);
            overflow-wrap: break-word;
            word-break: break-word;
        }

        .tl-min {
            font-size: 0.66em;
            color: #94a3b8;
            font-weight: 500;
        }

        .tl-period {
            font-size: 0.68em;
            text-align: center;
            padding: 10px 0 5px;
            border-top: 1px solid rgba(0,0,0,0.06);
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            font-weight: 700;
            color: var(--accent);
            position: relative;
            z-index: 1;
        }

        .tl-period:first-child { border-top: none; margin-top: 0; padding-top: 2px; }
        .tl-period-label {
            background: rgba(240,249,255,0.95);
            padding: 2px 10px;
            border-radius: 20px;
            border: 1px solid rgba(14,165,233,0.15);
            display: inline-block;
        }

        .no-events {
            font-size: 0.82em;
            color: var(--muted);
            text-align: center;
            padding: 12px;
        }

        /* ‚îÄ‚îÄ Match stats bars ‚îÄ‚îÄ */
        .stats-teams {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
            margin-bottom: 14px;
            font-size: 0.78em;
            font-weight: 700;
        }

        .stats-teams .home-label { text-align: left;  color: var(--bar-home); }
        .stats-teams .away-label { text-align: right; color: var(--bar-away); }

        .stat-row {
            display: grid;
            grid-template-columns: 2.8rem 1fr 2.8rem;
            gap: 8px;
            align-items: center;
            margin: 6px 0;
            font-size: 0.8em;
        }

        .stat-val { font-weight: 700; font-size: 0.95em; }
        .stat-val.home-v { text-align: right; color: var(--bar-home); }
        .stat-val.away-v { text-align: left;  color: var(--bar-away); }

        .stat-center { display: flex; flex-direction: column; align-items: center; gap: 3px; }

        .stat-bar-track {
            width: 100%;
            height: 6px;
            display: flex;
            border-radius: 4px;
            overflow: hidden;
            background: rgba(0,0,0,0.07);
        }

        .bar-h { height: 100%; background: var(--bar-home); transition: width 0.5s ease; }
        .bar-a { height: 100%; background: var(--bar-away); transition: width 0.5s ease; }

        .stat-label { font-size: 0.76em; color: var(--muted); white-space: nowrap; font-weight: 500; }

        /* ‚îÄ‚îÄ FPL table ‚îÄ‚îÄ */
        .fpl-section { margin-bottom: 20px; }
        .fpl-section:last-child { margin-bottom: 0; }

        .fpl-team-name {
            font-size: 0.75em;
            font-weight: 700;
            color: var(--fpl-color);
            background: #f5f3ff;
            border: 1.5px solid #ddd6fe;
            padding: 4px 12px;
            border-radius: 20px;
            margin-bottom: 10px;
            display: inline-block;
            letter-spacing: 0.3px;
        }

        .fpl-table { display: flex; flex-direction: column; gap: 1px; }

        .fpl-row {
            display: grid;
            grid-template-columns: 34px 1fr 36px 26px 26px 26px 26px 26px 34px;
            gap: 4px;
            font-size: 0.76em;
            padding: 5px 4px;
            border-radius: 6px;
            align-items: center;
        }

        .fpl-row:not(.fpl-hdr):hover { background: rgba(124,58,237,0.05); }

        .fpl-hdr {
            font-size: 0.68em;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            padding-bottom: 6px;
            border-bottom: 1.5px solid #e5e7eb;
            margin-bottom: 2px;
            font-weight: 600;
        }

        .fpl-pos {
            font-size: 0.8em;
            font-weight: 700;
            text-align: center;
            padding: 2px 3px;
            border-radius: 4px;
        }

        .fpl-pos-gk  { background: #fef9c3; color: #713f12; }
        .fpl-pos-def { background: #dbeafe; color: #1e40af; }
        .fpl-pos-mid { background: #ede9fe; color: #5b21b6; }
        .fpl-pos-fwd { background: #fee2e2; color: #991b1b; }

        .fpl-name {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .fpl-name.row-starred { font-weight: 700; color: #0369a1; }

        .fpl-num { text-align: center; color: var(--muted); }
        .fpl-num.nonzero { color: var(--text); font-weight: 600; }

        .fpl-pts { text-align: center; font-weight: 800; border-radius: 4px; padding: 2px 1px; }

        .pts-high { color: #0369a1; }
        .pts-med  { color: #7c3aed; }
        .pts-low  { color: var(--muted); }

        /* ‚îÄ‚îÄ Errors ‚îÄ‚îÄ */
        .error-msg {
            text-align: center;
            padding: 56px 20px;
            color: #dc2626;
            font-size: 0.9em;
            line-height: 1.8;
        }

        .details-error {
            text-align: center;
            padding: 16px;
            color: #dc2626;
            font-size: 0.82em;
        }

        /* ‚îÄ‚îÄ Standings ‚îÄ‚îÄ */
        .standings-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }

        .standings-table th {
            text-align: center;
            padding: 11px 6px 9px;
            font-size: 0.68em;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            color: var(--muted);
            border-bottom: 1.5px solid rgba(14,165,233,0.12);
            font-weight: 700;
            background: rgba(240,249,255,0.6);
        }

        .standings-table th:nth-child(2) { text-align: left; }

        .standings-table td {
            padding: 10px 6px;
            text-align: center;
            border-bottom: 1px solid rgba(0,0,0,0.04);
        }

        .standings-table tbody tr:nth-child(even) td { background: rgba(240,249,255,0.4); }
        .standings-table td:nth-child(2) { text-align: left; }
        .standings-table tr:last-child td { border-bottom: none; }
        .standings-table tr:hover td { background: rgba(14,165,233,0.06) !important; }

        .st-rank { font-weight: 700; color: var(--muted); width: 28px; font-size: 0.9em; }

        .st-team {
            display: flex;
            align-items: center;
            gap: 9px;
            font-weight: 600;
        }

        .st-team img {
            width: 22px; height: 22px;
            object-fit: contain;
            flex-shrink: 0;
        }

        .st-pts { font-weight: 800; color: var(--accent); }
        .st-gd  { font-weight: 600; }

        .zone-bar {
            display: inline-block;
            width: 4px;
            height: 20px;
            border-radius: 3px;
            vertical-align: middle;
            margin-right: 4px;
            flex-shrink: 0;
        }

        .standings-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 14px;
            margin-top: 18px;
            font-size: 0.74em;
            color: var(--muted);
        }

        .legend-item { display: flex; align-items: center; gap: 6px; }

        .legend-dot { width: 10px; height: 10px; border-radius: 3px; flex-shrink: 0; }

        /* ‚îÄ‚îÄ Player stats tab ‚îÄ‚îÄ */
        .ps-section { margin-bottom: 22px; }
        .ps-section-title {
            font-size: 0.78em; font-weight: 700; text-transform: uppercase;
            letter-spacing: 1px; color: var(--muted); margin: 0 0 8px 4px;
        }
        .ps-player { display: block; font-weight: 600; }
        .ps-team   { display: block; font-size: 0.76em; color: var(--muted); }
        .ps-val    { font-weight: 800; color: var(--accent); min-width: 30px; }
        .ps-apps   { color: var(--muted); }

        /* ‚îÄ‚îÄ Team stats panel ‚îÄ‚îÄ */
        .st-row { cursor: pointer; }
        .st-row:hover td { background: #e0f2fe !important; }
        .st-row.st-active td { background: #bae6fd !important; }

        .team-stats-panel {
            margin-top: 12px;
            animation: fadeDown 0.2s ease;
        }

        .team-stats-header {
            display: flex;
            align-items: center;
            gap: 9px;
            font-weight: 700;
            font-size: 0.88em;
            color: var(--text);
            margin-bottom: 10px;
            padding: 0 2px;
        }

        .team-stats-header img {
            width: 22px; height: 22px;
            object-fit: contain;
            flex-shrink: 0;
        }

        .team-stat-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .team-stat-card {
            background: rgba(255,255,255,0.85);
            border-radius: 16px;
            padding: 16px 10px 13px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.07), 0 1px 3px rgba(0,0,0,0.04);
            border: 1px solid rgba(14,165,233,0.1);
            text-align: center;
            backdrop-filter: blur(8px);
        }

        .team-stat-card-label {
            font-size: 0.6em;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--muted);
            font-weight: 600;
            margin-bottom: 8px;
        }

        .team-stat-value {
            font-size: 1.7em;
            font-weight: 800;
            color: var(--accent);
            line-height: 1;
            margin-bottom: 5px;
        }

        .team-stat-name {
            font-size: 0.73em;
            font-weight: 600;
            color: var(--text);
            line-height: 1.3;
        }

        @media (max-width: 520px) {
            .team-stat-card { padding: 10px 6px; }
            .team-stat-value { font-size: 1.35em; }
            .team-stat-name { font-size: 0.65em; }
        }

        /* ‚îÄ‚îÄ Live indicator ‚îÄ‚îÄ */
        .live-banner {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(254,226,226,0.6);
            border: 1px solid rgba(252,165,165,0.5);
            border-radius: 16px;
            padding: 10px 18px;
            margin-bottom: 18px;
            font-size: 0.79em;
            color: #dc2626;
            font-weight: 600;
            backdrop-filter: blur(8px);
            box-shadow: 0 2px 8px rgba(220,38,38,0.1);
        }

        .live-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: #dc2626;
            animation: pulse 1.2s infinite;
            flex-shrink: 0;
        }

        /* ‚îÄ‚îÄ Unavailable notice ‚îÄ‚îÄ */
        .unavailable-msg {
            text-align: center;
            padding: 72px 20px;
            color: var(--muted);
            line-height: 1.8;
        }

        .unavailable-msg .um-icon { font-size: 2.8em; margin-bottom: 16px; }
        .unavailable-msg h3 { color: var(--text); margin-bottom: 8px; font-size: 1.05em; font-weight: 700; }
        .unavailable-msg p { font-size: 0.88em; max-width: 340px; margin: 0 auto; }

        /* ‚îÄ‚îÄ Mobile ‚îÄ‚îÄ */
        @media (max-width: 768px) {
            .topbar-inner { padding: 0 14px; }
            .tabs { padding: 0 8px; overflow-x: auto; scrollbar-width: none; margin-top: 14px; }
            .tabs::-webkit-scrollbar { display: none; }
            .tab-btn { padding: 10px 12px; font-size: 0.8em; }
            .container { margin: 16px auto; padding: 0 12px; }

            /* Compact match cards on mobile */
            .match-card {
                padding: 6px 12px;
                margin-bottom: 2px;
                border-radius: 14px;
            }
            .match-meta {
                font-size: 0.65em;
                margin-bottom: 4px;
            }
            .match-teams { gap: 4px; }
            .team {
                flex-direction: row;
                gap: 6px;
                align-items: center;
            }
            .match-teams .team:last-child { flex-direction: row-reverse; }
            .match-teams .team:last-child .team-name { text-align: right; }
            .team-logo { width: 32px; height: 32px; border-radius: 50%; }
            .team-logo img { width: 20px; height: 20px; }
            .team-name { font-size: 0.72em; text-align: left; }
            .score-block { min-width: 76px; }
            .score-pill { padding: 5px 10px; min-width: 68px; }
            .score { font-size: 1.3em; letter-spacing: 2px; }
            .score-detail { font-size: 0.6em; margin-top: 2px; }
            .upcoming-block { padding: 5px 10px; min-width: 68px; }
            .upcoming-time { font-size: 1.1em; }
            .upcoming-vs { font-size: 0.66em; margin-top: 1px; }
        }

        @media (max-width: 520px) {
            .tl-event { font-size: 0.74em; }
            .fpl-row { grid-template-columns: 30px 1fr 32px 22px 22px 22px 22px 22px 30px; font-size: 0.7em; }
        }

        /* ‚îÄ‚îÄ Lineup Lists ‚îÄ‚îÄ */
        .lineup-lists {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        @media (max-width: 600px) {
            .lineup-lists { grid-template-columns: 1fr; }
        }

        .lu-team {
            background: rgba(14,165,233,0.03);
            border-radius: 12px;
            border: 1px solid rgba(0,0,0,0.07);
            padding: 12px;
        }

        .lu-team-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-left: 3px solid;
            padding-left: 10px;
            margin-bottom: 12px;
        }

        .lu-team-name {
            font-size: 0.82em;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .lu-formation {
            font-size: 0.72em;
            font-weight: 700;
            color: var(--muted);
            background: rgba(0,0,0,0.06);
            padding: 2px 8px;
            border-radius: 8px;
            letter-spacing: 1px;
        }

        .lu-section-title {
            font-size: 0.68em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--muted);
            margin: 10px 0 5px;
            padding-bottom: 4px;
            border-bottom: 1px solid rgba(0,0,0,0.07);
        }

        .lu-pos-label, .lu-line-label {
            font-size: 0.63em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: #94a3b8;
            margin: 6px 0 2px;
            padding-left: 2px;
        }

        .lu-player {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 3px 2px;
            border-bottom: 1px solid rgba(0,0,0,0.04);
            font-size: 0.8em;
        }

        .lu-player:last-child { border-bottom: none; }

        .lu-player.lu-sub { opacity: 0.72; }

        .lu-player.lu-starter-gk {
            background: rgba(14,165,233,0.07);
            border-radius: 7px;
            border-bottom: none;
            margin-bottom: 3px;
            padding: 5px 7px;
        }

        .lu-jersey {
            width: 20px;
            text-align: center;
            font-weight: 700;
            font-size: 0.88em;
            color: var(--muted);
            flex-shrink: 0;
        }

        .lu-pos-tag {
            font-size: 0.68em;
            font-weight: 700;
            padding: 1px 5px;
            border-radius: 4px;
            flex-shrink: 0;
            min-width: 24px;
            text-align: center;
            letter-spacing: 0.2px;
        }

        .lu-name {
            flex: 1;
            font-size: 0.9em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .lu-starter-badge {
            font-size: 0.6em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            background: #0ea5e9;
            color: #fff;
            padding: 1px 6px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .lu-sub-mark {
            font-size: 0.68em;
            font-weight: 700;
            flex-shrink: 0;
            white-space: nowrap;
        }

        .lu-sub-out { color: #ef4444; }
        .lu-sub-in  { color: #22c55e; }

        /* Date navigation */
        .date-nav { display:flex; align-items:center; justify-content:space-between; margin:12px 0 16px; gap:8px; }
        .date-nav-btn { background:rgba(14,165,233,0.08); border:1px solid rgba(14,165,233,0.2);
            border-radius:50%; width:36px; height:36px; cursor:pointer; font-size:1.1em;
            color:var(--accent); display:flex; align-items:center; justify-content:center;
            transition:background 0.2s; flex-shrink:0; }
        .date-nav-btn:hover { background:rgba(14,165,233,0.18); }
        .date-nav-center { flex:1; text-align:center; display:flex; flex-direction:column; align-items:center; gap:4px; }
        .date-nav-label { font-size:0.88em; font-weight:700; color:var(--text); text-transform:capitalize; }
        .today-btn { background:transparent; border:1px solid rgba(14,165,233,0.3); border-radius:10px;
            padding:2px 10px; font-size:0.7em; font-weight:600; color:var(--accent);
            cursor:pointer; font-family:inherit; }
        .today-btn:hover { background:rgba(14,165,233,0.08); }

        /* ‚îÄ‚îÄ Date picker ‚îÄ‚îÄ */
        .date-picker-wrap { position:relative; }

        .date-label-btn {
            background: none; border: none; cursor: pointer; font-family: inherit;
            display: flex; align-items: center; gap: 5px;
            padding: 4px 10px; border-radius: 10px;
            transition: background 0.15s;
        }
        .date-label-btn:hover { background: rgba(14,165,233,0.08); }

        .dp-chevron {
            font-size: 0.75em; color: var(--muted);
            transition: transform 0.2s;
            line-height: 1; display: inline-block;
        }
        .date-label-btn.active .dp-chevron { transform: rotate(180deg); }

        .date-picker-popup {
            display: none;
            position: absolute;
            top: calc(100% + 8px);
            left: 50%; transform: translateX(-50%);
            background: #fff;
            border: 1px solid rgba(14,165,233,0.18);
            border-radius: 20px;
            box-shadow: 0 8px 40px rgba(0,0,0,0.13), 0 2px 8px rgba(0,0,0,0.07);
            padding: 16px;
            z-index: 200;
            width: 272px;
            animation: fadeDown 0.18s ease;
        }
        .date-picker-popup.open { display: block; }

        .dp-header {
            display: flex; align-items: center;
            justify-content: space-between; margin-bottom: 10px;
        }
        .dp-month-label {
            font-size: 0.84em; font-weight: 700; color: var(--text);
            text-transform: capitalize;
        }
        .dp-nav-btn {
            background: none; border: none; cursor: pointer;
            width: 28px; height: 28px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: var(--accent); font-size: 1em;
            transition: background 0.15s; flex-shrink: 0;
        }
        .dp-nav-btn:hover { background: rgba(14,165,233,0.1); }

        .dp-grid {
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px;
        }
        .dp-weekday {
            font-size: 0.6em; font-weight: 700; text-align: center;
            color: var(--muted); padding: 2px 0 7px;
            text-transform: uppercase; letter-spacing: 0.4px;
        }
        .dp-day {
            aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
            font-size: 0.78em; border-radius: 50%; cursor: pointer;
            border: none; background: none; font-family: inherit;
            font-weight: 500; color: var(--text); transition: background 0.13s, color 0.13s;
        }
        .dp-day:not(.dp-empty):hover { background: rgba(14,165,233,0.1); color: var(--accent); }
        .dp-day.dp-today { color: var(--accent); font-weight: 800; }
        .dp-day.dp-selected {
            background: linear-gradient(135deg, #0c4a6e, #0ea5e9);
            color: #fff !important; font-weight: 700;
            box-shadow: 0 2px 8px rgba(14,165,233,0.35);
        }
        .dp-day.dp-other { color: #94a3b8; }
        .dp-day.dp-other:hover { background: rgba(14,165,233,0.07); color: var(--accent); }
        .dp-day.dp-disabled { color: #e2e8f0 !important; cursor: default; pointer-events: none; }
        .dp-nav-btn:disabled { opacity: 0.25; cursor: default; pointer-events: none; }
        .date-nav-btn:disabled { opacity: 0.28; cursor: default; }
        .date-nav-btn:disabled:hover { background: rgba(14,165,233,0.08); transform: none; }

        /* Tab-sis√§inen liigavalitsin */
        .tab-league-picker {
            overflow-x: auto;
            scrollbar-width: none;
            margin: 12px -22px 18px;
            padding: 0 22px;
        }
        .tab-league-picker::-webkit-scrollbar { display: none; }
        .tlp-inner {
            display: flex;
            align-items: center;
            gap: 6px;
            width: max-content;
            min-width: 100%;
            padding-bottom: 4px;
        }

        /* League section in day view */
        .league-section { margin-bottom:20px; }
        .league-section-header { display:flex; align-items:center; gap:8px; font-size:0.75em;
            text-transform:uppercase; letter-spacing:1.8px; color:var(--text);
            margin:28px 0 8px; font-weight:800; }
        .league-section-header img { width:20px; height:20px; object-fit:contain; flex-shrink:0; }
        .league-section-header::after { content:''; flex:1; height:2px;
            background:linear-gradient(90deg, var(--accent), transparent); border-radius:2px; }

        /* ‚îÄ‚îÄ Ipa & ManU kuukausi/p√§iv√§-otsikot ‚îÄ‚îÄ */
        .ipa-month-header {
            font-size: 0.75em;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1.8px;
            color: var(--text);
            margin: 28px 0 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .ipa-month-header::after {
            content: '';
            flex: 1;
            height: 2px;
            background: linear-gradient(90deg, var(--accent), transparent);
            border-radius: 2px;
        }
        .ipa-day-label {
            font-size: 0.68em;
            font-weight: 600;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 1.2px;
            margin: 10px 0 3px;
            padding-left: 2px;
        }

        /* ‚îÄ‚îÄ Ipa & ManU toggle ‚îÄ‚îÄ */
        .view-toggle {
            display: flex;
            gap: 8px;
            margin: 20px 0 18px;
            justify-content: center;
        }
        .view-toggle-btn {
            padding: 8px 22px;
            border-radius: 40px;
            border: 1.5px solid rgba(0,0,0,0.09);
            background: rgba(0,0,0,0.04);
            color: var(--muted);
            font-family: inherit;
            font-size: 0.83em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .view-toggle-btn:hover {
            background: rgba(14,165,233,0.09);
            color: var(--accent);
            border-color: rgba(14,165,233,0.2);
        }
        .view-toggle-btn.active {
            background: linear-gradient(135deg, #0c4a6e, #0ea5e9);
            color: #fff;
            border-color: transparent;
            box-shadow: 0 3px 12px rgba(14,165,233,0.35);
        }
    </style>
</head>
<body>

<!-- ‚îÄ‚îÄ Top bar ‚îÄ‚îÄ -->
<header class="topbar">
    <div class="topbar-inner">
        <span class="topbar-brand">
            <span class="topbar-logo">O</span>
            <span class="tb-name">Osmoscore</span>
        </span>
    </div>
</header>

<!-- ‚îÄ‚îÄ Page content ‚îÄ‚îÄ -->
<div class="page-content">

    <!-- Tabs -->
    <div class="tabs">
        <button class="tab-btn active" data-tab="day"        onclick="showTab('day',        this)">P√§iv√§n ottelut</button>
        <button class="tab-btn"        data-tab="standings"   onclick="showTab('standings',   this)">Sarjataulukko</button>
        <button class="tab-btn"        data-tab="playerstats" onclick="showTab('playerstats', this)">Pelaajatilastot</button>
        <button class="tab-btn"        data-tab="ipa-manu"    onclick="showTab('ipa-manu',    this)">Ipan ja ManU:n pelit</button>
    </div>

    <!-- Tab content -->
    <div class="container">
        <div id="day" class="tab-content active">
            <div class="date-nav" id="date-nav">
                <button class="date-nav-btn" onclick="changeDay(-1)">&#8592;</button>
                <div class="date-nav-center">
                    <div class="date-picker-wrap">
                        <button class="date-label-btn" onclick="toggleDatePicker()">
                            <span class="date-nav-label" id="day-label"></span>
                            <span class="dp-chevron">‚ñæ</span>
                        </button>
                        <div class="date-picker-popup" id="date-picker-popup"></div>
                    </div>
                    <button class="today-btn" onclick="goToToday()">T√§n√§√§n</button>
                </div>
                <button class="date-nav-btn" onclick="changeDay(1)">&#8594;</button>
            </div>
            <div id="day-content">
                <div class="loading"><div class="spinner"></div>Ladataan...</div>
            </div>
        </div>
        <div id="standings" class="tab-content">
            <div class="tab-league-picker">
                <div class="tlp-inner">
                    <span class="lnav-label">Jalkapallo</span>
                    <button class="league-btn active" data-league="pl" onclick="switchLeague('pl')">
                        <img src="https://a.espncdn.com/i/leaguelogos/soccer/500/23.png" class="lc-logo" alt="">Premier League</button>
                    <button class="league-btn" data-league="laliga" onclick="switchLeague('laliga')">
                        <img src="https://a.espncdn.com/i/leaguelogos/soccer/500/15.png" class="lc-logo" alt="">La Liga</button>
                    <button class="league-btn" data-league="bl" onclick="switchLeague('bl')">
                        <img src="https://a.espncdn.com/i/leaguelogos/soccer/500/10.png" class="lc-logo" alt="">Bundesliga</button>
                    <button class="league-btn" data-league="seriea" onclick="switchLeague('seriea')">
                        <img src="https://a.espncdn.com/i/leaguelogos/soccer/500/12.png" class="lc-logo" alt="">Serie A</button>
                    <button class="league-btn" data-league="ligue1" onclick="switchLeague('ligue1')">
                        <img src="https://a.espncdn.com/i/leaguelogos/soccer/500/9.png" class="lc-logo" alt="">Ligue 1</button>
                    <button class="league-btn" data-league="ucl" onclick="switchLeague('ucl')">
                        <img src="https://a.espncdn.com/i/leaguelogos/soccer/500/2.png" class="lc-logo" alt="">Champions League</button>
                    <div class="lnav-sep"></div>
                    <span class="lnav-label">J√§√§kiekko</span>
                    <button class="league-btn" data-league="nhl" onclick="switchLeague('nhl')">
                        <img src="https://a.espncdn.com/i/leaguelogos/hockey/500/1.png" class="lc-logo" alt="">NHL</button>
                    <button class="league-btn" data-league="liiga" onclick="switchLeague('liiga')">
                        <span style="font-size:1.1em;line-height:1">üèí</span>Liiga</button>
                </div>
            </div>
            <div id="standings-body">
                <div class="loading"><div class="spinner"></div>Ladataan...</div>
            </div>
        </div>
        <div id="playerstats" class="tab-content">
            <div class="tab-league-picker">
                <div class="tlp-inner">
                    <span class="lnav-label">Jalkapallo</span>
                    <button class="league-btn active" data-league="pl" onclick="switchLeague('pl')">
                        <img src="https://a.espncdn.com/i/leaguelogos/soccer/500/23.png" class="lc-logo" alt="">Premier League</button>
                    <button class="league-btn" data-league="laliga" onclick="switchLeague('laliga')">
                        <img src="https://a.espncdn.com/i/leaguelogos/soccer/500/15.png" class="lc-logo" alt="">La Liga</button>
                    <button class="league-btn" data-league="bl" onclick="switchLeague('bl')">
                        <img src="https://a.espncdn.com/i/leaguelogos/soccer/500/10.png" class="lc-logo" alt="">Bundesliga</button>
                    <button class="league-btn" data-league="seriea" onclick="switchLeague('seriea')">
                        <img src="https://a.espncdn.com/i/leaguelogos/soccer/500/12.png" class="lc-logo" alt="">Serie A</button>
                    <button class="league-btn" data-league="ligue1" onclick="switchLeague('ligue1')">
                        <img src="https://a.espncdn.com/i/leaguelogos/soccer/500/9.png" class="lc-logo" alt="">Ligue 1</button>
                    <button class="league-btn" data-league="ucl" onclick="switchLeague('ucl')">
                        <img src="https://a.espncdn.com/i/leaguelogos/soccer/500/2.png" class="lc-logo" alt="">Champions League</button>
                    <div class="lnav-sep"></div>
                    <span class="lnav-label">J√§√§kiekko</span>
                    <button class="league-btn" data-league="nhl" onclick="switchLeague('nhl')">
                        <img src="https://a.espncdn.com/i/leaguelogos/hockey/500/1.png" class="lc-logo" alt="">NHL</button>
                    <button class="league-btn" data-league="liiga" onclick="switchLeague('liiga')">
                        <span style="font-size:1.1em;line-height:1">üèí</span>Liiga</button>
                </div>
            </div>
            <div id="playerstats-body">
                <div class="loading"><div class="spinner"></div>Ladataan...</div>
            </div>
        </div>
        <div id="ipa-manu" class="tab-content">
            <div class="view-toggle">
                <button class="view-toggle-btn active" id="ipa-upcoming-btn" onclick="switchIpaView('upcoming')">Tulevat ottelut</button>
                <button class="view-toggle-btn"        id="ipa-past-btn"     onclick="switchIpaView('past')">Menneet tulokset</button>
            </div>
            <div class="view-toggle" style="margin-top:0">
                <button class="view-toggle-btn active" id="ipa-filter-both"  onclick="switchIpaFilter('both')">Molemmat</button>
                <button class="view-toggle-btn"        id="ipa-filter-manu"  onclick="switchIpaFilter('manu')">Man United</button>
                <button class="view-toggle-btn"        id="ipa-filter-ilves" onclick="switchIpaFilter('ilves')">Ilves</button>
            </div>
            <div id="ipa-manu-body">
                <div class="loading"><div class="spinner"></div>Ladataan...</div>
            </div>
        </div>
    </div>

</div><!-- /page-content -->

<script>
'use strict';

// ‚îÄ‚îÄ League configurations ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const LEAGUES = {
    pl: {
        key:'pl', sport:'soccer', id:'eng.1',
        name:'Premier League', subtitle:'Englannin Valioliiga \u2014 Ottelutulokset & ohjelma',
        logo:'https://a.espncdn.com/i/leaguelogos/soccer/500/23.png', hasFPL: true
    },
    laliga: {
        key:'laliga', sport:'soccer', id:'esp.1',
        name:'La Liga', subtitle:'Espanjan La Liga \u2014 Ottelutulokset & ohjelma',
        logo:'https://a.espncdn.com/i/leaguelogos/soccer/500/15.png'
    },
    bl: {
        key:'bl', sport:'soccer', id:'ger.1',
        name:'Bundesliga', subtitle:'Saksan Bundesliiga \u2014 Ottelutulokset & ohjelma',
        logo:'https://a.espncdn.com/i/leaguelogos/soccer/500/10.png'
    },
    seriea: {
        key:'seriea', sport:'soccer', id:'ita.1',
        name:'Serie A', subtitle:'Italian Serie A \u2014 Ottelutulokset & ohjelma',
        logo:'https://a.espncdn.com/i/leaguelogos/soccer/500/12.png'
    },
    ligue1: {
        key:'ligue1', sport:'soccer', id:'fra.1',
        name:'Ligue 1', subtitle:'Ranskan Ligue 1 \u2014 Ottelutulokset & ohjelma',
        logo:'https://a.espncdn.com/i/leaguelogos/soccer/500/9.png'
    },
    ucl: {
        key:'ucl', sport:'soccer', id:'uefa.champions',
        name:'Champions League', subtitle:'UEFA Mestareiden liiga \u2014 Ottelutulokset & ohjelma',
        logo:'https://a.espncdn.com/i/leaguelogos/soccer/500/2.png'
    },
    nhl: {
        key:'nhl', sport:'hockey', id:'nhl',
        name:'NHL', subtitle:'National Hockey League \u2014 Ottelutulokset & ohjelma',
        logo:'https://a.espncdn.com/i/leaguelogos/hockey/500/1.png'
    },
    liiga: {
        key:'liiga', sport:'hockey', id:'liiga',
        name:'Liiga', subtitle:'Suomen SM-Liiga \u2014 Ottelutulokset & ohjelma',
        logo:'', isLiiga: true
    },
};

let currentLeagueKey = 'pl';
let currentTab = 'day';
let currentDayDate = (() => { const d = new Date(); d.setHours(0,0,0,0); return d; })();

function getLeague() { return LEAGUES[currentLeagueKey]; }

// ‚îÄ‚îÄ FPL API (CORS proxy) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const FPL_PROXY = 'https://corsproxy.io/?url=';
const FPL_BASE  = 'https://fantasy.premierleague.com/api';

async function fplFetch(path) {
    const url = FPL_BASE + path;
    const res = await fetch(FPL_PROXY + encodeURIComponent(url));
    if (!res.ok) throw new Error(`FPL HTTP ${res.status}`);
    return res.json();
}

let   fplBootstrapCache = null;
let   fplFixturesCache  = null;
const fplEventCache     = {};
const detailCache       = {};

async function getFplBootstrap() {
    if (!fplBootstrapCache) fplBootstrapCache = await fplFetch('/bootstrap-static/');
    return fplBootstrapCache;
}
async function getFplFixtures() {
    if (!fplFixturesCache) fplFixturesCache = await fplFetch('/fixtures/');
    return fplFixturesCache;
}
async function getFplEventLive(gw) {
    if (!fplEventCache[gw]) fplEventCache[gw] = await fplFetch(`/event/${gw}/live/`);
    return fplEventCache[gw];
}

// ESPN team displayName ‚Üí FPL short_name
const ESPN_TO_FPL = {
    'Arsenal':'ARS','Aston Villa':'AVL','AFC Bournemouth':'BOU','Bournemouth':'BOU',
    'Brentford':'BRE','Brighton & Hove Albion':'BHA','Brighton':'BHA',
    'Burnley':'BUR','Chelsea':'CHE','Crystal Palace':'CRY','Everton':'EVE',
    'Fulham':'FUL','Ipswich Town':'IPS','Ipswich':'IPS',
    'Leeds United':'LEE','Leeds':'LEE','Leicester City':'LEI','Leicester':'LEI',
    'Liverpool':'LIV','Manchester City':'MCI','Manchester United':'MUN',
    'Newcastle United':'NEW','Newcastle':'NEW','Nottingham Forest':'NFO',"Nott'm Forest":'NFO',
    'Southampton':'SOU','Sunderland':'SUN','Tottenham Hotspur':'TOT','Spurs':'TOT',
    'West Ham United':'WHU','West Ham':'WHU','Wolverhampton Wanderers':'WOL','Wolves':'WOL',
};
const POS_NAME = { 1:'GK', 2:'DEF', 3:'MID', 4:'FWD' };

// ‚îÄ‚îÄ API URL builders ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function scoreboardUrl(league, from, to) {
    const base = `https://site.api.espn.com/apis/site/v2/sports/${league.sport}/${league.id}/scoreboard`;
    return `${base}?dates=${toESPNDate(from)}-${toESPNDate(to)}&limit=100`;
}
function summaryUrl(league, eventId) {
    return `https://site.api.espn.com/apis/site/v2/sports/${league.sport}/${league.id}/summary?event=${eventId}`;
}
function standingsUrl(league) {
    return `https://site.api.espn.com/apis/v2/sports/${league.sport}/${league.id}/standings`;
}
function teamUrl(league, teamId) {
    return `https://site.api.espn.com/apis/site/v2/sports/${league.sport}/${league.id}/teams/${teamId}`;
}

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fmtDate(iso) {
    return new Date(iso).toLocaleDateString('fi-FI', {
        weekday:'long', day:'numeric', month:'long', year:'numeric'
    });
}
function fmtTime(iso) {
    return new Date(iso).toLocaleTimeString('fi-FI', { hour:'2-digit', minute:'2-digit' });
}
function toESPNDate(d) {
    return `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;
}

// ‚îÄ‚îÄ UI: League / Tab switching ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showTab(tab, btn) {
    // Auto-switch to PL if switching to playerstats with an unsupported league
    if (tab === 'playerstats') {
        const supported = ['pl','laliga','bl','seriea','ligue1','ucl','nhl','liiga'];
        if (!supported.includes(currentLeagueKey)) {
            currentLeagueKey = 'pl';
            document.querySelectorAll('.tab-league-picker .league-btn').forEach(b => {
                b.classList.toggle('active', b.dataset.league === 'pl');
            });
        }
    }

    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(tab).classList.add('active');
    currentTab = tab;

    // Lazy load if still showing spinner
    const el = document.getElementById(tab);
    if (el.querySelector('.loading')) {
        loadTabContent(tab, getLeague());
    }
}

function loadTabContent(tab, league) {
    switch (tab) {
        case 'day':         loadDayView(currentDayDate); break;
        case 'standings':   loadStandings(league);       break;
        case 'playerstats': loadPlayerStats(league);     break;
        case 'ipa-manu':    loadIpaManUTab();             break;
    }
}


function switchLeague(leagueKey) {
    if (leagueKey === currentLeagueKey) return;
    currentLeagueKey = leagueKey;

    // Synkronoi aktiivisuus molemmissa pickereiss√§
    document.querySelectorAll('.tab-league-picker .league-btn').forEach(b => {
        b.classList.toggle('active', b.dataset.league === leagueKey);
    });

    // Lataa nykyisen tabin sis√§lt√∂ uudelleen
    if (currentTab === 'standings' || currentTab === 'playerstats') {
        const bodyId = currentTab + '-body';
        document.getElementById(bodyId).innerHTML =
            '<div class="loading"><div class="spinner"></div>Ladataan...</div>';
        loadTabContent(currentTab, LEAGUES[leagueKey]);
    }
}

// ‚îÄ‚îÄ Scoreboard fetch ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchMatches(league, from, to) {
    const url = scoreboardUrl(league, from, to);
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return (await res.json()).events || [];
}

// ‚îÄ‚îÄ Timeline ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SOCCER_ICONS = {
    'goal':'‚öΩ','own-goal':'‚öΩ','yellow-card':'üü®','red-card':'üü•',
    'yellow-red-card':'üü®üü•','substitution':'üîÑ','penalty-goal':'‚öΩ','missed-penalty':'‚ùå',
};
const HOCKEY_ICONS = {
    'goal':'üèí','penalty':'‚õî','penalty-shot':'üèí','shootout-goal':'üèí','goalie-change':'ü•Ö',
};

// Normalise an ESPN event type to a lowercase slug.
// Soccer keyEvents: type = { type:'goal', text:'Goal' }
// NHL plays:        type = { id:'505', text:'Goal', abbreviation:'goal' }  (no .type field!)
function espnEventType(e) {
    const t = e.type;
    if (!t) return '';
    if (typeof t === 'string') return t;
    if (t.type) return t.type;
    // NHL plays use abbreviation; soccer falls back to text
    const raw = t.abbreviation || t.text || '';
    return raw.toLowerCase().trim().replace(/\s+/g, '-');
}

function buildTimeline(keyEvents, homeTeamId, sport) {
    const isHockey = sport === 'hockey';
    const SHOW = isHockey
        ? new Set(['goal','penalty','penalty-shot','shootout-goal'])
        : new Set(['goal','own-goal','yellow-card','red-card','yellow-red-card','substitution','penalty-goal','missed-penalty']);
    const NON_SCORE_MARKERS = {
        'yellow-card':'üü®','red-card':'üü•','yellow-red-card':'üü®üü•',
        'substitution':'üîÑ','missed-penalty':'‚ùå','penalty':'‚õî','goalie-change':'ü•Ö',
    };

    const events = keyEvents.filter(e => {
        const type = espnEventType(e);
        if (SHOW.has(type)) return true;
        if (e.scoringPlay) return true;
        if (isHockey && e.type?.penaltyMinutes) return true;
        return false;
    });
    if (!events.length) return '<div class="no-events">Ei kirjattuja tapahtumia</div>';

    let html = '<div class="timeline">';
    let curPeriod = null;
    let homeGoals = 0, awayGoals = 0;

    for (const e of events) {
        const period       = e.period?.number ?? 0;
        const type         = espnEventType(e);
        const min          = e.clock?.displayValue || '';
        const isHome       = e.team?.id === homeTeamId;
        const parts        = e.participants || [];
        const isOwnGoal    = type === 'own-goal';
        const isScoring    = e.scoringPlay || ['goal','penalty-goal','shootout-goal'].includes(type);
        const isNHLPenalty = isHockey && !e.scoringPlay && e.type?.penaltyMinutes;

        // Track running score
        if (isScoring && !isNHLPenalty) {
            if (isOwnGoal) { if (isHome) awayGoals++; else homeGoals++; }
            else           { if (isHome) homeGoals++; else awayGoals++; }
        }

        // Period header
        if (period !== curPeriod) {
            curPeriod = period;
            let lbl;
            if (isHockey) {
                lbl = period === 4 ? 'Jatkoaika'
                    : period >= 5  ? 'Voittolaukauskilpailu'
                    : period > 0   ? `${period}. er√§` : '';
            } else {
                lbl = period === 1 ? '1. puoliaika'
                    : period === 2 ? '2. puoliaika'
                    : period >= 3  ? 'Jatkoaika' : '';
            }
            if (lbl) html += `<div class="tl-period"><span class="tl-period-label">${lbl}</span></div>`;
        }

        // Marker on outer edge
        let marker;
        if (isScoring && !isNHLPenalty) {
            const scoredHome = (isHome && !isOwnGoal) || (!isHome && isOwnGoal);
            const hDisp = scoredHome ? `<b>${homeGoals}</b>` : homeGoals;
            const aDisp = scoredHome ? awayGoals          : `<b>${awayGoals}</b>`;
            marker = `<span class="tl-score-chip">${hDisp}‚Äì${aDisp}</span>`;
        } else {
            marker = NON_SCORE_MARKERS[type] || (isNHLPenalty ? '‚õî' : '‚Ä¢');
        }

        // Content: player, assist, time
        let playerHTML = '', assistText = '';
        if (type === 'substitution') {
            const pOn  = parts[0]?.athlete?.displayName ?? '?';
            const pOff = parts[1]?.athlete?.displayName ?? '';
            playerHTML = `<div class="tl-player">‚ñ≤ ${pOn}</div>`
                       + (pOff ? `<div class="tl-player tl-sub-off">‚ñº ${pOff}</div>` : '');
        } else if (isNHLPenalty) {
            const name    = parts[0]?.athlete?.displayName ?? '';
            const penName = e.type?.text || '';
            const penMins = e.type?.penaltyMinutes || '';
            playerHTML = `<div class="tl-player">${name}</div>`;
            assistText = `${penName}${penMins ? ' (' + penMins + ' min)' : ''}`;
        } else {
            const scorer = (parts.find(p => p.type === 'scorer') ?? parts[0])?.athlete?.displayName ?? '';
            const a1     = (parts.find(p => p.type === 'assister') ?? parts[1])?.athlete?.displayName ?? '';
            const a2     = parts.filter(p => p.type === 'assister')[1]?.athlete?.displayName ?? '';
            playerHTML   = `<div class="tl-player">${scorer}${isOwnGoal ? ' (om)' : ''}</div>`;
            const showA  = (a1 || a2) && (isScoring || ['goal','penalty-goal'].includes(type));
            assistText   = showA ? [a1, a2].filter(Boolean).join(', ') : '';
        }

        const bodyHTML = `<div class="tl-event-body">
            ${playerHTML}
            ${assistText ? `<div class="tl-assist">‚Ü≥ ${assistText}</div>` : ''}
            ${min        ? `<div class="tl-min">${min}</div>` : ''}
        </div>`;

        if (isHome) {
            html += `<div class="tl-event">
                <div class="tl-home-col">
                    <div class="tl-marker">${marker}</div>
                    ${bodyHTML}
                </div>
                <div class="tl-away-col"></div>
            </div>`;
        } else {
            html += `<div class="tl-event">
                <div class="tl-home-col"></div>
                <div class="tl-away-col">
                    ${bodyHTML}
                    <div class="tl-marker">${marker}</div>
                </div>
            </div>`;
        }
    }

    return html + '</div>';
}

// ‚îÄ‚îÄ Stats bars ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const STAT_DEFS_SOCCER = [
    { key:'Possession',    label:'Pallonhallinta %', isPct:true  },
    { key:'SHOTS',         label:'Laukaukset',        isPct:false },
    { key:'ON GOAL',       label:'Maalilaukaukset',   isPct:false },
    { key:'Corner Kicks',  label:'Kulmapotkut',       isPct:false },
    { key:'Fouls',         label:'Rikkomukset',       isPct:false },
    { key:'Offsides',      label:'Paitsiot',          isPct:false },
    { key:'Saves',         label:'Torjunnat',         isPct:false },
    { key:'Yellow Cards',  label:'Keltaiset kortit',  isPct:false },
    { key:'Red Cards',     label:'Punaiset kortit',   isPct:false },
];
const STAT_DEFS_HOCKEY = [
    { key:'shots',                   label:'Laukaukset',          isPct:false },
    { key:'powerPlayGoals',          label:'Ylivoimamaalit',      isPct:false },
    { key:'powerPlayOpportunities',  label:'Ylivoimatilanteet',   isPct:false },
    { key:'faceOffWinPercent',       label:'Aloitusvoitot %',     isPct:true  },
    { key:'hits',                    label:'Taklaukset',          isPct:false },
    { key:'blocked',                 label:'Blokatut laukaukset', isPct:false },
    { key:'pims',                    label:'Rangaistusmin.',      isPct:false },
];

function buildStats(bsTeams, homeTeam, awayTeam, sport) {
    const homeBS = bsTeams.find(t => t.homeAway === 'home');
    const awayBS = bsTeams.find(t => t.homeAway === 'away');
    if (!homeBS || !awayBS) return '';

    const defs = sport === 'hockey' ? STAT_DEFS_HOCKEY : STAT_DEFS_SOCCER;

    const getVal = (stats, key) => {
        const s = stats.find(s => s.label === key || s.name === key);
        return s ? parseFloat(s.displayValue) : null;
    };

    let html = `<div class="stats-teams">
        <span class="home-label">${homeTeam.shortDisplayName || homeTeam.displayName}</span>
        <span class="away-label">${awayTeam.shortDisplayName || awayTeam.displayName}</span>
    </div>`;

    let hasAny = false;
    for (const def of defs) {
        const hRaw = getVal(homeBS.statistics, def.key);
        const aRaw = getVal(awayBS.statistics, def.key);
        if (hRaw === null && aRaw === null) continue;
        hasAny = true;
        const hVal = hRaw ?? 0, aVal = aRaw ?? 0;
        const total = hVal + aVal;
        const hPct  = def.isPct ? Math.round(hVal) : (total === 0 ? 50 : Math.round(hVal / total * 100));
        const aPct  = 100 - hPct;
        const hDisp = def.isPct ? hVal.toFixed(1) + '%' : hVal;
        const aDisp = def.isPct ? aVal.toFixed(1) + '%' : aVal;

        html += `<div class="stat-row">
            <span class="stat-val home-v">${hDisp}</span>
            <div class="stat-center">
                <div class="stat-bar-track">
                    <div class="bar-h" style="width:${hPct}%"></div>
                    <div class="bar-a" style="width:${aPct}%"></div>
                </div>
                <span class="stat-label">${def.label}</span>
            </div>
            <span class="stat-val away-v">${aDisp}</span>
        </div>`;
    }

    return hasAny ? html : '';
}

async function loadMatchStats(panel, eventId, homeTeam, awayTeam, league) {
    if (league.isLiiga) { return loadLiigaMatchStats(panel, eventId); }
    const content = panel.querySelector('.stats-content');
    content.innerHTML = '<div class="spinner-sm"></div>';
    try {
        if (!detailCache[eventId]) {
            const res = await fetch(summaryUrl(league, eventId));
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            detailCache[eventId] = await res.json();
        }
        const data      = detailCache[eventId];
        const sport     = league.sport;
        const tlIcon    = sport === 'hockey' ? 'üèí' : '‚öΩ';
        // NHL has no keyEvents ‚Äî use plays instead; soccer uses keyEvents
        const evArr = (data.keyEvents?.length) ? data.keyEvents : (data.plays || []);
        const tlHTML    = buildTimeline(evArr, homeTeam.id, sport);
        const statsHTML = buildStats(data.boxscore?.teams || [], homeTeam, awayTeam, sport);

        content.innerHTML = `
            <div class="details-section">
                <div class="details-title">${tlIcon} Tapahtumat</div>
                ${tlHTML}
            </div>
            ${statsHTML ? `<div class="details-section">
                <div class="details-title">üìä Tilastot</div>
                ${statsHTML}
            </div>` : ''}`;
        panel.dataset.loaded = '1';
    } catch (err) {
        content.innerHTML = `<div class="details-error">Virhe: ${err.message}</div>`;
    }
}

// ‚îÄ‚îÄ FPL Stats ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildFplSection(players, fixtureId, teamName) {
    if (!players.length) return `<div class="no-events">Ei pelaajatietoja</div>`;

    let html = `<div class="fpl-team-name">${teamName}</div>`;
    html += `<div class="fpl-table">
        <div class="fpl-row fpl-hdr">
            <span>Pos</span><span>Pelaaja</span>
            <span style="text-align:center">Min</span>
            <span style="text-align:center">G</span>
            <span style="text-align:center">A</span>
            <span style="text-align:center">CS</span>
            <span style="text-align:center" title="Defensive Contribution (tackles + clearances + blocks + interceptions)">DC</span>
            <span style="text-align:center">Bon</span>
            <span style="text-align:center">Pts</span>
        </div>`;

    for (const p of players) {
        const fe = (p.live?.explain || []).find(e => e.fixture === fixtureId);
        if (!fe) continue;

        const stats = {};
        for (const s of fe.stats) stats[s.identifier] = s;

        const mins = stats.minutes?.value ?? 0;
        if (mins === 0) continue;

        const goals   = stats.goals_scored?.value ?? 0;
        const assists = stats.assists?.value ?? 0;
        const cs      = stats.clean_sheets?.value ?? 0;
        const bonus   = stats.bonus?.value ?? 0;
        const yc      = stats.yellow_cards?.value ?? 0;
        const rc      = stats.red_cards?.value ?? 0;
        const og      = stats.own_goals?.value ?? 0;
        const saves   = stats.saves?.value ?? 0;
        const penSav  = stats.penalties_saved?.value ?? 0;
        const dc      = p.live.stats.defensive_contribution ?? 0;
        const totalPts = fe.stats.reduce((sum, s) => sum + s.points, 0);

        const pos    = POS_NAME[p.element_type];
        const posCls = pos.toLowerCase();

        let nameExtra = '';
        if (yc) nameExtra += ' üü®';
        if (rc) nameExtra += ' üü•';
        if (og) nameExtra += ' ‚öΩ(og)';
        if (saves >= 3) nameExtra += ` üß§${saves}`;
        if (penSav) nameExtra += ' ‚úã';

        const isSub    = stats.starts?.value === 0;
        const minLabel = isSub ? `‚Üë${mins}'` : `${mins}'`;
        const ptsCls   = totalPts >= 10 ? 'pts-high' : totalPts >= 6 ? 'pts-med' : 'pts-low';
        const nameCls  = totalPts >= 10 ? 'fpl-name row-starred' : 'fpl-name';
        const csLabel  = (pos === 'GK' || pos === 'DEF' || pos === 'MID') ? (cs ? '‚úì' : '‚Äì') : '‚Äì';

        html += `<div class="fpl-row">
            <span class="fpl-pos fpl-pos-${posCls}">${pos}</span>
            <span class="${nameCls}">${p.web_name}${nameExtra}</span>
            <span class="fpl-num" style="color:var(--muted);font-size:0.9em">${minLabel}</span>
            <span class="fpl-num ${goals   ? 'nonzero' : ''}">${goals   || '‚Äì'}</span>
            <span class="fpl-num ${assists ? 'nonzero' : ''}">${assists || '‚Äì'}</span>
            <span class="fpl-num" style="color:${cs ? '#0369a1' : 'var(--muted)'}">${csLabel}</span>
            <span class="fpl-num ${dc      ? 'nonzero' : ''}">${dc      || '‚Äì'}</span>
            <span class="fpl-num ${bonus   ? 'nonzero' : ''}">${bonus   || '‚Äì'}</span>
            <span class="fpl-pts ${ptsCls}">${totalPts}</span>
        </div>`;
    }

    return html + '</div>';
}

async function loadFplStats(div, ev, homeTeam, awayTeam) {
    div.innerHTML = '<div class="spinner-sm"></div>';
    try {
        const bootstrap = await getFplBootstrap();

        const shortToId = {};
        for (const t of bootstrap.teams) shortToId[t.short_name] = t.id;

        const homeShort = ESPN_TO_FPL[homeTeam.displayName];
        const awayShort = ESPN_TO_FPL[awayTeam.displayName];

        if (!homeShort || !awayShort) {
            throw new Error(`Joukkueen nimi ei vastaa FPL-dataa (${homeTeam.displayName} / ${awayTeam.displayName})`);
        }

        const homeId = shortToId[homeShort];
        const awayId = shortToId[awayShort];

        const fixtures  = await getFplFixtures();
        const matchDate = ev.date.slice(0, 10);

        const fixture = fixtures.find(f => {
            if (!f.kickoff_time) return false;
            const fd = f.kickoff_time.slice(0, 10);
            return fd === matchDate && f.team_h === homeId && f.team_a === awayId;
        });

        if (!fixture || !fixture.event) throw new Error('FPL-ottelua ei l√∂ydy tai peli on lyk√§tty');

        const liveData = await getFplEventLive(fixture.event);
        const liveMap  = {};
        for (const el of liveData.elements) liveMap[el.id] = el;

        const getPlayers = (teamId) =>
            bootstrap.elements
                .filter(p => p.team === teamId)
                .map(p => ({ ...p, live: liveMap[p.id] || null }))
                .filter(p => {
                    if (!p.live) return false;
                    const fe = (p.live.explain || []).find(e => e.fixture === fixture.id);
                    return fe && fe.stats.some(s => s.identifier === 'minutes' && s.value > 0);
                })
                .sort((a, b) => {
                    if (a.element_type !== b.element_type) return a.element_type - b.element_type;
                    const ptA = (a.live.explain||[]).find(e=>e.fixture===fixture.id)?.stats.reduce((s,x)=>s+x.points,0)??0;
                    const ptB = (b.live.explain||[]).find(e=>e.fixture===fixture.id)?.stats.reduce((s,x)=>s+x.points,0)??0;
                    return ptB - ptA;
                });

        const homePlayers = getPlayers(homeId);
        const awayPlayers = getPlayers(awayId);

        div.innerHTML = `
            <div class="details-section">
                <div class="details-title fpl-title">‚öΩ FPL-pisteet ‚Äî Kierros ${fixture.event}</div>
                <div class="fpl-section">${buildFplSection(homePlayers, fixture.id, homeTeam.displayName)}</div>
                <div class="fpl-section">${buildFplSection(awayPlayers, fixture.id, awayTeam.displayName)}</div>
                <div style="font-size:0.68em;color:var(--muted);margin-top:10px;text-align:center">
                    ‚Üë = tullut vaihdossa &nbsp;|&nbsp; üü®üü• = kortit &nbsp;|&nbsp; üß§ = torjunnat &nbsp;|&nbsp; ‚úã = penaltyltorjunta
                </div>
            </div>`;
        div.dataset.loaded = '1';
    } catch (err) {
        div.innerHTML = `<div class="details-error">FPL-tilastoja ei saatavilla: ${err.message}</div>`;
    }
}

// ‚îÄ‚îÄ Lineup ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const SOCCER_POS_GROUP = {
    'GK':0,'G':0,
    'CB':1,'LB':1,'RB':1,'LWB':1,'RWB':1,'SW':1,'D':1,'DF':1,'WB':1,
    'CM':2,'CAM':2,'CDM':2,'DM':2,'LM':2,'RM':2,'AM':2,'M':2,'MF':2,'ATT MID':2,'DEF MID':2,
    'ST':3,'CF':3,'LW':3,'RW':3,'SS':3,'FW':3,'F':3,'W':3,'AT':3,'ATT':3,
};

function getSoccerGroup(abbr) {
    if (!abbr) return 2;
    const a = abbr.toUpperCase().trim();
    if (SOCCER_POS_GROUP[a] !== undefined) return SOCCER_POS_GROUP[a];
    if (a === 'GK' || a.includes('GOAL')) return 0;
    if (a.startsWith('D') || a.endsWith('BACK') || a.endsWith('B')) return 1;
    if (a === 'ST' || a === 'CF' || a.startsWith('F') || a.includes('WARD')) return 3;
    return 2;
}

function shortName(athlete) {
    const sn = athlete?.shortName;
    if (sn) return sn;
    const full = athlete?.displayName || '?';
    const parts = full.split(' ');
    if (parts.length === 1) return parts[0];
    return parts[0][0] + '. ' + parts[parts.length - 1];
}

function parseFormationRows(roster) {
    if (!roster) return [];
    const starters = (roster.roster || []).filter(p => p.starter);
    if (!starters.length) return [];
    starters.sort((a, b) =>
        (a.formationSequence ?? a.formationPlace ?? 99) -
        (b.formationSequence ?? b.formationPlace ?? 99)
    );
    // ESPN sometimes orders GK last (attack‚Üídefense); detect and reverse
    const firstGrp = getSoccerGroup(starters[0].athlete?.position?.abbreviation);
    const lastGrp  = getSoccerGroup(starters[starters.length - 1].athlete?.position?.abbreviation);
    if (lastGrp === 0 && firstGrp !== 0) starters.reverse();

    const fmtn  = roster.formation || '';
    const parts = fmtn.split('-').map(Number).filter(n => n > 0);
    const total = parts.reduce((s, n) => s + n, 0);
    if (parts.length >= 2 && total === starters.length - 1) {
        const rows = [[starters[0]]]; // GK row
        let idx = 1;
        for (const count of parts) {
            rows.push(starters.slice(idx, idx + count));
            idx += count;
        }
        return rows;
    }
    // Fallback: group by position abbreviation
    const groups = [[], [], [], []];
    for (const p of starters) {
        groups[getSoccerGroup(p.athlete?.position?.abbreviation)].push(p);
    }
    return groups.filter(g => g.length > 0);
}

const SOCCER_POS_LABEL = { 0:'MV', 1:'Puolustajat', 2:'Keskikentt√§pelaajat', 3:'Hy√∂kk√§√§j√§t' };

function buildSoccerLineup(homeRoster, awayRoster, homeTeam, awayTeam) {
    const buildTeam = (roster, teamName, color) => {
        if (!roster) return `<div class="no-events">Ei kokoonpanotietoja</div>`;
        const players  = roster.roster || [];
        const starters = players.filter(p => p.starter);
        const subs     = players.filter(p => !p.starter);
        if (!starters.length) return `<div class="no-events">Ei kokoonpanotietoja</div>`;

        const formation = roster.formation || '';
        const groups = [[], [], [], []];
        for (const p of starters) {
            groups[getSoccerGroup(p.athlete?.position?.abbreviation)].push(p);
        }

        const subTime = (p) => {
            const plays = p.plays || [];
            // Find the substitution play specifically, not e.g. a goal play
            const subPlay = plays.find(pl => pl.substitution === true)
                         || plays.find(pl => pl.type?.text?.toLowerCase().includes('sub'));
            const c = subPlay?.clock;
            if (!c) return '';
            const val = typeof c === 'string' ? c : (c.displayValue || c.value || '');
            return val ? ` ${val}` : '';
        };

        const playerRow = (p, isSub) => {
            const subbedOut = !isSub && p.subbedOut;
            const subbedIn  = isSub  && p.subbedIn;
            const subMark   = subbedOut
                ? `<span class="lu-sub-mark lu-sub-out" title="Vaihdettu pois${subTime(p)}">‚ñº${subTime(p)}</span>`
                : subbedIn
                ? `<span class="lu-sub-mark lu-sub-in"  title="Tuli vaihdossa${subTime(p)}">‚ñ≤${subTime(p)}</span>`
                : '';
            return `<div class="lu-player${isSub ? ' lu-sub' : ''}">
                <span class="lu-jersey">${p.jersey || '‚Äì'}</span>
                <span class="lu-name">${p.athlete?.displayName || '?'}</span>
                ${subMark}
            </div>`;
        };

        let html = `<div class="lu-team-header" style="border-color:${color}">
            <span class="lu-team-name" style="color:${color}">${teamName}</span>
            ${formation ? `<span class="lu-formation">${formation}</span>` : ''}
        </div>
        <div class="lu-section-title">‚öΩ Avauskokoonpano</div>`;

        for (let i = 0; i < 4; i++) {
            if (!groups[i].length) continue;
            html += groups[i].map(p => playerRow(p, false)).join('');
        }

        if (subs.length) {
            html += `<div class="lu-section-title" style="margin-top:12px">üîÑ Vaihtopelaajat</div>`;
            html += subs.map(p => playerRow(p, true)).join('');
        }

        return `<div class="lu-team">${html}</div>`;
    };

    const homeName = homeTeam.shortDisplayName || homeTeam.displayName;
    const awayName = awayTeam.shortDisplayName || awayTeam.displayName;
    return `<div class="lineup-lists">
        ${buildTeam(homeRoster, homeName, '#0369a1')}
        ${buildTeam(awayRoster, awayName, '#1e40af')}
    </div>`;
}

// NHL: data comes from boxscore.players[i].statistics categories
function buildHockeyLineup(homeBs, awayBs, homeTeam, awayTeam) {
    const parseToI = (toi) => {
        if (!toi) return 0;
        const [m, s] = String(toi).split(':').map(Number);
        return (m || 0) * 60 + (s || 0);
    };

    const buildTeam = (bsTeam, teamName, color) => {
        if (!bsTeam) return `<div class="no-events">Ei kokoonpanotietoja</div>`;
        const stats = bsTeam.statistics || [];
        const getGroup = (name) => (stats.find(s => s.name === name)?.athletes || []);

        const forwards = getGroup('forwards');
        const defense  = getGroup('defenses');
        const goalies  = getGroup('goalies');

        if (!forwards.length && !defense.length && !goalies.length)
            return `<div class="no-events">Ei kokoonpanotietoja</div>`;

        // Starting goalie = most ice time (stats index 9 = timeOnIce for goalies)
        const startGk = goalies.length
            ? goalies.reduce((best, g) =>
                parseToI(g.stats?.[9]) > parseToI(best?.stats?.[9]) ? g : best, goalies[0])
            : null;

        let html = `<div class="lu-team-header" style="border-color:${color}">
            <span class="lu-team-name" style="color:${color}">${teamName}</span>
        </div>`;

        if (goalies.length) {
            html += `<div class="lu-section-title">ü•Ö Maalivahti</div>`;
            for (const g of goalies) {
                const isStart = g === startGk;
                const name   = g.athlete?.displayName || '?';
                const jersey = g.athlete?.jersey || '‚Äì';
                html += `<div class="lu-player${isStart ? ' lu-starter-gk' : ' lu-sub'}">
                    <span class="lu-jersey">${jersey}</span>
                    <span class="lu-pos-tag" style="background:${isStart ? color+'33' : 'rgba(148,163,184,0.18)'};color:${isStart ? color : '#64748b'}">MV</span>
                    <span class="lu-name">${name}</span>
                    ${isStart ? '<span class="lu-starter-badge">Aloittaa</span>' : ''}
                </div>`;
            }
        }

        if (forwards.length) {
            html += `<div class="lu-section-title">üèí Hy√∂kk√§ysketjut</div>`;
            for (let i = 0; i < forwards.length; i += 3) {
                html += `<div class="lu-line-label">${Math.floor(i / 3) + 1}. ketju</div>`;
                for (const p of forwards.slice(i, i + 3)) {
                    const pos = p.athlete?.position?.abbreviation || '‚Äì';
                    html += `<div class="lu-player">
                        <span class="lu-jersey">${p.athlete?.jersey || '‚Äì'}</span>
                        <span class="lu-pos-tag" style="background:${color}22;color:${color}">${pos}</span>
                        <span class="lu-name">${p.athlete?.displayName || '?'}</span>
                    </div>`;
                }
            }
        }

        if (defense.length) {
            html += `<div class="lu-section-title">üõ°Ô∏è Puolustusparit</div>`;
            for (let i = 0; i < defense.length; i += 2) {
                html += `<div class="lu-line-label">${Math.floor(i / 2) + 1}. pari</div>`;
                for (const p of defense.slice(i, i + 2)) {
                    html += `<div class="lu-player">
                        <span class="lu-jersey">${p.athlete?.jersey || '‚Äì'}</span>
                        <span class="lu-pos-tag" style="background:${color}22;color:${color}">D</span>
                        <span class="lu-name">${p.athlete?.displayName || '?'}</span>
                    </div>`;
                }
            }
        }

        return `<div class="lu-team">${html}</div>`;
    };

    const homeName = homeTeam.shortDisplayName || homeTeam.displayName;
    const awayName = awayTeam.shortDisplayName || awayTeam.displayName;
    return `<div class="lineup-lists">
        ${buildTeam(homeBs, homeName, '#0369a1')}
        ${buildTeam(awayBs, awayName, '#1e40af')}
    </div>`;
}

async function loadLiigaLineup(div, gameId, homeTeam, awayTeam) {
    try {
        const game = liigaGameById[String(gameId)];
        if (!game) throw new Error('not found');

        // Try to parse players from game object if available
        const liigaName = p => {
            const fn = (p.firstName || '').split('-').map(s => s.charAt(0) + s.slice(1).toLowerCase()).join('-');
            const ln = (p.lastName  || p.name || '').split('-').map(s => s.charAt(0) + s.slice(1).toLowerCase()).join('-');
            return `${fn} ${ln}`.trim() || '?';
        };

        const buildLiigaTeam = (teamData, teamName, color) => {
            const players = teamData.players || teamData.roster || [];
            if (!players.length) return `<div class="no-events">Ei kokoonpanotietoja</div>`;

            const goalies  = players.filter(p => p.position === 'GK' || p.position === 'G' || p.position === 'MV');
            const forwards = players.filter(p => ['LW','C','RW','F','H'].includes(p.position));
            const defense  = players.filter(p => ['D','P'].includes(p.position));
            const startGk  = goalies[0];

            let html = `<div class="lu-team-header" style="border-color:${color}">
                <span class="lu-team-name" style="color:${color}">${teamName}</span>
            </div>`;

            if (goalies.length) {
                html += `<div class="lu-section-title">ü•Ö Maalivahti</div>`;
                for (const g of goalies) {
                    const isStart = g === startGk;
                    html += `<div class="lu-player${isStart ? ' lu-starter-gk' : ' lu-sub'}">
                        <span class="lu-jersey">${g.jerseyNumber || g.jersey || '‚Äì'}</span>
                        <span class="lu-pos-tag" style="background:${isStart ? color+'33' : 'rgba(148,163,184,0.18)'};color:${isStart ? color : '#64748b'}">MV</span>
                        <span class="lu-name">${liigaName(g)}</span>
                        ${isStart ? '<span class="lu-starter-badge">Aloittaa</span>' : ''}
                    </div>`;
                }
            }
            if (forwards.length) {
                html += `<div class="lu-section-title">üèí Hy√∂kk√§ysketjut</div>`;
                for (let i = 0; i < forwards.length; i += 3) {
                    html += `<div class="lu-line-label">${Math.floor(i/3)+1}. ketju</div>`;
                    for (const p of forwards.slice(i, i+3)) {
                        html += `<div class="lu-player">
                            <span class="lu-jersey">${p.jerseyNumber || p.jersey || '‚Äì'}</span>
                            <span class="lu-pos-tag" style="background:${color}22;color:${color}">${p.position || '‚Äì'}</span>
                            <span class="lu-name">${liigaName(p)}</span>
                        </div>`;
                    }
                }
            }
            if (defense.length) {
                html += `<div class="lu-section-title">üõ°Ô∏è Puolustusparit</div>`;
                for (let i = 0; i < defense.length; i += 2) {
                    html += `<div class="lu-line-label">${Math.floor(i/2)+1}. pari</div>`;
                    for (const p of defense.slice(i, i+2)) {
                        html += `<div class="lu-player">
                            <span class="lu-jersey">${p.jerseyNumber || p.jersey || '‚Äì'}</span>
                            <span class="lu-pos-tag" style="background:${color}22;color:${color}">D</span>
                            <span class="lu-name">${liigaName(p)}</span>
                        </div>`;
                    }
                }
            }
            return `<div class="lu-team">${html}</div>`;
        };

        const hasPlayers = (game.homeTeam?.players?.length || game.homeTeam?.roster?.length);
        if (!hasPlayers) throw new Error('no players');

        div.innerHTML = `<div class="lineup-lists">
            ${buildLiigaTeam(game.homeTeam, homeTeam.displayName, '#0369a1')}
            ${buildLiigaTeam(game.awayTeam, awayTeam.displayName, '#1e40af')}
        </div>`;
        div.dataset.loaded = '1';
    } catch {
        div.innerHTML = '<div class="no-events">Kokoonpanotietoja ei saatavilla</div>';
        div.dataset.loaded = '1';
    }
}

async function loadLineups(div, eventId, league, homeTeam, awayTeam) {
    if (league.isLiiga) {
        return loadLiigaLineup(div, eventId, homeTeam, awayTeam);
    }
    div.innerHTML = '<div class="spinner-sm"></div>';
    try {
        if (!detailCache[eventId]) {
            const res = await fetch(summaryUrl(league, eventId));
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            detailCache[eventId] = await res.json();
        }
        const data = detailCache[eventId];

        if (league.sport === 'hockey') {
            const bsPlayers = data.boxscore?.players || [];
            if (!bsPlayers.length) {
                div.innerHTML = '<div class="no-events">Kokoonpanotietoja ei saatavilla</div>';
                div.dataset.loaded = '1';
                return;
            }
            const homeBs = bsPlayers.find(t => t.team?.homeAway === 'home')
                        || bsPlayers.find(t => String(t.team?.id) === String(homeTeam.id));
            const awayBs = bsPlayers.find(t => t.team?.homeAway === 'away')
                        || bsPlayers.find(t => String(t.team?.id) === String(awayTeam.id));
            div.innerHTML = buildHockeyLineup(homeBs, awayBs, homeTeam, awayTeam);
            div.dataset.loaded = '1';
            return;
        }

        const rosters = data.rosters || [];
        if (!rosters.length) {
            div.innerHTML = '<div class="no-events">Kokoonpanotietoja ei saatavilla</div>';
            div.dataset.loaded = '1';
            return;
        }

        const homeRoster = rosters.find(r => r.homeAway === 'home');
        const awayRoster = rosters.find(r => r.homeAway === 'away');
        div.innerHTML = buildSoccerLineup(homeRoster, awayRoster, homeTeam, awayTeam);

        div.dataset.loaded = '1';
    } catch (err) {
        div.innerHTML = `<div class="details-error">Virhe: ${err.message}</div>`;
    }
}

// ‚îÄ‚îÄ Card creation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function createCard(ev, league) {
    const comp   = ev.competitions[0];
    const home   = comp.competitors.find(c => c.homeAway === 'home');
    const away   = comp.competitors.find(c => c.homeAway === 'away');
    const status = comp.status.type;
    const isPre     = status.state === 'pre';
    const isPost    = status.state === 'post';
    const isLive    = status.state === 'in';
    const matchMs   = new Date(ev.date).getTime();
    const canStats  = isPost || isLive;
    const canLineup = !league.isLiiga && (canStats || (isPre && matchMs - Date.now() <= 10 * 60 * 1000));
    const canBtn    = canStats || canLineup;
    const hasFPL    = !!(league.hasFPL && canStats);

    let statusClass = 'status-pre', statusText = fmtTime(ev.date);
    if (isPost) { statusClass = 'status-ft';   statusText = status.shortDetail || 'FT'; }
    if (isLive) { statusClass = 'status-live'; statusText = status.detail      || 'LIVE'; }

    let centerHTML;
    if (isPost || isLive) {
        centerHTML = `<div class="score-block">
            <div class="score-pill">
                <div class="score">${home.score}&ndash;${away.score}</div>
                <div class="score-detail">${isLive ? status.displayClock || 'LIVE' : 'Lopputulos'}</div>
            </div>
        </div>`;
    } else {
        centerHTML = `<div class="score-block">
            <div class="upcoming-block">
                <div class="upcoming-time">${fmtTime(ev.date)}</div>
                <div class="upcoming-vs">vs</div>
            </div>
        </div>`;
    }

    const venue = comp.venue?.fullName ?? '';
    const card  = document.createElement('div');
    card.className = 'match-card' + (canBtn ? ' has-btns' : '');

    card.innerHTML = `
        ${(isLive || isPost) ? `<div class="match-meta"><span class="match-start-time">${fmtTime(ev.date)}</span>${isLive ? `<span class="match-status ${statusClass}">${statusText}</span>` : ''}</div>` : ''}
        <div class="match-teams">
            <div class="team">
                <div class="team-logo">
                    <img src="${home.team.logo}" alt="${home.team.displayName}"
                         onerror="this.style.visibility='hidden'">
                </div>
                <div class="team-name">${home.team.displayName}</div>
            </div>
            ${centerHTML}
            <div class="team">
                <div class="team-logo">
                    <img src="${away.team.logo}" alt="${away.team.displayName}"
                         onerror="this.style.visibility='hidden'">
                </div>
                <div class="team-name">${away.team.displayName}</div>
            </div>
        </div>
        ${canBtn ? `
        <div class="detail-panel stats-panel">
            <div class="detail-tab-row">
                ${canStats ? `<button class="detail-tab-btn stats-tab active">üìä Ottelutapahtumat</button>` : ''}
                <button class="detail-tab-btn lineups-tab${canStats ? '' : ' active'}">üë• Kokoonpanot</button>
                ${hasFPL ? '<button class="detail-tab-btn fpl-tab">‚öΩ FPL Pisteet</button>' : ''}
            </div>
            ${canStats ? `<div class="panel-content stats-content active"></div>` : ''}
            <div class="panel-content lineups-content${canStats ? '' : ' active'}"></div>
            ${hasFPL ? '<div class="panel-content fpl-content"></div>' : ''}
        </div>` : ''}`;

    if (canBtn) {
        const statsPanel      = card.querySelector('.stats-panel');
        const statsContent    = card.querySelector('.stats-content');
        const lineupsContent  = card.querySelector('.lineups-content');
        const fplContent      = card.querySelector('.fpl-content');
        const statsTab        = card.querySelector('.stats-tab');
        const lineupsTab      = card.querySelector('.lineups-tab');
        const fplTab          = card.querySelector('.fpl-tab');

        // Helper: activate one tab+content, deactivate rest
        const switchTab = (activeBtn, activeDiv) => {
            card.querySelectorAll('.detail-tab-btn').forEach(b => b.classList.remove('active'));
            card.querySelectorAll('.panel-content').forEach(c => c.classList.remove('active'));
            activeBtn.classList.add('active');
            activeDiv.classList.add('active');
        };

        // Click anywhere on card ‚Üí open stats panel, or close if already open
        card.addEventListener('click', () => {
            if (statsPanel.classList.contains('panel-open')) {
                statsPanel.classList.remove('panel-open');
                card.classList.remove('panel-open');
            } else {
                statsPanel.classList.add('panel-open');
                card.classList.add('panel-open');
                if (canStats && !statsPanel.dataset.loaded) {
                    loadMatchStats(statsPanel, ev.id, home.team, away.team, league);
                } else if (!canStats && canLineup && !lineupsContent.dataset.loaded) {
                    loadLineups(lineupsContent, ev.id, league, home.team, away.team);
                }
            }
        });

        if (statsTab) {
            statsTab.addEventListener('click', e => {
                e.stopPropagation();
                switchTab(statsTab, statsContent);
            });
        }

        lineupsTab.addEventListener('click', e => {
            e.stopPropagation();
            switchTab(lineupsTab, lineupsContent);
            if (!lineupsContent.dataset.loaded) {
                loadLineups(lineupsContent, ev.id, league, home.team, away.team);
            }
        });

        if (hasFPL) {
            fplTab.addEventListener('click', e => {
                e.stopPropagation();
                switchTab(fplTab, fplContent);
                if (!fplContent.dataset.loaded) {
                    loadFplStats(fplContent, ev, home.team, away.team);
                }
            });
        }
    }

    return card;
}

// ‚îÄ‚îÄ Render helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderEvents(events, containerId, upcoming, league) {
    const el = document.getElementById(containerId);
    el.innerHTML = '';

    if (!events.length) {
        el.innerHTML = '<div class="error-msg">Otteluita ei l√∂ytynyt.</div>';
        return;
    }

    const info = document.createElement('p');
    info.className = 'section-info';
    info.textContent = upcoming ? `${events.length} tulevaa ottelua` : `${events.length} ottelua`;
    el.appendChild(info);

    const groups = new Map();
    for (const ev of events) {
        const day = ev.date.slice(0, 10);
        if (!groups.has(day)) groups.set(day, []);
        groups.get(day).push(ev);
    }

    const days = [...groups.keys()].sort((a, b) =>
        upcoming ? a.localeCompare(b) : b.localeCompare(a));

    for (const day of days) {
        const dayEvents = groups.get(day).sort((a, b) =>
            upcoming ? new Date(a.date) - new Date(b.date)
                     : new Date(b.date) - new Date(a.date));

        const hdr = document.createElement('div');
        hdr.className = 'matchday-header';
        hdr.textContent = new Date(day + 'T12:00:00').toLocaleDateString('fi-FI', {
            weekday:'long', day:'numeric', month:'long', year:'numeric'
        });
        el.appendChild(hdr);
        for (const ev of dayEvents) el.appendChild(createCard(ev, league));
    }
}

// ‚îÄ‚îÄ Standings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// Flatten potentially nested ESPN standings children to get all team entries
function flattenEntries(node) {
    if (node.standings?.entries?.length) return node.standings.entries;
    if (!node.children) return [];
    let all = [];
    for (const child of node.children) all = all.concat(flattenEntries(child));
    return all;
}

// Stat category labels per sport
const TEAM_STAT_LABELS = {
    soccer: { goals: 'Maalit', assists: 'Sy√∂t√∂t', minutesPlayed: 'Minuutit', yellowCards: 'Kelt. kortit', saves: 'Torjunnat' },
    hockey: { points: 'Pisteet', goals: 'Maalit', assists: 'Sy√∂t√∂t', plusMinus: '+/‚Äì', saves: 'Torjunnat' },
};

async function loadTeamStats(div, teamId, league) {
    div.innerHTML = '<div class="spinner-sm"></div>';
    try {
        const res = await fetch(teamUrl(league, teamId));
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const leaders = data.team?.leaders || [];
        const labels  = TEAM_STAT_LABELS[league.sport] || TEAM_STAT_LABELS.soccer;

        const cards = [];
        for (const cat of leaders) {
            const label = labels[cat.name];
            if (!label) continue;
            const top = cat.leaders?.[0];
            if (!top) continue;
            const name = top.athlete?.shortName || top.athlete?.displayName || '‚Äì';
            cards.push(`<div class="team-stat-card">
                <div class="team-stat-card-label">${label}</div>
                <div class="team-stat-value">${top.displayValue}</div>
                <div class="team-stat-name">${name}</div>
            </div>`);
            if (cards.length >= 3) break;
        }

        if (!cards.length) {
            div.innerHTML = '<div class="no-events">Ei tilastoja saatavilla.</div>';
            return;
        }
        div.innerHTML = `<div class="team-stat-cards">${cards.join('')}</div>`;
    } catch (err) {
        div.innerHTML = `<div class="no-events">Virhe: ${err.message}</div>`;
    }
}

function attachTeamStatsHandlers(el, league) {
    // Always update the current league reference
    el._statsLeague = league;

    // Create a fresh panel and append to standings container
    const panel = document.createElement('div');
    panel.className = 'team-stats-panel';
    panel.style.display = 'none';
    el.appendChild(panel);
    el._statsPanel = panel;

    // Only add the delegated listener once ‚Äî it reads el._statsLeague / el._statsPanel dynamically
    if (el._statsListenerAdded) return;
    el._statsListenerAdded = true;

    el.addEventListener('click', function(e) {
        const row = e.target.closest('.st-row');
        if (!row) return;

        const p        = el._statsPanel;
        const lg       = el._statsLeague;
        const teamId   = row.getAttribute('data-team-id');
        const teamName = row.getAttribute('data-team-name');
        const teamLogo = row.getAttribute('data-team-logo');
        if (!teamId || !p) return;

        // Toggle same team closed
        if (p.dataset.openId === teamId && p.style.display !== 'none') {
            p.style.display = 'none';
            p.dataset.openId = '';
            el.querySelectorAll('.st-row').forEach(r => r.classList.remove('st-active'));
            return;
        }

        el.querySelectorAll('.st-row').forEach(r => r.classList.remove('st-active'));
        row.classList.add('st-active');
        p.dataset.openId = teamId;
        p.style.display = 'block';

        // Reposition panel after the nearest match-card
        const card = row.closest('.match-card');
        if (card) card.after(p);

        p.innerHTML = `
            <div class="team-stats-header">
                <img src="${teamLogo}" alt="" onerror="this.style.visibility='hidden'">
                <span>${teamName}</span>
            </div>
            <div class="ts-body"></div>`;
        loadTeamStats(p.querySelector('.ts-body'), teamId, lg);
    });
}

async function loadStandings(league) {
    const el = document.getElementById('standings-body');
    if (league.isLiiga) { return loadLiigaStandings(league); }

    try {
        const res = await fetch(standingsUrl(league));
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        const isHockey = league.sport === 'hockey';

        // Collect all entries
        let entries = flattenEntries(data);

        // For NHL, group by conference/division if children exist
        if (isHockey && data.children?.length) {
            renderHockeyStandings(el, data, league);
        } else {
            renderSoccerStandings(el, entries, league);
        }
    } catch (err) {
        el.innerHTML = `<div class="error-msg">Virhe sarjataulukon lataamisessa: ${err.message}</div>`;
    }
}

function standingsTableHTML(entries, cols, sport) {
    const zones = new Map();
    let rows = '';

    // Sort by rank stat
    entries.sort((a, b) => {
        const rA = Number(a.stats?.find(s => s.name === 'rank')?.displayValue ?? 99);
        const rB = Number(b.stats?.find(s => s.name === 'rank')?.displayValue ?? 99);
        return rA - rB;
    });

    for (const entry of entries) {
        const t     = entry.team;
        const stats = Object.fromEntries((entry.stats || []).map(s => [s.name, s.displayValue]));
        const note  = entry.note;
        const logo  = t.logos?.[0]?.href ?? '';

        let zoneBar = '';
        if (note?.color) {
            zoneBar = `<span class="zone-bar" style="background:${note.color}"></span>`;
            if (!zones.has(note.description)) zones.set(note.description, note.color);
        }

        const rank = Number(stats.rank ?? 0);

        let tdCells = '';
        for (const col of cols) {
            const raw = stats[col.name] ?? '';
            if (col.name === 'pointDifferential') {
                const n = Number(raw);
                const gdStr = raw.startsWith('+') || raw.startsWith('-') ? raw : (n >= 0 ? '+' + raw : raw);
                const gdColor = n > 0 ? '#0369a1' : n < 0 ? '#dc2626' : '';
                tdCells += `<td class="st-gd" style="color:${gdColor}">${gdStr}</td>`;
            } else if (col.cls) {
                tdCells += `<td class="${col.cls}">${raw}</td>`;
            } else {
                tdCells += `<td>${raw}</td>`;
            }
        }

        rows += `<tr class="st-row" data-team-id="${t.id}" data-team-name="${t.displayName}" data-team-logo="${logo}">
            <td class="st-rank">${rank}</td>
            <td><div class="st-team">
                ${zoneBar}
                <img src="${logo}" alt="${t.shortDisplayName}" onerror="this.style.visibility='hidden'">
                <span>${t.displayName}</span>
            </div></td>
            ${tdCells}
        </tr>`;
    }

    const thCells = cols.map(c => `<th>${c.label}</th>`).join('');

    const legendItems = [...zones.entries()].map(([desc, color]) => {
        const fi = desc === 'Champions League'         ? 'Mestareiden liiga'
                 : desc === 'Europa League'            ? 'Europa-liiga'
                 : desc === 'UEFA Conference League'   ? 'Conference-liiga'
                 : desc === 'Relegation'               ? 'Putoamisvy√∂hyke'
                 : desc === 'Playoff'                  ? 'Playoffs'
                 : desc;
        return `<div class="legend-item">
            <div class="legend-dot" style="background:${color}"></div>
            <span>${fi}</span>
        </div>`;
    }).join('');

    return { rows, thCells, legendHTML: legendItems };
}

function renderSoccerStandings(el, entries, league) {
    const cols = [
        { name:'gamesPlayed',      label:'P'   },
        { name:'wins',             label:'V'   },
        { name:'ties',             label:'T'   },
        { name:'losses',           label:'H'   },
        { name:'pointsFor',        label:'TM'  },
        { name:'pointsAgainst',    label:'PM'  },
        { name:'pointDifferential',label:'ME'  },
        { name:'points',           label:'Pts', cls:'st-pts' },
    ];

    const { rows, thCells, legendHTML } = standingsTableHTML(entries, cols, 'soccer');

    el.innerHTML = `
        <p class="section-info">Kausi 2025‚Äì26</p>
        <div class="match-card" style="padding:0;overflow:hidden;border-radius:16px">
            <div style="overflow-x:auto;-webkit-overflow-scrolling:touch">
                <table class="standings-table">
                    <thead><tr><th>#</th><th style="text-align:left">Joukkue</th>${thCells}</tr></thead>
                    <tbody>${rows}</tbody>
                </table>
            </div>
        </div>
        <div class="standings-legend">${legendHTML}</div>`;
    attachTeamStatsHandlers(el, league);
}

function renderHockeyStandings(el, data, league) {
    const cols = [
        { name:'gamesPlayed', label:'P'   },
        { name:'wins',        label:'V'   },
        { name:'losses',      label:'H'   },
        { name:'otLosses',    label:'OT'  },
        { name:'points',      label:'Pts', cls:'st-pts' },
        { name:'pointsFor',   label:'TM'  },
        { name:'pointsAgainst',label:'PM' },
    ];

    const thCells = cols.map(c => `<th>${c.label}</th>`).join('');
    let html = '<p class="section-info">Kausi 2025‚Äì26</p>';

    // Iterate conferences / divisions
    const conferences = data.children || [];

    for (const conf of conferences) {
        const confName = conf.name || conf.abbreviation || '';
        html += `<div class="matchday-header" style="margin-top:20px">${confName}</div>`;

        const divisions = conf.children || [conf];

        for (const div of divisions) {
            const divName = div.name || div.abbreviation || '';
            const entries = div.standings?.entries || [];

            if (!entries.length) continue;
            if (div !== conf) {
                html += `<div style="font-size:0.72em;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin:14px 0 6px;padding-left:4px">${divName}</div>`;
            }

            const { rows } = standingsTableHTML(entries, cols, 'hockey');

            html += `<div class="match-card" style="padding:0;overflow:hidden;margin-bottom:12px">
                <div style="overflow-x:auto;-webkit-overflow-scrolling:touch">
                    <table class="standings-table">
                        <thead><tr><th>#</th><th style="text-align:left">Joukkue</th>${thCells}</tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
            </div>`;
        }
    }

    el.innerHTML = html;
    attachTeamStatsHandlers(el, league);
}

// ‚îÄ‚îÄ Day view ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function updateDayLabel(date) {
    const today = new Date(); today.setHours(0,0,0,0);
    const diff = Math.round((date - today) / 864e5);
    const el = document.getElementById('day-label');
    if (!el) return;
    if (diff === 0) {
        el.textContent = 'T√§n√§√§n';
    } else if (diff === -1) {
        el.textContent = 'Eilen';
    } else if (diff === 1) {
        el.textContent = 'Huomenna';
    } else {
        el.textContent = date.toLocaleDateString('fi-FI', {
            weekday:'long', day:'numeric', month:'long'
        });
    }
    updateNavArrows();
}

function getMaxDate() {
    const t = new Date(); t.setHours(0,0,0,0);
    // Last day of the month 3 months from now
    return new Date(t.getFullYear(), t.getMonth() + 4, 0);
}

function changeDay(delta) {
    const next = new Date(currentDayDate);
    next.setDate(next.getDate() + delta);
    if (delta > 0 && next > getMaxDate()) return;
    currentDayDate = next;
    updateNavArrows();
    loadDayView(currentDayDate);
}

function updateNavArrows() {
    const rightBtn = document.querySelector('#date-nav .date-nav-btn:last-of-type');
    if (rightBtn) rightBtn.disabled = currentDayDate >= getMaxDate();
}

function goToToday() {
    currentDayDate = new Date(); currentDayDate.setHours(0,0,0,0);
    closeDatePicker();
    updateNavArrows();
    loadDayView(currentDayDate);
}

// ‚îÄ‚îÄ Date picker ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _dpView = new Date();

function toggleDatePicker() {
    const popup = document.getElementById('date-picker-popup');
    const btn   = popup.previousElementSibling;
    if (popup.classList.contains('open')) {
        popup.classList.remove('open');
        btn.classList.remove('active');
    } else {
        _dpView = new Date(currentDayDate);
        renderDatePicker();
        popup.classList.add('open');
        btn.classList.add('active');
    }
}

function closeDatePicker() {
    const popup = document.getElementById('date-picker-popup');
    if (!popup) return;
    popup.classList.remove('open');
    const btn = popup.previousElementSibling;
    if (btn) btn.classList.remove('active');
}

function dpChangeMonth(delta) {
    _dpView.setDate(1);
    _dpView.setMonth(_dpView.getMonth() + delta);
    renderDatePicker();
}

function pickDate(y, m, d) {
    const picked = new Date(y, m, d);
    if (picked > getMaxDate()) return;
    currentDayDate = picked;
    // Keep _dpView in sync with the picked month
    _dpView = new Date(y, m, 1);
    closeDatePicker();
    updateNavArrows();
    loadDayView(currentDayDate);
}

function renderDatePicker() {
    const popup  = document.getElementById('date-picker-popup');
    const year   = _dpView.getFullYear();
    const month  = _dpView.getMonth();
    const today  = new Date(); today.setHours(0,0,0,0);
    const sel    = new Date(currentDayDate);
    const maxD   = getMaxDate();

    // Is this the max allowed month?
    const maxYear = maxD.getFullYear(), maxMonth = maxD.getMonth();
    const atMaxMonth = year > maxYear || (year === maxYear && month >= maxMonth);
    // Is this the earliest we'd want to allow going back (say 1 year)?
    const minD = new Date(today.getFullYear() - 1, today.getMonth(), 1);
    const atMinMonth = year <= minD.getFullYear() && month <= minD.getMonth();

    const monthLabel = new Date(year, month, 1).toLocaleDateString('fi-FI', {
        month: 'long', year: 'numeric'
    });

    // Monday-first weekday offset
    let startDow = new Date(year, month, 1).getDay();
    startDow = (startDow + 6) % 7; // Mon=0

    const daysInMonth   = new Date(year, month + 1, 0).getDate();
    const prevMonthDays = new Date(year, month, 0).getDate();
    const prevMonth     = month === 0 ? 11 : month - 1;
    const prevYear      = month === 0 ? year - 1 : year;
    const nextMonth     = month === 11 ? 0 : month + 1;
    const nextYear      = month === 11 ? year + 1 : year;

    const WDAYS = ['Ma','Ti','Ke','To','Pe','La','Su'];
    let grid = WDAYS.map(w => `<div class="dp-weekday">${w}</div>`).join('');

    // Leading days from prev month ‚Äî clickable
    for (let i = startDow - 1; i >= 0; i--) {
        const d = prevMonthDays - i;
        grid += `<button class="dp-day dp-other" onclick="pickDate(${prevYear},${prevMonth},${d})">${d}</button>`;
    }

    // Current month days
    for (let d = 1; d <= daysInMonth; d++) {
        const dt = new Date(year, month, d);
        let cls = 'dp-day';
        if (dt > maxD) { cls += ' dp-disabled'; }
        else {
            if (dt.getTime() === today.getTime()) cls += ' dp-today';
            if (dt.getTime() === sel.getTime())   cls += ' dp-selected';
        }
        grid += `<button class="${cls}" onclick="pickDate(${year},${month},${d})">${d}</button>`;
    }

    // Trailing days from next month ‚Äî clickable if within limit
    const total = startDow + daysInMonth;
    const trailing = total % 7 === 0 ? 0 : 7 - (total % 7);
    for (let d = 1; d <= trailing; d++) {
        const dt = new Date(nextYear, nextMonth, d);
        if (dt > maxD) {
            grid += `<div class="dp-day dp-other dp-disabled">${d}</div>`;
        } else {
            grid += `<button class="dp-day dp-other" onclick="pickDate(${nextYear},${nextMonth},${d})">${d}</button>`;
        }
    }

    popup.innerHTML = `
        <div class="dp-header">
            <button class="dp-nav-btn" ${atMinMonth ? 'disabled' : ''} onclick="dpChangeMonth(-1)">&#8592;</button>
            <span class="dp-month-label">${monthLabel}</span>
            <button class="dp-nav-btn" ${atMaxMonth ? 'disabled' : ''} onclick="dpChangeMonth(1)">&#8594;</button>
        </div>
        <div class="dp-grid">${grid}</div>`;
}

// Close picker on outside click
// composedPath() captures the event path at dispatch time, before any innerHTML replacement
document.addEventListener('click', e => {
    const wrap = document.querySelector('.date-picker-wrap');
    if (!wrap) return;
    const path = e.composedPath ? e.composedPath() : [e.target];
    if (!path.includes(wrap)) closeDatePicker();
});

async function fetchDayEvents(league, date) {
    if (league.isLiiga) {
        const season = liigaCurrentSeason();
        const games  = await fetchLiigaGames(season);
        const dayStr = toESPNDate(date); // yyyymmdd
        const dayMatches = games.filter(g => {
            if (!g.homeTeam.teamName) return false;
            const gDate = new Date(g.start);
            return toESPNDate(gDate) === dayStr;
        });
        return dayMatches.map(liigaToESPN).filter(Boolean);
    }
    // ESPN tallentaa pelit US-aikavy√∂hykkeen mukaan. Suomen ajassa illalla/y√∂ll√§
    // pelatut ottelut (esim. klo 02:00 Suomea = klo 19:00 ET edellisen√§ p√§iv√§n√§)
    // l√∂ytyv√§t ESPN:st√§ edellisen p√§iv√§n hakutuloksista. Haetaan siksi molemmat
    // p√§iv√§t ja filtter√∂id√§√§n Suomen paikallisen ajan mukaan.
    const prevDate = new Date(date);
    prevDate.setDate(prevDate.getDate() - 1);
    const [prevEvents, todayEvents] = await Promise.all([
        fetchMatches(league, prevDate, prevDate),
        fetchMatches(league, date, date)
    ]);
    const allEvents = [...prevEvents, ...todayEvents];
    const dayStr = toESPNDate(date);
    const seen = new Set();
    return allEvents.filter(ev => {
        if (seen.has(ev.id)) return false;
        seen.add(ev.id);
        // K√§ytet√§√§n paikallista aikaa (Suomi UTC+2) p√§iv√§m√§√§r√§n vertailuun
        return toESPNDate(new Date(ev.date)) === dayStr;
    });
}

async function loadDayView(date) {
    updateDayLabel(date);

    const el = document.getElementById('day-content');
    el.innerHTML = '<div class="loading"><div class="spinner"></div>Ladataan...</div>';

    const leagueOrder = Object.values(LEAGUES);
    const results = await Promise.allSettled(
        leagueOrder.map(lg => fetchDayEvents(lg, date))
    );

    el.innerHTML = '';

    let anyEvents = false;

    for (let i = 0; i < leagueOrder.length; i++) {
        const league = leagueOrder[i];
        const result = results[i];
        if (result.status !== 'fulfilled') continue;
        const events = result.value;
        if (!events.length) continue;

        anyEvents = true;

        const section = document.createElement('div');
        section.className = 'league-section';

        const header = document.createElement('div');
        header.className = 'league-section-header';
        if (league.logo) {
            const img = document.createElement('img');
            img.src = league.logo;
            img.alt = league.name;
            img.onerror = () => { img.style.display = 'none'; };
            header.appendChild(img);
        }
        header.appendChild(document.createTextNode(league.name));
        section.appendChild(header);

        const sortedEvents = events.slice().sort((a, b) => new Date(a.date) - new Date(b.date));
        for (const ev of sortedEvents) {
            section.appendChild(createCard(ev, league));
        }

        el.appendChild(section);
    }

    if (!anyEvents) {
        el.innerHTML = '<div class="no-events">Ei otteluita valitulla p√§iv√§ll√§.</div>';
    }
}

// ‚îÄ‚îÄ Player stats ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function playerStatsUrl(league) {
    if (league.sport === 'hockey' && !league.isLiiga)
        return `https://site.api.espn.com/apis/site/v2/sports/hockey/${league.id}/statistics`;
    return `https://site.api.espn.com/apis/site/v2/sports/soccer/${league.id}/statistics`;
}

function getStat(athlete, name) {
    const s = (athlete.statistics || []).find(s => s.name === name);
    return s ? Number(s.value) : 0;
}

let _psExpandId = 0;

function buildPlayerTable(leaders, mainStat, mainLabel, limit = 10, gpLabel = 'P') {
    const all     = leaders.slice(0, 50);
    const initial = all.slice(0, limit);
    const extra   = all.slice(limit);
    const uid     = 'pst' + (++_psExpandId);

    const makeRow = (l, i) => {
        const a    = l.athlete;
        const team = l.team?.displayName || a.team?.displayName || '';
        const gp   = l.gp ?? getStat(a, 'appearances');
        const val  = l.val ?? getStat(a, mainStat);
        return `<tr>
            <td class="st-rank">${i + 1}</td>
            <td style="text-align:left">
                <span class="ps-player">${a.displayName}</span>
                <span class="ps-team">${team}</span>
            </td>
            <td class="ps-apps">${gp}</td>
            <td class="ps-val">${val}</td>
        </tr>`;
    };

    const extraHTML = extra.length ? `
        <tbody id="${uid}-extra" style="display:none">
            ${extra.map((l, i) => makeRow(l, limit + i)).join('')}
        </tbody>
        <tfoot>
            <tr><td colspan="4" style="text-align:center;padding:8px 0">
                <button class="view-toggle-btn" style="font-size:0.78em;padding:5px 18px"
                    onclick="
                        document.getElementById('${uid}-extra').style.display='';
                        this.closest('tfoot').style.display='none';
                    ">N√§yt√§ enemm√§n (top ${all.length})</button>
            </td></tr>
        </tfoot>` : '';

    return `<div class="match-card" style="padding:0;overflow:hidden;border-radius:16px">
        <div style="overflow-x:auto;-webkit-overflow-scrolling:touch">
            <table class="standings-table">
                <thead><tr>
                    <th>#</th>
                    <th style="text-align:left">Pelaaja</th>
                    <th title="Ottelut pelattu">${gpLabel}</th>
                    <th>${mainLabel}</th>
                </tr></thead>
                <tbody>${initial.map(makeRow).join('')}</tbody>
                ${extraHTML}
            </table>
        </div>
    </div>`;
}

// ‚îÄ‚îÄ NHL player stats (core ESPN API with parallel athlete/team resolution) ‚îÄ‚îÄ
async function loadNHLPlayerStats(el) {
    const season  = liigaCurrentSeason();
    const base    = `https://sports.core.api.espn.com/v2/sports/hockey/leagues/nhl`;
    const fetchJ  = url => fetch(url).then(r => r.ok ? r.json() : null).catch(() => null);
    const refId   = ref => ref?.match(/\/(\d+)(?:\?|$)/)?.[1];

    const leadersRes = await fetch(`${base}/seasons/${season}/types/2/leaders`);
    if (!leadersRes.ok) throw new Error(`HTTP ${leadersRes.status}`);
    const leaderData = await leadersRes.json();
    const cats = leaderData.categories || [];

    const findCat = name => cats.find(c => c.name === name);
    const goalsCat   = findCat('goals');
    const assistsCat = findCat('assists');
    const pointsCat  = findCat('points');

    // Collect unique athlete and team refs
    const athleteMap = new Map(); // id ‚Üí ref url
    const teamMap    = new Map();
    for (const cat of [goalsCat, assistsCat, pointsCat]) {
        for (const l of (cat?.leaders || [])) {
            const aId = refId(l.athlete?.$ref);
            const tId = refId(l.team?.$ref);
            if (aId && !athleteMap.has(aId)) athleteMap.set(aId, l.athlete.$ref);
            if (tId && !teamMap.has(tId))    teamMap.set(tId, l.team.$ref);
        }
    }

    // Resolve athletes and teams in parallel
    const [athleteResults, teamResults] = await Promise.all([
        Promise.all([...athleteMap.values()].map(fetchJ)),
        Promise.all([...teamMap.values()].map(fetchJ)),
    ]);

    const athletes = {}, teams = {};
    for (const a of athleteResults) if (a?.id) athletes[String(a.id)] = a.displayName || a.fullName || '?';
    for (const t of teamResults)    if (t?.id) teams[String(t.id)]    = t.shortDisplayName || t.displayName || '';

    const toLeader = l => ({
        athlete: { displayName: athletes[refId(l.athlete?.$ref)] || '?', id: refId(l.athlete?.$ref) },
        team:    { displayName: teams[refId(l.team?.$ref)] || '' },
        gp:      '‚Äì',
        val:     Math.round(l.value ?? 0),
    });

    const points  = (pointsCat?.leaders  || []).map(toLeader);
    const goals   = (goalsCat?.leaders   || []).map(toLeader);
    const assists = (assistsCat?.leaders || []).map(toLeader);

    el.innerHTML = `
        <p class="section-info">Kauden parhaat pelaajat ${season - 1}‚Äì${String(season).slice(2)}</p>
        <div class="ps-section">
            <div class="ps-section-title">üèí Pistep√∂rssi</div>
            ${buildPlayerTable(points, 'val', 'P', 10, 'O')}
        </div>
        <div class="ps-section">
            <div class="ps-section-title">üéØ Maalip√∂rssi</div>
            ${buildPlayerTable(goals, 'val', 'M', 10, 'O')}
        </div>
        <div class="ps-section">
            <div class="ps-section-title">üçé Sy√∂tt√∂p√∂rssi</div>
            ${buildPlayerTable(assists, 'val', 'S', 10, 'O')}
        </div>`;
}

// ‚îÄ‚îÄ Liiga player stats (computed from game data) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderLiigaPlayerStats(el, games) {
    const isDisallowed = ge => (ge.goalTypes || []).includes('RL0');
    const toName = s => s ? s.split('-').map(p => p.charAt(0) + p.slice(1).toLowerCase()).join('-') : '';

    const players = {}; // playerId ‚Üí {name, team, goals, assists, gp_set}
    const gamesByPlayer = {}; // playerId ‚Üí Set of gameIds

    for (const game of games) {
        if (!game.ended) continue;
        for (const side of [
            { events: game.homeTeam.goalEvents, teamName: game.homeTeam.teamName },
            { events: game.awayTeam.goalEvents, teamName: game.awayTeam.teamName },
        ]) {
            for (const ge of (side.events || [])) {
                if (isDisallowed(ge)) continue;

                const scorer = ge.scorerPlayer;
                if (scorer) {
                    const id = scorer.playerId;
                    if (!players[id]) players[id] = {
                        name: `${toName(scorer.firstName)} ${toName(scorer.lastName)}`.trim(),
                        team: side.teamName, goals: 0, assists: 0
                    };
                    players[id].goals++;
                    if (!gamesByPlayer[id]) gamesByPlayer[id] = new Set();
                    gamesByPlayer[id].add(game.id);
                }

                for (const ast of (ge.assistantPlayers || [])) {
                    const id = ast.playerId;
                    if (!players[id]) players[id] = {
                        name: `${toName(ast.firstName)} ${toName(ast.lastName)}`.trim(),
                        team: side.teamName, goals: 0, assists: 0
                    };
                    players[id].assists++;
                    if (!gamesByPlayer[id]) gamesByPlayer[id] = new Set();
                    gamesByPlayer[id].add(game.id);
                }
            }
        }
    }

    const toLeaders = list => list.map(([id, p]) => ({
        athlete: { displayName: p.name, id },
        team:    { displayName: p.team },
        gp:      gamesByPlayer[id]?.size || 0,
        val:     p._sortVal,
    }));

    const byPoints = Object.entries(players)
        .map(([id, p]) => [id, { ...p, _sortVal: p.goals + p.assists }])
        .sort((a, b) => b[1]._sortVal - a[1]._sortVal || b[1].goals - a[1].goals)
        .slice(0, 50);

    const byGoals = Object.entries(players)
        .map(([id, p]) => [id, { ...p, _sortVal: p.goals }])
        .sort((a, b) => b[1]._sortVal - a[1]._sortVal)
        .slice(0, 50);

    const season = liigaCurrentSeason();
    el.innerHTML = `
        <p class="section-info">Runkosarja ${season - 1}‚Äì${String(season).slice(2)} ‚Äî laskettu maalitiedoista</p>
        <div class="ps-section">
            <div class="ps-section-title">üèí Pistep√∂rssi</div>
            ${buildPlayerTable(toLeaders(byPoints), 'val', 'P', 10, 'O')}
        </div>
        <div class="ps-section">
            <div class="ps-section-title">üéØ Maalip√∂rssi</div>
            ${buildPlayerTable(toLeaders(byGoals), 'val', 'M', 10, 'O')}
        </div>`;
}

function renderPlayerStats(el, data) {
    const goalsCat   = data.stats?.find(s => s.name === 'goalsLeaders');
    const assistsCat = data.stats?.find(s => s.name === 'assistsLeaders');

    if (!goalsCat && !assistsCat) {
        el.innerHTML = '<div class="error-msg">Tilastoja ei saatavilla</div>';
        return;
    }

    // Build G+A leaders by merging both lists
    const seen = new Map();
    for (const l of [...(goalsCat?.leaders || []), ...(assistsCat?.leaders || [])]) {
        if (!seen.has(l.athlete.id)) seen.set(l.athlete.id, l);
    }
    const gaLeaders = [...seen.values()].sort((a, b) => {
        const gaA = getStat(a.athlete, 'totalGoals') + getStat(a.athlete, 'goalAssists');
        const gaB = getStat(b.athlete, 'totalGoals') + getStat(b.athlete, 'goalAssists');
        return gaB - gaA || getStat(b.athlete, 'totalGoals') - getStat(a.athlete, 'totalGoals');
    }).map(l => ({
        athlete: {
            ...l.athlete,
            statistics: [
                ...(l.athlete.statistics || []),
                { name: 'ga', value: getStat(l.athlete, 'totalGoals') + getStat(l.athlete, 'goalAssists') },
            ]
        }
    }));

    el.innerHTML = `
        <p class="section-info">Kauden parhaat pelaajat</p>
        <div class="ps-section">
            <div class="ps-section-title">‚öΩ Maalip√∂rssi</div>
            ${buildPlayerTable(goalsCat?.leaders || [], 'totalGoals', 'M')}
        </div>
        <div class="ps-section">
            <div class="ps-section-title">üéØ Sy√∂tt√∂p√∂rssi</div>
            ${buildPlayerTable(assistsCat?.leaders || [], 'goalAssists', 'S')}
        </div>
        <div class="ps-section">
            <div class="ps-section-title">üìä Pistep√∂rssi (M+S)</div>
            ${buildPlayerTable(gaLeaders, 'ga', 'M+S')}
        </div>`;
}

async function loadPlayerStats(league) {
    const el = document.getElementById('playerstats-body');
    el.innerHTML = '<div class="loading"><div class="spinner"></div>Ladataan...</div>';
    try {
        if (league.isLiiga) {
            const season = liigaCurrentSeason();
            const games  = await fetchLiigaGames(season);
            renderLiigaPlayerStats(el, games);
        } else if (league.sport === 'hockey') {
            await loadNHLPlayerStats(el);
        } else {
            const res = await fetch(playerStatsUrl(league));
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            renderPlayerStats(el, await res.json());
        }
    } catch (err) {
        el.innerHTML = `<div class="error-msg">Virhe tilastojen lataamisessa: ${err.message}</div>`;
    }
}

// ‚îÄ‚îÄ Liiga API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function liigaCurrentSeason() {
    const now = new Date();
    // Season labeled by year it ends; new season starts in August
    return now.getMonth() >= 7 ? now.getFullYear() + 1 : now.getFullYear();
}

const liigaGamesCache = {}; // season ‚Üí { data: [], ts: timestamp }
const liigaGameById   = {}; // gameId ‚Üí raw game object

async function fetchLiigaGames(season, force) {
    const cached = liigaGamesCache[season];
    if (cached && !force && (Date.now() - cached.ts < 55000)) return cached.data;
    const res = await fetch(`https://www.liiga.fi/api/v2/games?season=${season}&gameType=runkosarja`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    liigaGamesCache[season] = { data, ts: Date.now() };
    for (const g of data) liigaGameById[String(g.id)] = g;
    return data;
}

const LIIGA_GOAL_TYPE = { YV:'YV', AV:'AV', VL:'VL', RL:'RL' };

function liigaToESPN(game) {
    const home = game.homeTeam;
    const away = game.awayTeam;
    if (!home.teamName || !away.teamName) return null;

    let state, shortDetail, displayClock;
    if (game.ended) {
        state = 'post';
        const ft = game.finishedType;
        shortDetail = ft === 'ENDED_DURING_OVERTIME' ? 'JA'
                    : ft === 'ENDED_DURING_SHOOTOUT'  ? 'VL'
                    : 'Lopputulos';
        displayClock = '';
    } else if (game.started) {
        state = 'in';
        shortDetail = `${game.currentPeriod}. er√§`;
        displayClock = `${game.currentPeriod}. er√§`;
    } else {
        state = 'pre';
        shortDetail = '';
        displayClock = '';
    }

    return {
        id: String(game.id),
        date: game.start,
        competitions: [{
            competitors: [
                { homeAway:'home', team:{ id: home.teamId, displayName: home.teamName,
                    shortDisplayName: home.teamName, logo: home.logos?.darkBg || '' },
                  score: String(home.goals ?? 0) },
                { homeAway:'away', team:{ id: away.teamId, displayName: away.teamName,
                    shortDisplayName: away.teamName, logo: away.logos?.darkBg || '' },
                  score: String(away.goals ?? 0) }
            ],
            status: { type: { state, shortDetail, detail: shortDetail, displayClock } },
            venue: game.iceRink ? { fullName: game.iceRink.name } : null
        }]
    };
}

async function loadLiigaMatchStats(panel, gameId) {
    const content = panel.querySelector('.stats-content');
    content.innerHTML = '<div class="spinner-sm"></div>';
    try {
        const game = liigaGameById[String(gameId)];
        if (!game) throw new Error('Pelin tietoja ei l√∂ydy');

        const toName = s => s ? s.split('-').map(p => p.charAt(0) + p.slice(1).toLowerCase()).join('-') : '';
        const fmtPlayer = p => p ? `${toName(p.firstName)} ${toName(p.lastName)}` : '?';

        const isDisallowed = ge => (ge.goalTypes || []).includes('RL0');

        const allGoals = [];
        for (const ge of (game.homeTeam.goalEvents || [])) if (!isDisallowed(ge)) allGoals.push({ ...ge, isHome: true });
        for (const ge of (game.awayTeam.goalEvents || [])) if (!isDisallowed(ge)) allGoals.push({ ...ge, isHome: false });
        allGoals.sort((a, b) => (a.period - b.period) || (a.gameTime - b.gameTime));

        let tlHTML = '<div class="timeline">';
        let curPeriod = null;
        for (const ge of allGoals) {
            if (ge.period !== curPeriod) {
                curPeriod = ge.period;
                const lbl = ge.period <= 3 ? `${ge.period}. er√§` : 'Jatkoaika / VL';
                tlHTML += `<div class="tl-period"><span class="tl-period-label">${lbl}</span></div>`;
            }
            const mins    = Math.floor(ge.gameTime / 60);
            const secs    = String(ge.gameTime % 60).padStart(2, '0');
            const timeStr = `${mins}:${secs}`;
            const types   = (ge.goalTypes || []).join(', ');
            if (!ge.scorerPlayer) continue;
            const scorer  = `${fmtPlayer(ge.scorerPlayer)}${types ? ' (' + types + ')' : ''}`;
            const assists = (ge.assistantPlayers || []).map(fmtPlayer).join(', ');
            const hDisp   = ge.isHome  ? `<b>${ge.homeTeamScore}</b>` : ge.homeTeamScore;
            const aDisp   = !ge.isHome ? `<b>${ge.awayTeamScore}</b>` : ge.awayTeamScore;
            const chip    = `<span class="tl-score-chip">${hDisp}‚Äì${aDisp}</span>`;
            const bodyHTML = `<div class="tl-event-body">
                <div class="tl-player">${scorer}</div>
                ${assists ? `<div class="tl-assist">‚Ü≥ ${assists}</div>` : ''}
                <div class="tl-min">${timeStr}</div>
            </div>`;
            if (ge.isHome) {
                tlHTML += `<div class="tl-event">
                    <div class="tl-home-col"><div class="tl-marker">${chip}</div>${bodyHTML}</div>
                    <div class="tl-away-col"></div>
                </div>`;
            } else {
                tlHTML += `<div class="tl-event">
                    <div class="tl-home-col"></div>
                    <div class="tl-away-col">${bodyHTML}<div class="tl-marker">${chip}</div></div>
                </div>`;
            }
        }
        if (!allGoals.length) tlHTML += '<div class="no-events">Ei maaleja kirjattu</div>';
        tlHTML += '</div>';

        content.innerHTML = `<div class="details-section">
            <div class="details-title">üèí Maalit</div>${tlHTML}</div>`;
        panel.dataset.loaded = '1';
    } catch (err) {
        content.innerHTML = `<div class="details-error">Virhe: ${err.message}</div>`;
    }
}

async function loadLiigaStandings(league) {
    const el = document.getElementById('standings-body');
    try {
        const season = liigaCurrentSeason();
        const url    = `${FPL_PROXY}${encodeURIComponent(`https://www.liiga.fi/api/v2/standings?season=${season}&gameType=runkosarja`)}`;
        const res    = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data   = await res.json();
        const teams  = (data.season || []).slice().sort((a, b) => a.ranking - b.ranking);

        let rows = '';
        for (const t of teams) {
            const logo    = t.teamLogos?.darkBg || '';
            const otWins  = t.overtimeWins  || 0;
            const otLosses= t.overtimeLosses|| 0;
            const regWins = (t.wins   || 0) - otWins;
            const regLoss = (t.losses || 0) - otLosses;
            const gd      = (t.goals || 0) - (t.goalsAgainst || 0);
            const gdStr   = gd >= 0 ? '+' + gd : String(gd);
            const gdColor = gd > 0 ? '#0369a1' : gd < 0 ? '#dc2626' : '';
            rows += `<tr class="st-row" data-team-id="${t.teamId}" data-team-name="${t.teamName}" data-team-logo="${logo}">
                <td class="st-rank">${t.ranking}</td>
                <td><div class="st-team">
                    <img src="${logo}" alt="${t.teamName}" onerror="this.style.visibility='hidden'">
                    <span>${t.teamName}</span>
                </div></td>
                <td>${t.games}</td><td>${regWins}</td><td>${otWins}</td>
                <td>${otLosses}</td><td>${regLoss}</td>
                <td class="st-gd" style="color:${gdColor}">${gdStr}</td>
                <td class="st-pts">${t.points}</td>
            </tr>`;
        }
        const sy = season - 1, ey = String(season).slice(2);
        el.innerHTML = `<p class="section-info">Runkosarja ${sy}‚Äì${ey}</p>
            <div class="match-card" style="padding:0;overflow:hidden;border-radius:16px">
                <div style="overflow-x:auto;-webkit-overflow-scrolling:touch">
                    <table class="standings-table">
                        <thead><tr><th>#</th><th style="text-align:left">Joukkue</th>
                        <th>P</th><th title="Voitot">V</th><th title="Jatkoaikavoitot">JV</th>
                        <th title="Jatkoaikah√§vi√∂t">JH</th><th title="H√§vi√∂t">H</th>
                        <th>ME</th><th class="st-pts">Pts</th></tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
            </div>`;
    } catch (err) {
        el.innerHTML = `<div class="error-msg">Virhe sarjataulukon lataamisessa: ${err.message}</div>`;
    }
}

// ‚îÄ‚îÄ Ipan ja ManU:n pelit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const MAN_UNITED_ESPN_ID = '360';
let ipaManUView   = 'upcoming'; // 'upcoming' | 'past'
let ipaManUFilter = 'both';     // 'both' | 'manu' | 'ilves'

function switchIpaView(view) {
    ipaManUView = view;
    document.getElementById('ipa-upcoming-btn').classList.toggle('active', view === 'upcoming');
    document.getElementById('ipa-past-btn').classList.toggle('active', view === 'past');
    loadIpaManUTab();
}

function switchIpaFilter(filter) {
    ipaManUFilter = filter;
    document.getElementById('ipa-filter-both').classList.toggle('active',  filter === 'both');
    document.getElementById('ipa-filter-manu').classList.toggle('active',  filter === 'manu');
    document.getElementById('ipa-filter-ilves').classList.toggle('active', filter === 'ilves');
    loadIpaManUTab();
}

async function loadIpaManUTab() {
    const el = document.getElementById('ipa-manu-body');
    el.innerHTML = '<div class="loading"><div class="spinner"></div>Ladataan...</div>';

    try {
        const upcoming = ipaManUView === 'upcoming';
        const [muEvents, ilvesEvents] = await Promise.all([
            fetchManUSchedule(upcoming),
            fetchIlvesSchedule(upcoming),
        ]);

        // Tag each event with its league so renderMixedMatches can use the right createCard
        muEvents.forEach(e => e._league = LEAGUES.pl);
        ilvesEvents.forEach(e => e._league = LEAGUES.liiga);

        const showMU    = ipaManUFilter !== 'ilves';
        const showIlves = ipaManUFilter !== 'manu';
        const all = [
            ...(showMU    ? muEvents    : []),
            ...(showIlves ? ilvesEvents : []),
        ].sort((a, b) =>
            upcoming
                ? new Date(a.date) - new Date(b.date)
                : new Date(b.date) - new Date(a.date)
        );

        el.innerHTML = '';

        if (!all.length) {
            el.innerHTML = '<div class="no-events">Ei otteluita.</div>';
            return;
        }

        renderMixedMatchesByDay(el, all, upcoming);

    } catch (err) {
        el.innerHTML = `<div class="error-msg">Virhe: ${err.message}</div>`;
    }
}

function normScore(score) {
    if (typeof score === 'string') return score;
    if (score && score.displayValue !== undefined) return score.displayValue;
    if (score && score.value !== undefined) return String(score.value);
    return '0';
}

async function fetchManUSchedule(upcoming) {
    let events;

    if (upcoming) {
        // Scoreboard API: today ‚Üí end of season, filter for Man United
        const from = new Date();
        from.setHours(0, 0, 0, 0);
        const to = new Date(2026, 4, 31); // May 31 2026
        const url = `https://site.api.espn.com/apis/site/v2/sports/soccer/eng.1/scoreboard?dates=${toESPNDate(from)}-${toESPNDate(to)}&limit=200`;
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        events = (data.events || []).filter(e =>
            (e.competitions?.[0]?.competitors || []).some(
                c => c.team?.displayName === 'Manchester United'
            )
        ).filter(e => {
            const s = e.competitions?.[0]?.status?.type?.state;
            return s === 'pre' || s === 'in';
        }).sort((a, b) => new Date(a.date) - new Date(b.date));
    } else {
        // Team schedule API: returns this season's completed matches
        const res = await fetch(
            `https://site.api.espn.com/apis/site/v2/sports/soccer/eng.1/teams/${MAN_UNITED_ESPN_ID}/schedule`
        );
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        events = (data.events || [])
            .filter(e => e.competitions?.[0]?.status?.type?.state === 'post')
            .map(ev => {
                const comp = ev.competitions?.[0];
                if (comp) {
                    comp.competitors = (comp.competitors || []).map(c => ({
                        ...c,
                        score: normScore(c.score),
                        team: {
                            ...c.team,
                            logo: c.team?.logos?.[0]?.href || '',
                        },
                    }));
                }
                return ev;
            })
            .sort((a, b) => new Date(b.date) - new Date(a.date));
    }

    return events;
}

async function fetchIlvesSchedule(upcoming) {
    const season = liigaCurrentSeason();
    const games  = await fetchLiigaGames(season);

    const filtered = games.filter(g => {
        if (!g.homeTeam.teamName || !g.awayTeam.teamName) return false;
        const isIlves =
            (g.homeTeam.teamName || '').toLowerCase().includes('ilves') ||
            (g.awayTeam.teamName || '').toLowerCase().includes('ilves');
        if (!isIlves) return false;
        return upcoming ? !g.ended : g.ended;
    });

    const events = filtered.map(liigaToESPN).filter(Boolean);
    return upcoming
        ? events.sort((a, b) => new Date(a.date) - new Date(b.date))
        : events.sort((a, b) => new Date(b.date) - new Date(a.date));
}

function renderMixedMatchesByDay(container, events, upcoming) {
    // Group by day
    const byDay = new Map();
    for (const ev of events) {
        const day = ev.date.slice(0, 10);
        if (!byDay.has(day)) byDay.set(day, []);
        byDay.get(day).push(ev);
    }
    const days = [...byDay.keys()].sort((a, b) =>
        upcoming ? a.localeCompare(b) : b.localeCompare(a));

    // Group days by month
    const byMonth = new Map();
    for (const day of days) {
        const month = day.slice(0, 7); // "2026-03"
        if (!byMonth.has(month)) byMonth.set(month, []);
        byMonth.get(month).push(day);
    }

    for (const [month, monthDays] of byMonth) {
        // Month header
        const monthHdr = document.createElement('div');
        monthHdr.className = 'ipa-month-header';
        const [y, m] = month.split('-');
        monthHdr.textContent = new Date(Number(y), Number(m) - 1, 1)
            .toLocaleDateString('fi-FI', { month: 'long', year: 'numeric' });
        container.appendChild(monthHdr);

        // Days within month
        for (const day of monthDays) {
            const dt = new Date(day + 'T12:00:00');
            const dayLbl = document.createElement('div');
            dayLbl.className = 'ipa-day-label';
            dayLbl.textContent = dt.toLocaleDateString('fi-FI', {
                weekday: 'short', day: 'numeric', month: 'numeric',
            });
            container.appendChild(dayLbl);
            for (const ev of byDay.get(day)) container.appendChild(createCard(ev, ev._league));
        }
    }
}

function renderMatchesIntoEl(container, events, league, upcoming) {
    const groups = new Map();
    for (const ev of events) {
        const day = ev.date.slice(0, 10);
        if (!groups.has(day)) groups.set(day, []);
        groups.get(day).push(ev);
    }
    const days = [...groups.keys()].sort((a, b) =>
        upcoming ? a.localeCompare(b) : b.localeCompare(a));
    for (const day of days) {
        const hdr = document.createElement('div');
        hdr.className = 'matchday-header';
        hdr.textContent = new Date(day + 'T12:00:00').toLocaleDateString('fi-FI', {
            weekday: 'long', day: 'numeric', month: 'long', year: 'numeric',
        });
        container.appendChild(hdr);
        for (const ev of groups.get(day)) container.appendChild(createCard(ev, league));
    }
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
currentTab = 'day';
loadDayView(currentDayDate);
</script>

</body>
</html>
